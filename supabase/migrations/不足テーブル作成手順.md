# 不足テーブル作成手順書

## 概要

001_initial_schema.sqlで定義されている13テーブルのうち、10テーブルしか作成されていない問題を解決します。

## 001_initial_schema.sqlで定義されているテーブル一覧（13個）

1. **users_profile** - ユーザープロフィール
2. **vendors** - 業者マスタ
3. **menus** - メニューマスタ
4. **menu_prices** - メニュー価格
5. **order_days** - 注文可能日カレンダー
6. **order_deadlines** - 日別締切時刻 ⚠️ **不足**
7. **orders** - 注文
8. **closing_periods** - 締日期間
9. **operation_logs** - 操作ログ
10. **auto_order_settings** - 自動注文設定
11. **auto_order_templates** - 自動注文テンプレート ⚠️ **不足**
12. **auto_order_runs** - 自動注文実行履歴
13. **auto_order_run_items** - 自動注文実行アイテム ⚠️ **不足**

## 既存テーブルとの対応関係（推測）

既存の10テーブルと001_initial_schema.sqlのテーブル名が異なる可能性があります：

| 001_initial_schema.sql | 既存テーブル（推測） | 状態 |
|----------------------|-------------------|------|
| users_profile | profiles | ✅ 既存（名前が異なる可能性） |
| vendors | vendors | ✅ 既存 |
| menus | menu_items | ✅ 既存（名前が異なる可能性） |
| menu_prices | menu_prices | ✅ 既存 |
| order_days | order_calendar | ✅ 既存（名前が異なる可能性） |
| order_deadlines | - | ❌ **不足** |
| orders | orders | ✅ 既存 |
| closing_periods | closing_periods | ✅ 既存 |
| operation_logs | audit_logs | ✅ 既存（名前が異なる可能性） |
| auto_order_settings | auto_order_configs | ✅ 既存（名前が異なる可能性） |
| auto_order_templates | - | ❌ **不足** |
| auto_order_runs | auto_order_runs | ✅ 既存 |
| auto_order_run_items | - | ❌ **不足** |

## 実行手順

### ステップ1: 既存テーブルの確認

Supabase SQL Editorで以下を実行：

```sql
-- 003_check_existing_tables.sql の内容を実行
SELECT 
    table_name,
    (SELECT COUNT(*) FROM information_schema.columns WHERE table_schema = 'public' AND table_name = t.table_name) as column_count
FROM information_schema.tables t
WHERE table_schema = 'public'
    AND table_type = 'BASE TABLE'
ORDER BY table_name;
```

**確認ポイント：**
- 既存テーブル名を確認
- 上記の推測が正しいか確認
- 特に `users_profile` vs `profiles`、`menus` vs `menu_items`、`order_days` vs `order_calendar` の違いを確認

### ステップ2: 既存テーブル構造の確認（オプション）

既存テーブルが要件を満たしているか確認：

```sql
-- 各テーブルのカラム情報を確認
SELECT 
    t.table_name,
    c.column_name,
    c.data_type,
    c.is_nullable
FROM information_schema.tables t
JOIN information_schema.columns c ON t.table_name = c.table_name
WHERE t.table_schema = 'public'
    AND t.table_type = 'BASE TABLE'
    AND t.table_name IN ('profiles', 'menu_items', 'order_calendar', 'audit_logs', 'auto_order_configs')
ORDER BY t.table_name, c.ordinal_position;
```

### ステップ3: 不足テーブルの作成

**推奨：`005_create_missing_tables_safe.sql` を使用**

このSQLは既存テーブル名の違いを自動判定して、適切な外部キー制約を設定します。

1. Supabase SQL Editorで `005_create_missing_tables_safe.sql` を開く
2. 内容をすべてコピー＆ペースト
3. 「Run」ボタンをクリック
4. エラーがないことを確認

**作成されるテーブル：**
- `order_deadlines` - 日別締切時刻
- `auto_order_templates` - 自動注文テンプレート
- `auto_order_run_items` - 自動注文実行アイテム

### ステップ4: 実行後の確認

```sql
-- テーブル数の確認（13個になるはず）
SELECT 
    COUNT(*) as table_count
FROM information_schema.tables
WHERE table_schema = 'public'
    AND table_type = 'BASE TABLE';

-- 全テーブル一覧
SELECT 
    table_name
FROM information_schema.tables
WHERE table_schema = 'public'
    AND table_type = 'BASE TABLE'
ORDER BY table_name;

-- 新規作成されたテーブルの確認
SELECT 
    table_name,
    (SELECT COUNT(*) FROM information_schema.columns WHERE table_schema = 'public' AND table_name = t.table_name) as column_count
FROM information_schema.tables t
WHERE table_schema = 'public'
    AND table_type = 'BASE TABLE'
    AND table_name IN ('order_deadlines', 'auto_order_templates', 'auto_order_run_items')
ORDER BY table_name;
```

### ステップ5: 外部キー制約の確認

```sql
-- 新規作成されたテーブルの外部キー制約を確認
SELECT
    tc.table_name,
    kcu.column_name,
    ccu.table_name AS foreign_table_name,
    ccu.column_name AS foreign_column_name
FROM information_schema.table_constraints AS tc
JOIN information_schema.key_column_usage AS kcu
    ON tc.constraint_name = kcu.constraint_name
    AND tc.table_schema = kcu.table_schema
JOIN information_schema.constraint_column_usage AS ccu
    ON ccu.constraint_name = tc.constraint_name
    AND ccu.table_schema = tc.table_schema
WHERE tc.constraint_type = 'FOREIGN KEY'
    AND tc.table_schema = 'public'
    AND tc.table_name IN ('order_deadlines', 'auto_order_templates', 'auto_order_run_items')
ORDER BY tc.table_name;
```

### ステップ6: RLSポリシーの確認

```sql
-- 新規作成されたテーブルのRLSポリシーを確認
SELECT 
    schemaname,
    tablename,
    policyname,
    permissive,
    roles,
    cmd
FROM pg_policies
WHERE schemaname = 'public'
    AND tablename IN ('order_deadlines', 'auto_order_templates', 'auto_order_run_items')
ORDER BY tablename, policyname;
```

## トラブルシューティング

### エラー: "relation already exists"

- テーブルが既に存在している場合
- 対処: `CREATE TABLE IF NOT EXISTS` を使用しているため、このエラーは発生しないはずです
- もし発生した場合は、既存テーブルを確認してください

### エラー: "foreign key constraint violation"

- 外部キー制約の参照先テーブルが存在しない場合
- 対処: 既存テーブル名の確認（ステップ1を再実行）

### エラー: "permission denied"

- RLSポリシーが原因の場合
- 対処: 管理者権限で実行しているか確認

### 外部キー制約が正しく設定されていない

- 既存テーブル名が想定と異なる場合
- 対処: ステップ1で確認した既存テーブル名に基づいて、手動で外部キー制約を追加

```sql
-- 例: order_deadlines の外部キー制約を手動で追加
-- （既存テーブル名が order_calendar の場合）
ALTER TABLE order_deadlines 
ADD CONSTRAINT order_deadlines_date_fkey 
FOREIGN KEY (date) REFERENCES order_calendar(date) ON DELETE CASCADE;
```

## 注意事項

1. **本番環境での実行**
   - 必ずバックアップを取得してから実行してください
   - テスト環境で先に実行して動作確認してください

2. **既存データへの影響**
   - 新規テーブルの作成のみなので、既存データには影響しません
   - ただし、外部キー制約の追加時に既存データが制約を満たさない場合はエラーになります

3. **RLSポリシー**
   - 新規テーブルにはRLSが有効化されています
   - 既存のRLSポリシーと整合性を確認してください

## 次のステップ

不足テーブルの作成が完了したら：

1. 全13テーブルが作成されていることを確認
2. 外部キー制約が正しく設定されていることを確認
3. RLSポリシーが正しく設定されていることを確認
4. STEP2（Next.js プロジェクト骨組みの作成）に進む

