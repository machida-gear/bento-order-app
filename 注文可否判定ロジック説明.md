# 注文可否判定ロジックの説明

## 現在の実装状況

### 1. 注文可能日の判定（現在実装済み）

現在のシステムでは、**`order_calendar`テーブルの`is_available`フィールド**で注文可能日を管理しています。

#### 判定ロジック（`components/calendar-grid.tsx`）

```typescript
const canOrder = (date: Date, orderDay?: OrderDay | null): boolean => {
  // 1. order_calendar.is_available が false の場合は注文不可
  if (!orderDay?.is_available) return false
  
  // 2. 過去の日付は注文不可
  if (isPast(date)) return false
  
  // 3. 今日の場合、締切時刻をチェック
  if (isToday(date) && orderDay.deadline_time) {
    const [hours, minutes] = orderDay.deadline_time.split(':').map(Number)
    const deadline = new Date(today)
    deadline.setHours(hours, minutes, 0, 0)
    
    if (now >= deadline) return false
  }
  
  return true
}
```

### 2. 休日・業者休業日の設定方法

#### 方法1: 管理者が`order_calendar`テーブルを直接編集

```sql
-- 会社の休日を設定（例：年末年始）
UPDATE order_calendar 
SET is_available = false, note = '会社休業日'
WHERE target_date IN ('2025-12-29', '2025-12-30', '2025-12-31', '2026-01-01', '2026-01-02', '2026-01-03');

-- お弁当屋さんの休業日を設定
UPDATE order_calendar 
SET is_available = false, note = '業者休業日'
WHERE target_date = '2025-12-25';
```

#### 方法2: 管理者画面から設定（将来的に実装予定）

- カレンダー管理画面で日付を選択
- `is_available`を`false`に設定
- `note`フィールドに理由を記入（例：「会社休業日」「業者A休業日」など）

### 3. 現在の制限事項

**⚠️ 現在の実装では、以下の判定は行われていません：**

1. **業者（vendors）の`is_active`チェック**
   - `vendors.is_active = false`でも、その業者のメニューが表示される可能性がある
   - 注文可能日の判定には影響しない

2. **メニュー（menu_items）の`is_active`チェック**
   - `menu_items.is_active = false`でも、そのメニューが表示される可能性がある
   - 注文可能日の判定には影響しない

3. **業者別の休業日管理**
   - 現在は「その日全体が注文可能かどうか」のみ判定
   - 業者Aが休みでも業者Bが営業している場合の判定ができない

## 将来的な拡張（複数業者対応）

### 設計方針

将来的に2社以上の業者に対応する場合、以下のような設計が考えられます：

#### オプション1: 日付レベルで判定（現在の方式を拡張）

```typescript
// その日が注文可能かどうか（少なくとも1社が営業していればOK）
const canOrder = async (date: Date): Promise<boolean> => {
  // 1. order_calendar.is_available が false の場合は注文不可（会社全体の休日）
  if (!orderDay?.is_available) return false
  
  // 2. 過去の日付は注文不可
  if (isPast(date)) return false
  
  // 3. 有効な業者が1社でも存在するかチェック
  const { data: activeVendors } = await supabase
    .from('vendors')
    .select('id')
    .eq('is_active', true)
  
  if (!activeVendors || activeVendors.length === 0) return false
  
  // 4. 有効なメニューが1つでも存在するかチェック
  const { data: activeMenus } = await supabase
    .from('menu_items')
    .select('id')
    .eq('is_active', true)
    .in('vendor_id', activeVendors.map(v => v.id))
  
  if (!activeMenus || activeMenus.length === 0) return false
  
  // 5. 今日の場合、締切時刻をチェック
  if (isToday(date) && orderDay.deadline_time) {
    const [hours, minutes] = orderDay.deadline_time.split(':').map(Number)
    const deadline = new Date(today)
    deadline.setHours(hours, minutes, 0, 0)
    
    if (now >= deadline) return false
  }
  
  return true
}
```

#### オプション2: 業者別の休業日テーブルを追加（推奨）

新しいテーブルを追加：

```sql
-- 業者別の休業日管理
CREATE TABLE vendor_holidays (
  id SERIAL PRIMARY KEY,
  vendor_id INTEGER NOT NULL REFERENCES vendors(id) ON DELETE CASCADE,
  holiday_date DATE NOT NULL,
  reason TEXT, -- 例：「定休日」「臨時休業」など
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  UNIQUE(vendor_id, holiday_date)
);
```

判定ロジック：

```typescript
// その日が注文可能かどうか（少なくとも1社が営業していればOK）
const canOrder = async (date: Date, userId: string): Promise<boolean> => {
  const dateStr = formatDateLocal(date)
  
  // 1. order_calendar.is_available が false の場合は注文不可（会社全体の休日）
  const { data: orderDay } = await supabase
    .from('order_calendar')
    .select('*')
    .eq('target_date', dateStr)
    .single()
  
  if (!orderDay?.is_available) return false
  
  // 2. 過去の日付は注文不可
  if (isPast(date)) return false
  
  // 3. 有効な業者を取得
  const { data: activeVendors } = await supabase
    .from('vendors')
    .select('id')
    .eq('is_active', true)
  
  if (!activeVendors || activeVendors.length === 0) return false
  
  // 4. その日が休業日でない業者を取得
  const { data: vendorHolidays } = await supabase
    .from('vendor_holidays')
    .select('vendor_id')
    .eq('holiday_date', dateStr)
  
  const holidayVendorIds = new Set(vendorHolidays?.map(v => v.vendor_id) || [])
  const availableVendorIds = activeVendors
    .map(v => v.id)
    .filter(id => !holidayVendorIds.has(id))
  
  if (availableVendorIds.length === 0) return false
  
  // 5. 有効なメニューが1つでも存在するかチェック
  const { data: activeMenus } = await supabase
    .from('menu_items')
    .select('id')
    .eq('is_active', true)
    .in('vendor_id', availableVendorIds)
  
  if (!activeMenus || activeMenus.length === 0) return false
  
  // 6. 今日の場合、締切時刻をチェック
  if (isToday(date) && orderDay.deadline_time) {
    const [hours, minutes] = orderDay.deadline_time.split(':').map(Number)
    const deadline = new Date(today)
    deadline.setHours(hours, minutes, 0, 0)
    
    if (now >= deadline) return false
  }
  
  return true
}
```

### 推奨される実装方針

**段階的な実装：**

1. **現在（1社のみ）**
   - `order_calendar.is_available`で判定
   - 会社の休日や業者全体の休業日を設定

2. **複数業者対応時（オプション2を推奨）**
   - `vendor_holidays`テーブルを追加
   - 業者別の休業日を管理
   - 少なくとも1社が営業していれば注文可能とする

3. **メニュー選択画面での表示**
   - 注文可能日でも、その日に休業している業者のメニューは非表示
   - 有効な業者のメニューのみ表示

## まとめ

### 現在の設定方法

**休日・業者休業日を設定するには：**

1. Supabase SQL Editorで`order_calendar`テーブルを更新
   ```sql
   UPDATE order_calendar 
   SET is_available = false, note = '会社休業日'
   WHERE target_date = '2025-12-29';
   ```

2. または、将来的に実装される管理者画面から設定

### 将来の拡張性

- **現在の設計は、複数業者対応に拡張可能**
- **`vendor_holidays`テーブルを追加することで、業者別の休業日管理が可能**
- **少なくとも1社が営業していれば注文可能とする設計が推奨**
