# 不足テーブル分析結果と本番対応手順

## 1. 001_initial_schema.sqlで定義されている全テーブル（13個）

| No | テーブル名 | 説明 | 既存テーブルとの対応 |
|----|-----------|------|-------------------|
| 1 | `users_profile` | ユーザープロフィール | ✅ `profiles`（既存） |
| 2 | `vendors` | 業者マスタ | ✅ `vendors`（既存） |
| 3 | `menus` | メニューマスタ | ✅ `menu_items`（既存） |
| 4 | `menu_prices` | メニュー価格 | ✅ `menu_prices`（既存） |
| 5 | `order_days` | 注文可能日カレンダー | ✅ `order_calendar`（既存） |
| 6 | `order_deadlines` | 日別締切時刻 | ❌ **不足** |
| 7 | `orders` | 注文 | ✅ `orders`（既存） |
| 8 | `closing_periods` | 締日期間 | ✅ `closing_periods`（既存） |
| 9 | `operation_logs` | 操作ログ | ✅ `audit_logs`（既存） |
| 10 | `auto_order_settings` | 自動注文設定 | ✅ `auto_order_configs`（既存） |
| 11 | `auto_order_templates` | 自動注文テンプレート | ❌ **不足** |
| 12 | `auto_order_runs` | 自動注文実行履歴 | ✅ `auto_order_runs`（既存） |
| 13 | `auto_order_run_items` | 自動注文実行アイテム | ❌ **不足** |

## 2. 不足テーブルの特定

**不足しているテーブル：3個**

1. **`order_deadlines`** - 日別締切時刻
2. **`auto_order_templates`** - 自動注文テンプレート
3. **`auto_order_run_items`** - 自動注文実行アイテム

## 3. 実行が止まった原因分析

### 3.1 `order_deadlines` テーブル作成失敗の原因

**原因：外部キー制約の参照先テーブル名不一致**

```sql
-- 001_initial_schema.sql の該当部分（86-91行目）
CREATE TABLE order_deadlines (
    date DATE PRIMARY KEY REFERENCES order_days(date) ON DELETE CASCADE,
    ...
);
```

- `order_deadlines` は `order_days(date)` を参照している
- しかし、既存テーブル名は `order_calendar` である
- そのため、`order_days` テーブルが存在せず、外部キー制約の作成に失敗
- 結果として、`order_deadlines` テーブル自体も作成されなかった

**エラーメッセージ（推測）：**
```
ERROR: relation "order_days" does not exist
```

### 3.2 `auto_order_templates` テーブル作成失敗の原因

**原因：外部キー制約の参照先テーブル名不一致（2箇所）**

```sql
-- 001_initial_schema.sql の該当部分（138-147行目）
CREATE TABLE auto_order_templates (
    ...
    user_id UUID NOT NULL REFERENCES users_profile(id) ON DELETE CASCADE,
    menu_id INTEGER NOT NULL REFERENCES menus(id) ON DELETE CASCADE,
    ...
);
```

- `user_id` は `users_profile(id)` を参照しているが、既存テーブル名は `profiles`
- `menu_id` は `menus(id)` を参照しているが、既存テーブル名は `menu_items`
- そのため、外部キー制約の作成に失敗
- 結果として、`auto_order_templates` テーブル自体も作成されなかった

**エラーメッセージ（推測）：**
```
ERROR: relation "users_profile" does not exist
または
ERROR: relation "menus" does not exist
```

### 3.3 `auto_order_run_items` テーブル作成失敗の原因

**原因：外部キー制約の参照先テーブル名不一致**

```sql
-- 001_initial_schema.sql の該当部分（162-171行目）
CREATE TABLE auto_order_run_items (
    ...
    run_id INTEGER NOT NULL REFERENCES auto_order_runs(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES users_profile(id) ON DELETE RESTRICT,
    ...
);
```

- `run_id` は `auto_order_runs(id)` を参照（これは既存テーブルなので問題なし）
- `user_id` は `users_profile(id)` を参照しているが、既存テーブル名は `profiles`
- そのため、外部キー制約の作成に失敗
- 結果として、`auto_order_run_items` テーブル自体も作成されなかった

**エラーメッセージ（推測）：**
```
ERROR: relation "users_profile" does not exist
```

### 3.4 実行順序による影響

001_initial_schema.sqlは以下の順序でテーブルを作成しています：

1. `users_profile` → 実際は `profiles` として作成された
2. `vendors` → 正常に作成
3. `menus` → 実際は `menu_items` として作成された
4. `menu_prices` → 正常に作成（`menu_items` を参照）
5. `order_days` → 実際は `order_calendar` として作成された
6. **`order_deadlines`** → ❌ ここで失敗（`order_days` が存在しない）
7. `orders` → 正常に作成（`profiles` と `menu_items` を参照）
8. `closing_periods` → 正常に作成
9. `operation_logs` → 実際は `audit_logs` として作成された
10. `auto_order_settings` → 実際は `auto_order_configs` として作成された
11. **`auto_order_templates`** → ❌ ここで失敗（`users_profile` と `menus` が存在しない）
12. `auto_order_runs` → 正常に作成（ENUM型に依存）
13. **`auto_order_run_items`** → ❌ ここで失敗（`users_profile` が存在しない）

### 3.5 ENUM型・関数・RLSの影響

- **ENUM型**: すべて正常に作成されている（`auto_order_runs` が作成されているため）
- **関数**: テーブル作成後に定義されているため、影響なし
- **RLSポリシー**: テーブル作成後に定義されているため、影響なし

**結論：外部キー制約の参照先テーブル名不一致が原因**

## 4. 本番環境での安全な対応手順

### ステップ1: バックアップの取得

本番環境では必ずバックアップを取得してください：

1. Supabase Dashboard → Database → Backups
2. または、pg_dumpでバックアップを取得

### ステップ2: 不足テーブルの作成

**推奨SQL: `007_create_missing_tables_production.sql`**

このSQLの特徴：
- ✅ `CREATE TABLE IF NOT EXISTS` で安全に実行
- ✅ 既存テーブル名（`profiles`, `menu_items`, `order_calendar`）を正しく参照
- ✅ 外部キー制約を既存テーブルに正しく設定
- ✅ RLSポリシーを既存テーブル名に応じて設定
- ✅ 既存テーブルやデータに影響なし

**実行方法：**

1. Supabase SQL Editorで `007_create_missing_tables_production.sql` を開く
2. 内容をすべてコピー＆ペースト
3. 「Run」ボタンをクリック
4. エラーがないことを確認

### ステップ3: 実行後の確認

```sql
-- テーブル数の確認（13個になるはず）
SELECT COUNT(*) as table_count
FROM information_schema.tables
WHERE table_schema = 'public'
    AND table_type = 'BASE TABLE';

-- 新規作成されたテーブルの確認
SELECT table_name
FROM information_schema.tables
WHERE table_schema = 'public'
    AND table_type = 'BASE TABLE'
    AND table_name IN ('order_deadlines', 'auto_order_templates', 'auto_order_run_items')
ORDER BY table_name;

-- 外部キー制約の確認
SELECT
    tc.table_name,
    kcu.column_name,
    ccu.table_name AS foreign_table_name
FROM information_schema.table_constraints AS tc
JOIN information_schema.key_column_usage AS kcu
    ON tc.constraint_name = kcu.constraint_name
    AND tc.table_schema = kcu.table_schema
JOIN information_schema.constraint_column_usage AS ccu
    ON ccu.constraint_name = tc.constraint_name
    AND ccu.table_schema = tc.table_schema
WHERE tc.constraint_type = 'FOREIGN KEY'
    AND tc.table_schema = 'public'
    AND tc.table_name IN ('order_deadlines', 'auto_order_templates', 'auto_order_run_items')
ORDER BY tc.table_name;
```

## 5. 作成されるテーブルの詳細

### 5.1 `order_deadlines`

- **目的**: 日別締切時刻を管理
- **依存**: `order_calendar`（既存テーブル）
- **主キー**: `date` (DATE)
- **外部キー**: `order_calendar(date)`

### 5.2 `auto_order_templates`

- **目的**: 自動注文のテンプレート（曜日別パターン）を管理
- **依存**: `profiles`（既存テーブル）、`menu_items`（既存テーブル）
- **主キー**: `id` (SERIAL)
- **外部キー**: `profiles(id)`, `menu_items(id)`

### 5.3 `auto_order_run_items`

- **目的**: 自動注文実行時のユーザーごとの結果を管理
- **依存**: `auto_order_runs`（既存テーブル）、`profiles`（既存テーブル）
- **主キー**: `id` (SERIAL)
- **外部キー**: `auto_order_runs(id)`, `profiles(id)`
- **UNIQUE制約**: `(run_id, user_id)`

## 6. 注意事項

### 本番環境での実行

1. **バックアップ必須**: 必ずバックアップを取得してから実行
2. **メンテナンス時間**: 可能であれば、メンテナンス時間帯に実行
3. **段階的実行**: まずテスト環境で実行して動作確認

### 既存データへの影響

- **新規テーブルの作成のみ**なので、既存テーブルやデータには影響しません
- ただし、外部キー制約の追加時に既存データが制約を満たさない場合はエラーになります
- この場合、既存データを修正してから再実行してください

### エラーが発生した場合

1. **エラーメッセージを確認**: どのテーブル・制約の作成時にエラーが発生したかを特定
2. **既存テーブル名の再確認**: `information_schema.tables` で既存テーブル名を確認
3. **手動での修正**: エラーが発生したテーブル・制約を手動で作成

## 7. 次のステップ

不足テーブルの作成が完了したら：

1. ✅ 全13テーブルが作成されていることを確認
2. ✅ 外部キー制約が正しく設定されていることを確認
3. ✅ RLSポリシーが正しく設定されていることを確認
4. ✅ インデックスが正しく作成されていることを確認
5. ✅ トリガーが正しく設定されていることを確認

その後、STEP2（Next.js プロジェクト骨組みの作成）に進みます。

