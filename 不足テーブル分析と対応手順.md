# 不足テーブル分析と対応手順

## 分析結果

### 1. 001_initial_schema.sqlで定義されているCREATE TABLE数

**合計：13個**

1. `users_profile` - ユーザープロフィール
2. `vendors` - 業者マスタ
3. `menus` - メニューマスタ
4. `menu_prices` - メニュー価格
5. `order_days` - 注文可能日カレンダー
6. `order_deadlines` - 日別締切時刻 ⚠️
7. `orders` - 注文
8. `closing_periods` - 締日期間
9. `operation_logs` - 操作ログ
10. `auto_order_settings` - 自動注文設定
11. `auto_order_templates` - 自動注文テンプレート ⚠️
12. `auto_order_runs` - 自動注文実行履歴
13. `auto_order_run_items` - 自動注文実行アイテム ⚠️

### 2. 既存テーブルとの突き合わせ

既存の10テーブル：
- `audit_logs` → `operation_logs` の可能性
- `auto_order_configs` → `auto_order_settings` の可能性
- `auto_order_runs` → ✅ 一致
- `closing_periods` → ✅ 一致
- `menu_items` → `menus` の可能性
- `menu_prices` → ✅ 一致
- `order_calendar` → `order_days` の可能性
- `orders` → ✅ 一致
- `profiles` → `users_profile` の可能性
- `vendors` → ✅ 一致

### 3. 不足テーブルの特定

**不足しているテーブル：3個**

1. **`order_deadlines`** - 日別締切時刻
   - 依存: `order_days` または `order_calendar`（既存テーブル名に依存）

2. **`auto_order_templates`** - 自動注文テンプレート
   - 依存: `users_profile` または `profiles`、`menus` または `menu_items`

3. **`auto_order_run_items`** - 自動注文実行アイテム
   - 依存: `auto_order_runs`（既存）、`users_profile` または `profiles`

### 4. 未作成の原因分析

#### 4.1 依存関係の問題

`order_deadlines` は `order_days` に依存していますが、既存テーブル名が `order_calendar` の場合、外部キー制約の作成時にエラーが発生した可能性があります。

```sql
-- 001_initial_schema.sql の該当部分
CREATE TABLE order_deadlines (
    date DATE PRIMARY KEY REFERENCES order_days(date) ON DELETE CASCADE,
    ...
);
```

**原因：** `order_days` テーブルが存在しない（`order_calendar` という名前で作成されている）ため、外部キー制約の作成に失敗した可能性

#### 4.2 ENUM型の依存

`auto_order_templates` と `auto_order_run_items` はENUM型に依存していませんが、他のテーブル（`orders`など）がENUM型に依存しているため、ENUM型の作成順序が問題になった可能性は低いです。

#### 4.3 RLSポリシーの循環参照

`auto_order_templates` のRLSポリシーは `users_profile` を参照していますが、既存テーブル名が `profiles` の場合、ポリシー作成時にエラーが発生した可能性があります。

```sql
-- 001_initial_schema.sql の該当部分
CREATE POLICY "auto_order_templates_select_own"
    ON auto_order_templates FOR SELECT
    USING (auth.uid() = user_id);
```

**原因：** テーブル自体は作成されたが、RLSポリシーの作成時にエラーが発生し、テーブル作成がロールバックされた可能性

#### 4.4 SQL実行エラーの可能性

001_initial_schema.sqlを一括実行した際、途中でエラーが発生し、一部のテーブルが作成されなかった可能性があります。

**推奨対応：** エラーログを確認し、どのテーブル作成時にエラーが発生したかを特定

## 対応手順

### ステップ1: 既存テーブルの確認

Supabase SQL Editorで以下を実行：

```sql
-- 003_check_existing_tables.sql を実行
SELECT 
    table_name,
    (SELECT COUNT(*) FROM information_schema.columns WHERE table_schema = 'public' AND table_name = t.table_name) as column_count
FROM information_schema.tables t
WHERE table_schema = 'public'
    AND table_type = 'BASE TABLE'
ORDER BY table_name;
```

**確認ポイント：**
- 既存テーブル名を正確に把握
- `users_profile` vs `profiles`、`menus` vs `menu_items`、`order_days` vs `order_calendar` の違いを確認

### ステップ2: 不足テーブルの作成

**推奨：`005_create_missing_tables_safe.sql` を使用**

このSQLは以下の特徴があります：

1. **既存テーブル名の自動判定**
   - `users_profile` または `profiles` を自動検出
   - `menus` または `menu_items` を自動検出
   - `order_days` または `order_calendar` を自動検出

2. **安全な実行**
   - `CREATE TABLE IF NOT EXISTS` を使用
   - 既存の制約・ポリシーをチェックしてから作成
   - エラーが発生しても既存テーブルに影響なし

3. **依存関係の自動解決**
   - 外部キー制約を既存テーブル名に応じて自動設定
   - RLSポリシーを既存テーブル名に応じて自動設定

**実行方法：**

1. Supabase SQL Editorで `005_create_missing_tables_safe.sql` を開く
2. 内容をすべてコピー＆ペースト
3. 「Run」ボタンをクリック
4. エラーがないことを確認

### ステップ3: 実行後の確認

```sql
-- 006_verification_queries.sql を実行
-- または、以下のクエリで確認

-- テーブル数の確認（13個になるはず）
SELECT COUNT(*) as table_count
FROM information_schema.tables
WHERE table_schema = 'public'
    AND table_type = 'BASE TABLE';

-- 新規作成されたテーブルの確認
SELECT table_name
FROM information_schema.tables
WHERE table_schema = 'public'
    AND table_type = 'BASE TABLE'
    AND table_name IN ('order_deadlines', 'auto_order_templates', 'auto_order_run_items')
ORDER BY table_name;
```

## 作成されるファイル一覧

1. **`003_check_existing_tables.sql`** - 既存テーブルの確認用SQL
2. **`004_create_missing_tables.sql`** - 不足テーブル作成SQL（基本版）
3. **`005_create_missing_tables_safe.sql`** - 不足テーブル作成SQL（推奨・安全版）
4. **`006_verification_queries.sql`** - 実行後の確認用SQL
5. **`不足テーブル作成手順.md`** - 詳細な手順書

## 安全に実行するための注意事項

### 本番環境での実行

1. **バックアップの取得**
   - Supabase Dashboard → Database → Backups からバックアップを取得
   - または、pg_dumpでバックアップを取得

2. **テスト環境での事前確認**
   - 可能であれば、テスト環境で先に実行して動作確認

3. **段階的な実行**
   - まず `003_check_existing_tables.sql` で既存テーブルを確認
   - 次に `005_create_missing_tables_safe.sql` を実行
   - 最後に `006_verification_queries.sql` で確認

### 既存テーブルへの影響

- **新規テーブルの作成のみ**なので、既存テーブルやデータには影響しません
- ただし、外部キー制約の追加時に既存データが制約を満たさない場合はエラーになります
- この場合、既存データを修正してから再実行してください

### エラーが発生した場合

1. **エラーメッセージを確認**
   - Supabase SQL Editorのエラーメッセージを確認
   - どのテーブル・制約・ポリシーの作成時にエラーが発生したかを特定

2. **既存テーブル名の再確認**
   - `003_check_existing_tables.sql` を再実行
   - 既存テーブル名が想定と異なる場合は、手動で外部キー制約を追加

3. **手動での修正**
   - エラーが発生したテーブル・制約・ポリシーを手動で作成
   - 詳細は `不足テーブル作成手順.md` の「トラブルシューティング」を参照

## 次のステップ

不足テーブルの作成が完了したら：

1. ✅ 全13テーブルが作成されていることを確認
2. ✅ 外部キー制約が正しく設定されていることを確認
3. ✅ RLSポリシーが正しく設定されていることを確認
4. ✅ インデックスが正しく作成されていることを確認
5. ✅ トリガーが正しく設定されていることを確認

その後、STEP2（Next.js プロジェクト骨組みの作成）に進みます。

