# ユーザー管理機能の改善とセキュリティ強化

このドキュメントでは、ユーザー管理機能の改善とセキュリティ強化に関する実装内容を記録します。

> 📖 **関連ドキュメント**: [README.md](./README.md) - すべてのドキュメントへの参照

---

## 実装概要

ユーザー管理機能の改善とセキュリティ強化を実施しました。主な改善点は以下の通りです：

1. ユーザー管理 API の 403 エラー修正
2. 退職日の処理ロジック改善
3. 退職日の自動無効化処理の実装
4. 注文 API でのユーザー状態チェック追加
5. ユーザー管理画面の改善（新規作成機能削除、パスワードリセット機能追加）
6. デフォルト締切時刻変更時の自動更新機能

---

## 1. ユーザー管理 API の 403 エラー修正

### 問題

管理者ユーザーでユーザー管理画面にアクセスすると、403 Forbidden エラーが発生していました。

### 原因

- ユーザー管理 API で Service Role Key を使用していなかった
- RLS ポリシーの干渉により、管理者権限チェックでプロフィール情報が取得できなかった
- `profiles`テーブルの RLS ポリシーが循環参照を起こしていた可能性

### 解決策

- 管理者権限チェックとユーザー一覧取得に Service Role Key（`supabaseAdmin`）を使用
- RLS ポリシーをバイパスして、プロフィール情報を取得可能に

### 修正ファイル

- `app/api/admin/users/route.ts`

  - GET: 管理者権限チェックとユーザー一覧取得を`supabaseAdmin`に変更
  - POST: 管理者権限チェックを`supabaseAdmin`に変更

- `app/api/admin/users/[id]/route.ts`
  - PUT: 管理者権限チェックを`supabaseAdmin`に変更
  - DELETE: 管理者権限チェックを`supabaseAdmin`に変更

---

## 2. 退職日の処理ロジック改善

### 問題

- 退職日が設定されている場合、未来・過去に関係なく常に`is_active = false`になっていた
- 未来の退職日を設定した場合でも、即座に無効化されてしまい、システムが使えなくなる

### 解決策

退職日の処理ロジックを以下のように改善しました：

1. **退職日が未来（今日以降）**: `is_active = true`のまま（在籍中として扱う）
2. **退職日が過去（今日より前）**: `is_active = false`に自動設定（退職済みとして扱う）
3. **退職日が未設定**: `is_active`の値をそのまま使用

### 修正ファイル

- `app/api/admin/users/[id]/route.ts`: 退職日の処理ロジックを改善

```typescript
// 退職日の処理
// - 退職日が設定されていて、かつ過去の日付の場合は、自動的にis_active=falseにする
// - 退職日が未来の日付の場合は、まだ在籍中なのでis_activeの値をそのまま使用
let finalIsActive = is_active ?? true;
if (left_date) {
  const leftDate = new Date(left_date);
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  leftDate.setHours(0, 0, 0, 0);

  // 退職日が過去の場合は、自動的にis_active=falseにする
  if (leftDate < today) {
    finalIsActive = false;
  }
  // 退職日が未来の場合は、is_activeの値をそのまま使用（在籍中）
}
```

---

## 3. 退職日の自動無効化処理の実装

### 実装内容

退職日の翌日から自動的にユーザーを無効化する Cron Job を実装しました。

- 毎日午前 0 時（JST）に自動実行
- `order_calendar`テーブルで、退職日が過去の日付で`is_active = true`のユーザーを自動的に無効化

### 実装ファイル

#### 新規作成

- `app/api/admin/users/deactivate-expired/route.ts`: 退職済みユーザーの自動無効化 API

#### 更新

- `vercel.json`: Cron Job の設定を追加

```json
{
  "crons": [
    {
      "path": "/api/auto-order/run",
      "schedule": "0 10 * * *"
    },
    {
      "path": "/api/admin/users/deactivate-expired",
      "schedule": "0 0 * * *"
    }
  ]
}
```

### 動作確認

- Vercel にデプロイ後、Cron Job が自動実行される
- 開発環境で手動実行する場合は、`AUTO_ORDER_SECRET`を設定して認証が必要

---

## 4. 注文 API でのユーザー状態チェック追加

### 実装内容

注文作成・更新・キャンセル API で、ユーザーの`is_active`と退職日をチェックするようにしました。

- 無効ユーザー（`is_active = false`）は注文不可
- 退職日が過去の日付のユーザーは注文不可

### 実装ファイル

- `app/api/orders/route.ts`: `is_active`と退職日チェックを追加
- `app/api/orders/[id]/route.ts`: `is_active`と退職日チェックを追加（PUT、PATCH）
- `app/(user)/layout.tsx`: 退職日チェックを追加（レイアウトレベルでログアウト）

### チェック内容

```typescript
// 無効ユーザーは注文不可
if (!profile.is_active) {
  return NextResponse.json(
    { error: "アカウントが無効化されています。管理者に連絡してください。" },
    { status: 403 }
  );
}

// 退職日が設定されていて、かつ過去の日付の場合は注文不可
if (profile.left_date) {
  const leftDate = new Date(profile.left_date);
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  leftDate.setHours(0, 0, 0, 0);

  if (leftDate < today) {
    return NextResponse.json(
      { error: "退職済みのため注文できません。" },
      { status: 403 }
    );
  }
}
```

---

## 5. ユーザー管理画面の改善

### 5.1 新規作成機能の削除

#### 変更内容

- ユーザー管理画面から新規作成ボタンとフォームを削除
- 新規ユーザー作成は認証画面（`/login`）から行う仕様に統一
- 管理者画面では既存ユーザーの編集のみ可能

#### 修正ファイル

- `app/admin/users/page.tsx`: 新規作成機能を削除

### 5.2 パスワードリセット機能の実装

#### 管理者画面からのパスワードリセット

- ユーザー一覧に「リセット」ボタンを追加（メールアドレスがある場合のみ表示）
- パスワードリセットメールを送信する機能

#### ログインページからのパスワードリセット

- 「パスワードを忘れた方はこちら」リンクを追加
- メールアドレスを入力してパスワードリセットメールを送信

#### 実装ファイル

- `app/admin/users/page.tsx`: パスワードリセット機能を追加
- `app/(auth)/login/page.tsx`: パスワードリセット機能を追加
- `app/api/admin/users/[id]/reset-password/route.ts`: パスワードリセット API（新規作成）

#### パスワードリセット API

```typescript
// Supabase Admin APIのgenerateLinkを使用してパスワードリセットリンクを生成
const { error: resetError } = await supabaseAdmin.auth.admin.generateLink({
  type: "recovery",
  email: email,
  options: {
    redirectTo: `${
      process.env.NEXT_PUBLIC_SITE_URL || "http://localhost:3000"
    }/login?reset=true`,
  },
});
```

### 5.3 UI 改善

- パスワードリセットボタンのテキストを「パスワードリセット」から「リセット」に短縮
- ボタンのサイズを小さくし（`px-3 py-1` → `px-2 py-1`、`text-sm` → `text-xs`）、行の高さを抑える
- ボタン間に`title`属性を追加して、ホバー時に完全な説明を表示

---

## 6. デフォルト締切時刻変更時の自動更新機能

### 実装内容

システム設定でデフォルト締切時刻を変更した場合、`order_calendar`テーブルの締切時刻を自動更新する機能を実装しました。

- 更新対象：今日以降の日付で、`deadline_time`が NULL でないレコード
- システム設定画面から API Route（`/api/admin/settings`）経由で更新するように変更

### 問題と解決

#### 問題 1: システム設定画面が API Route を使用していなかった

- **原因**: クライアントサイドから直接 Supabase に更新を送信していた
- **解決**: API Route 経由で更新するように変更

#### 問題 2: 時刻形式の不一致

- **原因**: データベースの`default_deadline_time`は`TIME`型で`HH:MM:SS`形式（例：`10:00:00`）、リクエストから来る値は`HH:MM`形式（例：`10:00`）
- **解決**: データベースから取得した時刻を`HH:MM`形式に変換してから比較

### 実装ファイル

- `app/api/admin/settings/route.ts`: デフォルト締切時刻変更時の`order_calendar`更新処理を追加
- `app/admin/settings/page.tsx`: 直接更新から API Route 経由の更新に変更

### 実装詳細

```typescript
// 時刻形式を統一して比較（DBはHH:MM:SS形式、リクエストはHH:MM形式）
let hasDeadlineTimeChanged = false;
if (default_deadline_time) {
  // データベースの時刻をHH:MM形式に変換（HH:MM:SS → HH:MM）
  const currentTimeFormatted = currentSettings?.default_deadline_time
    ? currentSettings.default_deadline_time.toString().slice(0, 5) // "10:00:00" → "10:00"
    : null;

  hasDeadlineTimeChanged = currentTimeFormatted !== default_deadline_time;
}

// デフォルト締切時刻が変更された場合、order_calendarテーブルの今日以降のdeadline_timeを更新
if (default_deadline_time && hasDeadlineTimeChanged) {
  // TIME型に変換（HH:MM形式をHH:MM:SS形式に変換）
  const defaultDeadlineTimeFormatted = default_deadline_time.includes(":")
    ? default_deadline_time.split(":").length === 2
      ? `${default_deadline_time}:00`
      : default_deadline_time
    : default_deadline_time;

  // 今日の日付を取得（YYYY-MM-DD形式）
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const todayStr = today.toISOString().split("T")[0];

  // 今日以降で、deadline_timeがNULLでないレコードの締切時刻を新しいデフォルト値で更新
  const { data: updatedRecords, error: calendarUpdateError } =
    await supabaseAdmin
      .from("order_calendar")
      .update({ deadline_time: defaultDeadlineTimeFormatted })
      .gte("target_date", todayStr)
      .not("deadline_time", "is", null)
      .select();
}
```

---

## 診断用 SQL ファイル

以下の診断用 SQL ファイルを作成しました：

- `supabase/migrations/054_check_current_user_profile.sql`: ユーザープロフィール確認用 SQL
- `supabase/migrations/055_fix_user_admin_role.sql`: ユーザーを管理者に設定する SQL
- `supabase/migrations/056_activate_admin_user.sql`: 管理者ユーザーを有効化する SQL

---

## 動作確認

### ユーザー管理画面

1. ✅ 管理者権限でユーザー一覧が表示される
2. ✅ ユーザーの編集ができる
3. ✅ ユーザーの削除（無効化）ができる
4. ✅ パスワードリセットメールの送信ができる

### パスワードリセット

1. ✅ 管理者画面からパスワードリセットメールを送信できる
2. ✅ ログインページからパスワードリセットメールを送信できる

### 退職日の自動無効化

1. ✅ 退職日が過去のユーザーが自動的に無効化される（Cron Job）

### 注文制限

1. ✅ 無効ユーザーは注文不可
2. ✅ 退職済みユーザーは注文不可

### デフォルト締切時刻の自動更新

1. ✅ デフォルト締切時刻を変更すると、今日以降の日付で既に締切時刻が設定されているレコードが自動更新される

---

## まとめ

ユーザー管理機能の改善とセキュリティ強化を実施し、以下の機能を実装しました：

1. **セキュリティ強化**: Service Role Key を使用した適切な権限チェック
2. **退職日の処理改善**: 未来の退職日でもシステムを利用可能に
3. **自動無効化**: 退職日の翌日から自動的にユーザーを無効化
4. **パスワードリセット**: 管理者とユーザーの両方からパスワードリセットが可能
5. **UI 改善**: ユーザー一覧の表示を改善
6. **デフォルト締切時刻の自動更新**: システム設定変更時に自動的に反映

これらの改善により、ユーザー管理機能がより使いやすく、セキュアになりました。
