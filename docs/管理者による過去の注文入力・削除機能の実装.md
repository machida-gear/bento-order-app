# 管理者による過去の注文入力・削除機能の実装

## 概要

後日注文データに間違いがわかったときの対応として、管理者のみ過去の注文を入力・削除できる機能を実装しました。また、管理者モードの判定ロジックを改善し、管理者が管理画面から自分のカレンダーを開く場合も管理者モードで動作するようにしました。

## 管理者モードの定義

- **管理者モード**: `user_id`パラメータが指定されている場合（管理者権限がある場合のみ許可）
- **ユーザーモード**: `user_id`パラメータが指定されていない場合
- **動作仕様**:
  - 管理者が管理画面からカレンダーを開く場合: 管理者モード（過去の日付にも注文可能）
  - 管理者がユーザー画面からカレンダーを開く場合: ユーザーモード（通常の範囲での変更のみ）

## 実装内容

### 1. 過去の注文入力機能

#### 要件

- 管理者のみ過去の日付に注文を作成可能
- 一般ユーザーは従来どおりの制限を維持

#### 実装詳細

**修正ファイル**: 
- `app/api/orders/route.ts`
- `app/(user)/orders/new/page.tsx`
- `app/(user)/calendar/page.tsx`
- `components/calendar-grid.tsx`

1. **管理者モード判定ロジックの追加**
   - `isAdminMode = isAdmin && user_id !== undefined`で判定
   - 管理者権限があっても、`user_id`パラメータがなければユーザーモード

2. **過去の日付チェックのスキップ**
   - 管理者モードの場合は過去の日付チェックをスキップ
   - 一般ユーザー・管理者でもユーザーモードの場合は従来どおり過去の日付には注文不可

3. **最大注文可能日数チェックのスキップ**
   - 管理者モードの場合は最大注文可能日数の制限をスキップ
   - 一般ユーザー・管理者でもユーザーモードの場合は従来どおりの制限を維持

4. **注文可能日チェックのスキップ**
   - 管理者モードの場合は注文可能日チェックをスキップ
   - 一般ユーザー・管理者でもユーザーモードの場合は従来どおり注文不可日には注文不可

5. **締切時刻チェックのスキップ**
   - 管理者モードの場合は締切時刻チェックをスキップ
   - 一般ユーザー・管理者でもユーザーモードの場合は従来どおり締切時刻を過ぎた日付には注文不可

6. **カレンダー画面の改善**
   - 管理者モードの場合、過去の日付も選択可能
   - 過去の日付のグレーアウト処理を管理者モードでスキップ
   - 過去の日付の注文も編集可能

#### コード変更箇所

```typescript
// 管理者モードの判定: user_idパラメータが指定されている場合（管理者権限がある場合のみ許可）
const isAdminMode = isAdmin && user_id !== undefined;

// 過去の日付チェック（管理者モードの場合はスキップ）
if (!isAdminMode && orderDateObj < today) {
  return NextResponse.json(
    { error: "過去の日付には注文できません" },
    { status: 400 }
  );
}

// 最大注文可能日数をチェック（管理者モードの場合はスキップ）
if (!isAdminMode && systemSettingsTyped?.max_order_days_ahead) {
  // ... チェック処理
}

// 注文可能日チェック（管理者モードの場合はスキップ）
if (!isAdminMode) {
  if (orderDayError || !orderDayTyped || !orderDayTyped.is_available) {
    return NextResponse.json(
      { error: "この日は注文できません" },
      { status: 400 }
    );
  }
  // 締切時刻チェック
}
```

### 2. 注文削除機能

#### 要件

- 管理者のみ注文を物理削除可能
- 削除操作を監査ログに記録
- 注文一覧画面から削除可能

#### 実装詳細

**修正ファイル**: `app/api/orders/[id]/route.ts`

1. **DELETEメソッドの追加**
   - 管理者権限チェックを実装
   - 注文の物理削除を実行
   - 監査ログに記録（`order.delete.admin`アクション）

2. **削除ボタンコンポーネントの作成**
   - `app/admin/orders/today/delete-order-button.tsx`を新規作成
   - 削除前の確認ダイアログを表示
   - エラーハンドリングを実装

3. **注文一覧画面への削除ボタン追加**
   - `app/admin/orders/today/page.tsx`に削除ボタンを追加
   - 各注文の操作列に「削除」ボタンを表示

#### コード変更箇所

```typescript
// DELETEメソッドの追加
export async function DELETE(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  // 管理者権限チェック
  if (!isAdmin) {
    return NextResponse.json(
      { error: "管理者権限が必要です" },
      { status: 403 }
    );
  }

  // 注文を物理削除
  const { error: deleteError } = await (supabaseAdmin
    .from("orders") as any)
    .delete()
    .eq("id", orderId);

  // 監査ログ記録
  await (supabaseAdmin.from("audit_logs") as any).insert({
    actor_id: user.id,
    action: "order.delete.admin",
    details: {
      order_id: orderId,
      order_date: orderTyped.order_date,
      target_user_id: orderTyped.user_id,
      // ...
    },
    target_table: "orders",
    target_id: orderId.toString(),
  });
}
```

### 3. 締切時刻を過ぎた注文のキャンセル制限

#### 要件

- 一般ユーザーは締切時刻を過ぎた注文をキャンセル不可
- 管理者は締切時刻を過ぎた注文もキャンセル可能（運用上の柔軟性のため）

#### 実装詳細

**修正ファイル**: 
- `app/api/orders/[id]/route.ts`（PATCHメソッド）
- `app/(user)/orders/page.tsx`

1. **キャンセルAPIの修正**
   - 一般ユーザーの場合、締切時刻を過ぎた注文をキャンセル不可
   - 管理者の場合は締切時刻を過ぎた注文もキャンセル可能

2. **注文履歴画面の修正**
   - `isAfterDeadline`関数を改善
   - 締切時刻を過ぎた注文のキャンセルボタンを非表示

#### コード変更箇所

```typescript
// 一般ユーザーの場合、締切時刻を過ぎた注文はキャンセル不可（管理者は可能）
if (!isAdmin) {
  if (orderDayTypedDelete?.deadline_time) {
    // 締切時刻チェック
    if (now >= deadline) {
      return NextResponse.json(
        {
          error: "締切時刻を過ぎているため、キャンセルできません",
        },
        { status: 400 }
      );
    }
  }
}
```

### 4. 管理者モード判定ロジックの改善

#### 要件

- 管理者が管理画面から自分のカレンダーを開く場合も管理者モードで動作
- 管理者がユーザー画面からカレンダーを開く場合はユーザーモードで動作
- 管理者モードの場合のみ過去の日付に注文可能

#### 実装詳細

**修正ファイル**:
- `app/(user)/calendar/page.tsx`
- `app/(user)/orders/new/page.tsx`
- `components/calendar-grid.tsx`
- `app/api/orders/route.ts`

1. **管理者モード判定の統一**
   - `isAdminMode = isAdmin && user_id !== undefined`で統一
   - 管理者権限があっても、`user_id`パラメータがなければユーザーモード

2. **カレンダー画面の改善**
   - 管理者モードの場合、過去の日付も選択可能
   - 過去の日付のグレーアウト処理を管理者モードでスキップ
   - 過去の日付の注文も編集可能

3. **注文作成画面の改善**
   - 管理者モードの場合、過去の日付でも注文作成可能
   - 管理者モード表示を改善（自分のカレンダーの場合も表示）

#### コード変更箇所

```typescript
// カレンダーページ
const isAdminMode = isAdmin && params.user_id !== undefined;

// カレンダーグリッド
const canOrder = (date: Date, orderDay?: OrderDay | null): boolean => {
  // 管理者モードの場合は注文可能日チェックをスキップ（過去の日付も選択可能）
  if (isAdminMode) {
    return true;
  }
  // ... 通常のチェック
};

// 注文作成画面
const isAdminMode = isAdmin && resolvedSearchParams.user_id !== undefined;
if (!isAdminMode && orderDateObj < today) {
  redirect('/calendar')
}
```

## 修正ファイル一覧

1. `app/api/orders/route.ts`
   - 管理者モード判定ロジックを追加（`isAdminMode = isAdmin && user_id !== undefined`）
   - 管理者モードの場合は過去の日付チェック、最大注文可能日数チェック、注文可能日チェック、締切時刻チェックをスキップ

2. `app/api/orders/[id]/route.ts`
   - 一般ユーザーの場合は締切時刻を過ぎた注文をキャンセル不可に修正
   - DELETEメソッドを追加（管理者のみ、注文の物理削除）

3. `app/(user)/orders/page.tsx`
   - `isAfterDeadline`関数を改善

4. `app/(user)/calendar/page.tsx`
   - 管理者モード判定ロジックを追加（`isAdminMode = isAdmin && params.user_id !== undefined`）
   - `CalendarGrid`コンポーネントに`isAdminMode`を渡すように修正

5. `app/(user)/orders/new/page.tsx`
   - 管理者モード判定ロジックを追加（`isAdminMode = isAdmin && resolvedSearchParams.user_id !== undefined`）
   - 管理者モードの場合は過去の日付チェック、最大注文可能日数チェック、注文可能日チェック、締切時刻チェックをスキップ

6. `components/calendar-grid.tsx`
   - `isAdminMode`プロパティを追加
   - 管理者モードの場合、過去の日付も選択可能
   - 過去の日付のグレーアウト処理を管理者モードでスキップ
   - `CalendarCell`コンポーネントに`isAdminMode`を渡し、過去の日付の注文も編集可能に

7. `app/admin/orders/today/page.tsx`
   - 削除ボタンを追加

8. `app/admin/orders/today/delete-order-button.tsx`
   - 削除ボタンコンポーネント（新規作成）

## 確認事項

- ✅ 管理者が過去の日付に注文を作成できる（管理者モードの場合のみ）
- ✅ 管理者が注文を物理削除できる
- ✅ 一般ユーザーは締切時刻を過ぎた注文をキャンセルできない
- ✅ 管理者は締切時刻を過ぎた注文もキャンセル可能
- ✅ 削除操作が監査ログに記録される
- ✅ 管理者が管理画面から自分のカレンダーを開く場合も管理者モードで動作
- ✅ 管理者がユーザー画面からカレンダーを開く場合はユーザーモードで動作
- ✅ 管理者が管理画面から他のユーザーのカレンダーを開く場合も管理者モードで動作

## 関連ドキュメント

- [CHANGELOG.md](./CHANGELOG.md) - 変更履歴
- [DECISIONS.md](./DECISIONS.md) - 設計判断
- [PROGRESS.md](./PROGRESS.md) - 進捗状況
- [SPEC.md](./SPEC.md) - システム仕様書
