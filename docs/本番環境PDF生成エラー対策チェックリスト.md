# 本番環境PDF生成エラー対策チェックリスト

このドキュメントでは、本番環境でPDF生成エラーが発生しないようにするためのチェックリストを記載します。

> 📖 **関連ドキュメント**: [README.md](./README.md) - すべてのドキュメントへの参照

---

## デプロイ前の確認事項

### 1. フォントファイルの確認

- [ ] `node_modules/pdfkit/js/data/`にフォントファイル（`.afm`）が存在することを確認
- [ ] 特に`Helvetica.afm`が存在することを確認
- [ ] すべての`.afm`ファイルが正しく配置されていることを確認

### 2. ビルド時の確認

- [ ] 本番環境でビルドする際、フォントファイルが正しく配置されることを確認
- [ ] `.next`フォルダ内にフォントファイルがコピーされることを確認
- [ ] ビルドログにフォントファイル関連のエラーがないことを確認

### 3. エラーハンドリングの確認

- [ ] PDF生成APIでフォントファイルが見つからない場合のエラーハンドリングが実装されていることを確認
- [ ] エラーメッセージが明確に表示されることを確認
- [ ] エラーログが正しく記録されることを確認

### 4. 日本語フォントの設定

- [ ] 日本語フォント（IPAexフォントまたはIPAフォント）を`public/fonts/`フォルダに配置
- [ ] フォントファイルのダウンロード手順は`docs/PDFフォント設定手順.md`を参照
- [ ] フォントファイルが正しく読み込まれることを確認

### 5. 会社情報の設定

- [ ] 本番環境で会社情報を設定することを推奨
- [ ] システム設定画面（`/admin/settings`）から会社情報を入力
- [ ] 環境変数（`PDF_SENDER_*`）はフォールバックとして使用可能

---

## デプロイ後の確認事項

### 1. PDF生成の動作確認

- [ ] PDF生成API（`/api/admin/orders/today/pdf?date=YYYY-MM-DD&vendor_id=XXX`）が正常に動作することを確認
- [ ] PDFファイルが正しく生成されることを確認
- [ ] PDFの内容が正しく表示されることを確認（日本語が文字化けしていないか）

### 2. エラーログの確認

- [ ] エラーログにフォントファイル関連のエラーがないことを確認
- [ ] エラーログにPDF生成関連のエラーがないことを確認
- [ ] エラーログが正しく記録されていることを確認

### 3. パフォーマンスの確認

- [ ] PDF生成の処理時間が許容範囲内であることを確認
- [ ] メモリ使用量が適切であることを確認
- [ ] 同時リクエスト時の動作を確認

---

## トラブルシューティング

### エラー: `ENOENT: no such file or directory, open '...Helvetica.afm'`

**原因**: フォントファイルが見つからない

**解決策**:
1. `node_modules/pdfkit/js/data/`にフォントファイルが存在することを確認
2. ビルド時にフォントファイルが正しく配置されることを確認
3. PDF生成APIのエラーハンドリングを確認

### エラー: 日本語が文字化けする

**原因**: 日本語フォントが正しく読み込まれていない

**解決策**:
1. `public/fonts/`フォルダに日本語フォント（IPAexフォントまたはIPAフォント）を配置
2. フォントファイルのダウンロード手順は`docs/PDFフォント設定手順.md`を参照
3. PDF生成APIのフォント登録処理を確認

### エラー: 会社情報が表示されない

**原因**: 会社情報が設定されていない、または取得に失敗している

**解決策**:
1. システム設定画面（`/admin/settings`）から会社情報を設定
2. 環境変数（`PDF_SENDER_*`）を設定（フォールバック）
3. PDF生成APIの会社情報取得処理を確認

---

## 関連ドキュメント

- [PDF生成機能の改善と発注書形式への変更.md](./PDF生成機能の改善と発注書形式への変更.md)
- [PDF出力機能のフォント問題解決と日本語対応.md](./PDF出力機能のフォント問題解決と日本語対応.md)
- [PDFフォント設定手順.md](./PDFフォント設定手順.md)
- [本番環境デプロイ時のチェックリスト.md](./本番環境デプロイ時のチェックリスト.md)
