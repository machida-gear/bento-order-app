# 注文更新時の制約違反エラー修正

## 概要

同日の注文を取り消したり変更したりを何度か繰り返していると、注文変更時に「duplicate key value violates unique constraint "unique_order_per_day"」というエラーが発生する問題を修正しました。

## 問題

### エラー内容

```
duplicate key value violates unique constraint "unique_order_per_day"
```

- エラー発生条件：同日の注文を取り消したり変更したりを繰り返していると発生
- 発生場所：注文更新API（`PUT /api/orders/[id]`）
- HTTPステータス：500 Internal Server Error

### 再現手順

1. ユーザーが特定の日付に注文を作成（例：2026-01-10、メニューA、数量1）
2. その注文をキャンセル（`status = 'canceled'`に更新、レコードは残る）
3. 同じ日に新しい注文を作成（キャンセル済みの注文を削除してからINSERT）
4. 注文を更新しようとする（PUTリクエスト）
5. **エラー発生**

## 原因

### データベースの制約

`orders`テーブルには以下のUNIQUE制約が定義されています：

```sql
UNIQUE(user_id, menu_id, order_date, status)
```

この制約により、同じユーザーが同じ日に同じメニューで同じステータスの注文を複数作成することはできません。

### 問題の流れ

1. **注文作成時（POST /api/orders）**:
   - キャンセル済みの注文がある場合、削除してからINSERT（正しく動作）

2. **注文更新時（PUT /api/orders/[id]）**:
   - キャンセル済みの注文を削除する処理が**なかった**
   - 同じユーザー・同じ日付・同じメニューでキャンセル済みの注文が残っている状態
   - 注文を更新（UPDATE）する際に、制約違反が発生する可能性がある

### 具体的なシナリオ

1. ユーザーが2026-01-10にメニューAを注文（`status = 'ordered'`）
2. その注文をキャンセル（`status = 'canceled'`に更新）
3. 同じ日に新しい注文を作成（キャンセル済みの注文を削除してからINSERT、`status = 'ordered'`）
4. しかし、何らかの理由でキャンセル済みの注文が残っている可能性がある
5. 注文を更新しようとすると、同じユーザー・同じ日付・同じメニューで`status = 'ordered'`の注文が既に存在するため、制約違反が発生

## 解決策

### 実装内容

注文更新処理（PUT）で、**更新前にキャンセル済みの注文を削除する処理を追加**しました。

```typescript
// キャンセル済みの注文がある場合、UNIQUE制約違反を避けるために削除する
// 同じユーザー、同じ日付、同じメニューでキャンセル済みの注文を削除
const canceledOrdersResult = await client.query(
  `SELECT id FROM orders 
   WHERE user_id = $1 AND order_date = $2 
     AND status = 'canceled' AND menu_item_id = $3 AND id != $4`,
  [order.user_id, order.order_date, menu_id, orderId]
);

if (canceledOrdersResult.rows.length > 0) {
  for (const canceledOrder of canceledOrdersResult.rows) {
    await client.query("DELETE FROM orders WHERE id = $1", [
      canceledOrder.id,
    ]);
  }
}
```

### 修正のポイント

1. **更新対象の注文以外のキャンセル済み注文を削除**:
   - `id != $4`の条件により、更新対象の注文自体は削除しない
   - 同じユーザー・同じ日付・同じメニューで、他のキャンセル済み注文のみを削除

2. **トランザクション内で実行**:
   - すべての処理がトランザクション内で実行されるため、原子性が保証される
   - エラーが発生した場合は、すべての変更がロールバックされる

3. **注文作成処理と同様のロジック**:
   - 注文作成処理（POST）でも同じロジックが実装されている
   - 一貫性のある処理になっている

## 修正ファイル

- `app/api/orders/[id]/route.ts`:
  - 注文更新処理（PUT）に、キャンセル済み注文の削除処理を追加
  - 更新対象の注文以外で、同じユーザー・同じ日付・同じメニューでキャンセル済みの注文を削除

## 確認事項

- ✅ 同日の注文を取り消したり変更したりを繰り返しても、エラーが発生しない
- ✅ 更新対象の注文自体は削除されない
- ✅ トランザクション内で処理が実行されるため、原子性が保証される
- ✅ 注文作成処理と同様のロジックが実装されている

## 注意事項

- **キャンセル済み注文の削除**: キャンセル済みの注文は、新しい注文を作成する際や既存の注文を更新する際に自動的に削除されます。これは、データベースの制約違反を防ぐためです。
- **監査ログ**: 削除されたキャンセル済み注文に関する監査ログは、注文作成・更新時の監査ログに記録されます。

## 関連ドキュメント

- [CHANGELOG.md](./CHANGELOG.md) - 変更履歴
- [PROGRESS.md](./PROGRESS.md) - プロジェクト進捗状況
- [注文機能の実装と問題解決.md](./注文機能の実装と問題解決.md) - 注文機能の実装詳細

---

**作成日**: 2026-01-XX  
**最終更新日**: 2026-01-XX
