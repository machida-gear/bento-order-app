# 注文履歴締日期間表示とロックファイル問題修正

このドキュメントでは、注文履歴ページの締日期間表示機能の実装と、開発環境のロックファイル問題の修正について説明します。

> 📖 **関連ドキュメント**: [CHANGELOG.md](./CHANGELOG.md), [環境変数設定手順.md](./環境変数設定手順.md)

---

## 1. 注文履歴ページの締日期間表示機能

### 概要

注文履歴ページで、締日期間で区切って注文を集計・表示する機能を追加しました。

### 機能

- 「先月」「今月」「来月」の切り替えボタン（デフォルトは「今月」）
- システム設定の締日を基準に締日期間を自動計算
- 選択した期間の注文一覧と合計金額を表示

### 実装ファイル

- `app/(user)/orders/page.tsx` - サーバーコンポーネント（期間計算、データ取得）
- `components/orders-history-client.tsx` - クライアントコンポーネント（UI表示、期間切り替え）

### 締日期間の計算ロジック

```typescript
function calculateSingleClosingPeriod(
  closingDay: number | null,
  year: number,
  month: number
): CalculatedPeriod {
  // 月末締め（closingDay が null）: 月の1日から月末まで
  // 指定日締め（例：10日締め）: 前月の締日+1日から当月の締日まで
  // 重要: この関数は「その月を終了月とする期間」を計算する
}
```

### 先月・来月の期間計算

```typescript
// 先月・来月の計算は「終了月」を基準にする
// calculateSingleClosingPeriodは「その月を終了月とする期間」を計算するため
const [currentEndYear, currentEndMonth] = currentPeriod.end_date.split('-').map(Number);
const currentPeriodEndMonth = currentEndMonth - 1; // 0-11に変換

// 先月: 終了月から1ヶ月前
// 来月: 終了月から1ヶ月後
```

### order_date の形式変換

```typescript
// order_dateがDateオブジェクトの場合も正しく処理
const formatOrderDate = (orderDate: string | Date): string => {
  if (orderDate instanceof Date) {
    // DateオブジェクトをYYYY-MM-DD形式に変換
  }
  if (typeof orderDate === 'string' && orderDate.includes('T')) {
    // ISO形式の場合、最初の10文字を取得
    return orderDate.split('T')[0];
  }
  return orderDate;
};
```

### 修正履歴

1. **期間ボタンで表示が切り替わらない問題**: 締日期間の計算ロジックを修正
2. **注文履歴が表示されない問題**: データ取得範囲を「先月から来月」までに拡大
3. **「先月」ボタンを追加**: 順番を「先月」「今月」「来月」に変更
4. **先月・来月の期間計算が間違っている問題**: 期間計算を「開始月」基準から「終了月」基準に変更
5. **order_dateがDateオブジェクトの場合の問題**: 形式変換関数を修正してDateオブジェクトも正しく処理

---

## 2. 開発環境のロックファイル問題

### 問題

`npm run dev` を複数回実行すると、以下のエラーが発生：

```
⨯ Unable to acquire lock at C:\Users\kazu\my-app\.next\dev\lock, is another instance of next dev running?
```

### 原因

1. バックグラウンドで開発サーバーを起動している
2. 開発サーバーが正常に終了せずにロックファイルが残る
3. 次回起動時にロックファイルが存在するためエラーになる

### 解決策

#### 1. `copy-fonts.js` の修正

`predev` フックで実行される `copy-fonts.js` にロックファイル削除機能を追加：

```javascript
// scripts/copy-fonts.js

// ロックファイルを削除（存在する場合）
const lockFile = path.join(__dirname, '..', '.next', 'dev', 'lock');
if (fs.existsSync(lockFile)) {
  try {
    fs.unlinkSync(lockFile);
    console.log('Lock file removed');
  } catch (error) {
    // ロックファイルが使用中の場合は無視
  }
}

// pdfkitのフォントファイルをコピー（既存の処理）
// ...
```

#### 2. `kill-nextjs-quiet.ps1` スクリプトの作成

既存のNext.jsプロセスを終了するためのスクリプト：

```powershell
# scripts/kill-nextjs-quiet.ps1
# Node.jsプロセスを終了し、ロックファイルを削除
```

#### 3. 使用方法

**通常の開発サーバー起動:**
```bash
npm run dev
```

**ロックエラーが発生した場合:**
```bash
npm run kill-nextjs:quiet
npm run dev
```

または：
```powershell
Remove-Item .next\dev\lock -Force -ErrorAction SilentlyContinue
npm run dev
```

### 注意事項

- `predev-clean.js` を使用した自動クリーンアップは、npm プロセス自体を終了させる問題があるため使用しない
- ロックファイルが別のプロセスによって使用中の場合は削除できない
- その場合は、先にプロセスを終了してから再度 `npm run dev` を実行

---

## 3. DATABASE_URL 環境変数の設定

### 問題

注文履歴ページで `DATABASE_URL` 環境変数が未設定のためエラーが発生。

### 解決策

`.env.local` に `DATABASE_URL` を追加：

```
DATABASE_URL=postgresql://postgres:[YOUR-PASSWORD]@[HOST]:6543/postgres?pgbouncer=true
```

### IPv6 接続問題

**問題:**
Supabase データベースホストが IPv6 アドレスのみを返す場合、Node.js で DNS 解決に失敗する可能性がある。

**エラーメッセージ:**
```
getaddrinfo ENOTFOUND db.xxxxx.supabase.co
```

**解決策:**
Supabase Dashboard で「Session Pooler」の接続文字列を使用：

1. Supabase Dashboard にログイン
2. Project Settings → Database → Connection string
3. 「Session」タブを選択
4. 「Display connection pooler」をクリック
5. 接続文字列をコピー（ホスト名が `aws-0-ap-northeast-1.pooler.supabase.com` のような形式）

---

## 4. 関連する変更ファイル

### 新規作成

- `scripts/kill-nextjs-quiet.ps1` - Next.js プロセス終了スクリプト

### 修正

- `scripts/copy-fonts.js` - ロックファイル削除機能を追加
- `lib/database/pool.ts` - `DATABASE_URL` がオプショナルに（未設定時は `null` を返す）
- `lib/database/query.ts` - `DATABASE_URL` 未設定時のエラーハンドリング追加
- `app/(user)/orders/page.tsx` - 締日期間計算ロジックの修正
- `components/orders-history-client.tsx` - 期間切り替えUI、フィルタリングロジックの修正
- `package.json` - `kill-nextjs:quiet` スクリプトを追加

---

## 5. トラブルシューティング

### ロックファイルエラーが発生した場合

1. すべての Node.js プロセスを終了:
   ```powershell
   Get-Process | Where-Object {$_.ProcessName -eq "node"} | Stop-Process -Force
   ```

2. ロックファイルを削除:
   ```powershell
   Remove-Item .next\dev\lock -Force -ErrorAction SilentlyContinue
   ```

3. 開発サーバーを起動:
   ```bash
   npm run dev
   ```

### DATABASE_URL エラーが発生した場合

1. `.env.local` に `DATABASE_URL` が設定されているか確認
2. ポート 6543（Transaction connection）と `?pgbouncer=true` を使用
3. DNS 解決に失敗する場合は、Session Pooler の接続文字列を使用

### 開発サーバーが起動しない場合

1. ポート 3000 または 3001 が使用中か確認:
   ```powershell
   netstat -ano | Select-String ":300[0-9]" | Select-String "LISTENING"
   ```

2. 使用中のプロセスを終了してから再起動

---

最終更新日: 2026-01-11
