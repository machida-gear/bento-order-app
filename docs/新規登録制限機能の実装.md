# 新規登録制限機能の実装

このドキュメントでは、社員のみが新規登録できるようにする制限機能の実装について説明します。

> 📖 **関連ドキュメント**: [README.md](./README.md) - すべてのドキュメントへの参照

---

## 実装概要

### 実装日

2025-01-XX

### 実装内容

1. **招待コード方式**
   - 4桁の数字の招待コードを必須にする
   - 使用回数制限機能（1〜9999回、または無制限）
   - 招待コード変更時に使用回数を自動リセット

2. **社員コードマスター方式**
   - 事前に登録された社員コードのみ新規登録可能
   - 登録済みフラグで二重登録を防止
   - 管理者画面で社員コードマスターを管理可能

3. **招待コード管理専用ページ**
   - システム設定画面から分離して専用ページを作成
   - 招待コードの発行・管理を一元化

---

## データベースマイグレーション

### 1. 社員コードマスターテーブルの作成

**ファイル**: `supabase/migrations/059_add_employee_codes_and_invitation_code.sql`

- `employee_codes`テーブルを作成
  - `employee_code`: 社員コード（4桁、UNIQUE制約）
  - `full_name`: 氏名
  - `is_registered`: 登録済みフラグ
  - `registered_user_id`: 登録済みユーザーID（profiles.idを参照）
- RLSポリシーを設定（全ユーザーが参照可能、管理者のみCRUD可能）
- `system_settings`テーブルに`invitation_code`カラムを追加

### 2. 使用回数制限機能の追加

**ファイル**: `supabase/migrations/060_add_invitation_code_usage_limit.sql`

- `system_settings`テーブルに以下を追加:
  - `invitation_code_max_uses`: 最大使用回数（NULL=無制限）
  - `invitation_code_used_count`: 現在の使用回数

---

## 新規登録画面の更新

### 実装内容

**ファイル**: `app/(auth)/login/page.tsx`

- 招待コード入力欄を追加（4桁の数字のみ入力可能）
- バリデーションを追加（招待コードが必須）

### UI変更

- 招待コード入力欄を新規登録フォームの最初に配置
- 数字以外の入力を自動的に除外
- 最大4文字まで入力可能

---

## 新規登録APIの更新

### 実装内容

**ファイル**: `app/api/auth/signup/route.ts`

1. **招待コードのチェック**
   - システム設定から招待コードを取得
   - 入力された招待コードと一致するかチェック
   - 4桁の数字に正規化して比較

2. **使用回数制限のチェック**
   - 最大使用回数が設定されている場合、現在の使用回数が上限に達していないかチェック
   - 上限に達している場合は登録不可

3. **社員コードマスターのチェック**
   - マスターテーブルに存在するかチェック
   - 既に登録済み（`is_registered = true`）の場合は登録不可

4. **登録成功時の処理**
   - 社員コードマスターの`is_registered`フラグを`true`に更新
   - `registered_user_id`に登録されたユーザーIDを設定
   - 招待コードの使用回数をカウントアップ

---

## 招待コード管理専用ページ

### 実装内容

**ファイル**: `app/admin/invitation-code/page.tsx`

- 招待コードの設定（4桁の数字、自動生成機能付き）
- 最大使用回数の設定（制限あり/無制限）
- 現在の使用回数の表示
- 使用回数のリセット機能

### 機能詳細

1. **招待コードの設定**
   - 手動入力または「自動生成」ボタンで4桁の数字を生成
   - 空欄にすると新規登録ができなくなる

2. **使用回数制限の設定**
   - 「制限あり」を選択して1〜9999回を設定
   - 「無制限」を選択して使用回数制限なしに設定

3. **使用回数の管理**
   - 現在の使用回数を表示（例: `5 / 10`）
   - 「リセット」ボタンで使用回数を0にリセット
   - 招待コードを変更すると自動的に使用回数が0にリセットされる

### 使い方セクション

- 招待コードの発行手順
- 使用回数の管理方法
- 注意事項

---

## 招待コード管理API

### 実装内容

**ファイル**: `app/api/admin/invitation-code/route.ts`

- GET: 招待コード情報の取得
- PUT: 招待コードの更新
  - 招待コード変更時に使用回数を自動リセット
  - バリデーション（4桁の数字、最大使用回数1〜9999）
- 監査ログ記録を実装

---

## 社員コードマスター管理機能

### 実装内容

**ファイル**: `app/admin/employee-codes/page.tsx`

- 社員コードマスターの一覧表示
- 新規追加（社員コード、氏名）
- 編集機能（未登録のみ）
- 削除機能（未登録のみ）
- 登録済みフラグの表示
- 登録済みユーザー情報の表示

### 機能詳細

1. **一覧表示**
   - 社員コード、氏名、状態（登録済み/未登録）、登録済みユーザー情報を表示
   - 社員コード順にソート

2. **新規追加**
   - 社員コード（1〜4桁の数字）と氏名を入力
   - 社員コードは自動的に4桁にパディング（例: `1` → `0001`）
   - 重複チェックを実装

3. **編集・削除**
   - 未登録の社員コードのみ編集・削除可能
   - 登録済みの場合は編集・削除不可（データ整合性のため）

### 社員コードマスター管理API

**ファイル**: 
- `app/api/admin/employee-codes/route.ts` - 一覧取得、新規作成
- `app/api/admin/employee-codes/[id]/route.ts` - 更新、削除

- 監査ログ記録を実装
- 管理者権限チェックを実装

---

## システム設定画面の変更

### 変更内容

**ファイル**: `app/admin/settings/page.tsx`, `app/api/admin/settings/route.ts`

- 招待コード設定を削除（専用ページに移動）
- 招待コード関連の処理を削除

---

## ナビゲーションの更新

### 変更内容

**ファイル**: `components/admin-nav.tsx`

- 「招待コード管理」メニューを追加（社員コードマスターの下）
- 「社員コードマスター」メニューを追加（ユーザー管理の下）

---

## PDF生成時の監査ログ記録機能の修正

### 問題

- PDF生成時に監査ログが記録されない
- エラー: `TypeError: headers is not a function`

### 原因

- `headers()`関数の呼び出し方法が誤っていた
- Next.js 16では`request.headers`から直接取得する必要がある

### 解決策

**ファイル**: `app/api/admin/orders/today/pdf/route.ts`

- `headers()`関数の呼び出しを削除
- `request.headers`から直接IPアドレスを取得する方法に変更
- `doc.on('end')`の重複を削除

---

## 使用方法

### 初期設定（管理者）

1. **マイグレーションの実行**
   ```sql
   -- supabase/migrations/059_add_employee_codes_and_invitation_code.sql を実行
   -- supabase/migrations/060_add_invitation_code_usage_limit.sql を実行
   ```

2. **招待コードの発行**
   - `/admin/invitation-code`にアクセス
   - 「自動生成」ボタンをクリックして4桁の数字コードを生成
   - 最大使用回数を設定（制限あり/無制限）
   - 「設定を保存」ボタンをクリック

3. **社員コードマスターの登録**
   - `/admin/employee-codes`にアクセス
   - 社員コード（1〜4桁の数字）と氏名を入力
   - 「保存」ボタンをクリック

### 新規登録（社員）

1. ログイン画面で「アカウントをお持ちでない方はこちら」をクリック
2. 招待コードを入力（管理者から提供された4桁の数字）
3. 氏名、社員コード（4桁）、メールアドレス、パスワードを入力
4. 登録ボタンをクリック

---

## セキュリティ機能

### 二重チェック機能

1. **招待コードチェック**
   - システム設定で設定した招待コードと一致する場合のみ登録可能
   - 使用回数が上限に達している場合は登録不可

2. **社員コードマスターチェック**
   - マスターテーブルに存在し、未登録の社員コードのみ登録可能
   - 既に登録済みの社員コードは登録不可

### データ整合性

- 登録済みの社員コードは編集・削除不可
- 招待コード変更時に使用回数を自動リセット
- すべての操作を監査ログに記録

---

## 技術的な詳細

### 招待コードの正規化

- 入力された招待コードを4桁にパディング（例: `123` → `0123`）
- システム設定の招待コードも4桁に正規化して比較

### 使用回数の管理

- 新規登録成功時に`invitation_code_used_count`をカウントアップ
- 招待コード変更時に`invitation_code_used_count`を0にリセット
- 最大使用回数がNULLの場合は無制限として扱う

### エラーハンドリング

- 招待コードが設定されていない場合のエラーメッセージ
- 使用回数が上限に達している場合のエラーメッセージ
- 社員コードマスターに存在しない場合のエラーメッセージ

---

## 修正ファイル一覧

### データベースマイグレーション

- `supabase/migrations/059_add_employee_codes_and_invitation_code.sql`（新規作成）
- `supabase/migrations/060_add_invitation_code_usage_limit.sql`（新規作成）

### フロントエンド

- `app/(auth)/login/page.tsx`: 招待コード入力欄を追加
- `app/admin/invitation-code/page.tsx`（新規作成）: 招待コード管理専用ページ
- `app/admin/employee-codes/page.tsx`（新規作成）: 社員コードマスター管理画面
- `app/admin/settings/page.tsx`: 招待コード設定を削除
- `components/admin-nav.tsx`: メニューを追加

### バックエンド

- `app/api/auth/signup/route.ts`: 招待コードと社員コードマスターのチェックを実装
- `app/api/admin/invitation-code/route.ts`（新規作成）: 招待コード管理API
- `app/api/admin/employee-codes/route.ts`（新規作成）: 社員コードマスター管理API（一覧・作成）
- `app/api/admin/employee-codes/[id]/route.ts`（新規作成）: 社員コードマスター管理API（更新・削除）
- `app/api/admin/settings/route.ts`: 招待コード関連の処理を削除
- `app/api/admin/orders/today/pdf/route.ts`: 監査ログ記録のエラー修正

---

## 確認事項

- ✅ 招待コードが4桁の数字で生成される
- ✅ 使用回数制限が正しく機能する
- ✅ 社員コードマスターのチェックが正しく機能する
- ✅ 登録済みの社員コードは編集・削除不可
- ✅ 招待コード変更時に使用回数が自動リセットされる
- ✅ PDF生成時の監査ログが正しく記録される
- ✅ すべての操作が監査ログに記録される

---

## 注意事項

### マイグレーションの実行

以下のマイグレーションを実行する必要があります：

1. `supabase/migrations/059_add_employee_codes_and_invitation_code.sql`
2. `supabase/migrations/060_add_invitation_code_usage_limit.sql`

SupabaseダッシュボードのSQL EditorまたはSupabase CLIで実行してください。

### 初期データの投入

社員コードマスターに社員情報を登録する必要があります。管理者画面（`/admin/employee-codes`）から登録するか、SQLで一括登録してください。

---

## 関連ドキュメント

- [CHANGELOG.md](./CHANGELOG.md) - 変更履歴
- [PROGRESS.md](./PROGRESS.md) - プロジェクト進捗状況
- [SPEC.md](./SPEC.md) - システム仕様書
- [DECISIONS_new.md](./DECISIONS_new.md) - 設計上の重要な判断と理由
