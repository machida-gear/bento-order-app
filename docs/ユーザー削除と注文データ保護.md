# ユーザー削除と注文データ保護

## 問題の概要

既に注文があるユーザーを削除した場合、それまでに注文したデータが消えて、お弁当代をいくら徴収すればいいかわからなくなる可能性があります。

## 現在の実装

### 既存ユーザーの削除（`DELETE /api/admin/users/[id]`）

- **実装方式**: 論理削除（`is_active = false`、`left_date = 今日の日付`に設定）
- **注文データ**: 保持される（削除されない）
- **会計・集計への影響**: なし（注文データは残るため）
- **表示先**: 無効なユーザーリストに表示される（承認待ちリストには表示されない）

### 承認待ちユーザーの削除（`POST /api/admin/users/[id]/reject`）

- **実装方式**: 物理削除（注文データを削除してからユーザーを削除）
- **前提条件**: 承認待ちユーザーは注文データがない前提
- **会計・集計への影響**: なし（注文データがないため）

## データ保護の仕組み

### 1. 外部キー制約による保護

`orders`テーブルの`user_id`カラムは`profiles.id`を参照する際、`ON DELETE RESTRICT`制約が設定されています。

```sql
ALTER TABLE orders 
ADD CONSTRAINT orders_user_id_fkey 
FOREIGN KEY (user_id) REFERENCES profiles(id) ON DELETE RESTRICT;
```

**効果**:
- 注文データがあるユーザーは物理削除できません
- データベースレベルでデータ保護が行われます
- 誤って物理削除しようとすると、エラーが発生します

### 2. アプリケーションレベルでの保護

- 既存ユーザーの削除は論理削除（`is_active = false`）のみ
- 物理削除機能は提供していません（承認待ちユーザーを除く）
- 削除時に注文データの存在をチェックし、警告ログを出力

## 運用上の注意事項

### 退職者対応

退職者を無効化する場合は、以下の方法を使用してください：

1. **ユーザー管理画面から無効化**
   - ユーザー管理画面で「削除」ボタンをクリック
   - `is_active = false`に設定されます
   - 注文データは保持されます

2. **退職日の設定**
   - ユーザー編集画面で退職日を設定
   - 退職日が過去の場合、自動的に`is_active = false`になります

### 注文データの保持

- ユーザーを無効化しても、注文データは保持されます
- CSV出力やPDF出力では、無効化されたユーザーの注文も含まれます
- 集計データには、無効化されたユーザーの注文も含まれます

### 削除時の承認待ちリスト除外

ユーザーを削除（無効化）した際、承認待ちリストに表示されないようにするため、以下の処理を行います：

1. **削除時の`left_date`設定**
   - 削除時に`is_active = false`と`left_date = 今日の日付`を同時に設定
   - これにより、削除されたユーザーは無効なユーザーリストに表示される

2. **承認待ちAPIの条件**
   - 承認待ち条件: `is_active = false` かつ `left_date`が未設定または未来の日付（明日以降）
   - 今日の日付は承認待ちリストから除外される

3. **即時反映**
   - 削除後にフロントエンドで`fetchPendingUsers()`も呼び出す
   - 削除直後から承認待ちリストが正しく更新される

## 外部キー制約の確認・修正

### 現在の制約を確認する

```bash
# マイグレーションファイルを実行
psql -h <host> -U <user> -d <database> -f supabase/migrations/061_check_orders_user_id_fk_constraint.sql
```

### 制約を修正する

現在の制約が`ON DELETE CASCADE`の場合、以下のマイグレーションを実行して`ON DELETE RESTRICT`に変更してください：

```bash
# マイグレーションファイルを実行
psql -h <host> -U <user> -d <database> -f supabase/migrations/062_fix_orders_user_id_fk_to_restrict.sql
```

## まとめ

- ✅ **既存ユーザーの削除**: 論理削除のみ（`is_active = false`、`left_date = 今日の日付`）
- ✅ **注文データ**: 保持される（削除されない）
- ✅ **外部キー制約**: `ON DELETE RESTRICT`により物理削除を防止
- ✅ **会計・集計**: 影響なし（注文データは保持される）
- ✅ **承認待ちリスト**: 削除されたユーザーは承認待ちリストに表示されない（`left_date`が今日の日付のため）

**結論**: 既存の実装では、既に注文があるユーザーを削除しても注文データは消えません。会計・集計に問題はありません。また、削除されたユーザーは無効なユーザーリストにのみ表示され、承認待ちリストには表示されません。
