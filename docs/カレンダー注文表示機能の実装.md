# カレンダー注文表示機能の実装

## 実装日

2025-12-30

## 概要

カレンダー画面で注文済みの日にメニュー名と数量を表示し、締切時刻前であれば注文変更ができる機能を実装しました。

---

## 実装内容

### 1. 注文内容の表示機能

#### 要件

- 注文がある日は、カレンダーの日付セルに「注文可」ボタンではなく、注文内容（メニュー名、数量）を表示する
- 注文がない日のみ「注文可」ボタンを表示する

#### 実装

- `app/(user)/calendar/page.tsx`: 注文データとメニューデータを取得し、結合
- `components/calendar-grid.tsx`: 注文内容をカレンダーセルに表示

#### 技術的な課題と解決策

**問題 1: 型定義と実際の DB 構造の不一致**

- **問題**: 型定義ファイル（`lib/database.types.ts`）では`orders.menu_id`だが、実際の DB では`orders.menu_item_id`（bigint 型）
- **解決策**: 実際の DB カラム名`menu_item_id`でアクセスし、型アサーション（`as any`）を使用

**問題 2: bigint 型の処理**

- **問題**: `menu_item_id`と`menu_items.id`が`bigint`型で、JavaScript では文字列として扱われる可能性がある
- **解決策**: メニュー ID を文字列に変換してマップを作成し、比較時に文字列として扱う

**問題 3: メニューデータの結合**

- **問題**: Supabase の JOIN が正しく動作しない場合がある
- **解決策**: 注文データとメニューデータを別々に取得し、サーバー側で結合

---

### 2. 注文変更機能

#### 要件

- 注文締切時刻までは、注文を変更できる
- カレンダーの注文内容をクリックすると、注文編集画面に遷移する

#### 実装

- `app/api/orders/[id]/route.ts`: 注文更新 API（PUT メソッド）を追加
- `app/(user)/orders/[id]/edit/page.tsx`: 注文編集画面を作成
- `components/order-edit-form.tsx`: 注文編集フォームコンポーネントを作成
- `components/calendar-grid.tsx`: 注文内容をクリック可能にし、編集画面へのリンクを追加

#### 機能詳細

- 締切時刻前の注文は、メニュー名と数量を変更可能
- 締切時刻を過ぎた注文は、表示のみ（変更不可）
- 過去の日付の注文は変更不可

---

### 3. 同日の重複注文防止

#### 要件

- 同日に複数の注文はできない（異なるメニューでも 1 日 1 注文のみ）

#### 実装

- `app/api/orders/route.ts`: 注文作成時に、同日の既存注文をチェック
- 既存注文がある場合は、エラーメッセージを返し、カレンダーから変更するよう案内

---

## 修正したファイル

### 1. `app/(user)/calendar/page.tsx`

- 注文データとメニューデータを別々に取得
- サーバー側でデータを結合
- bigint 型の処理を改善
- デバッグログを追加

### 2. `components/calendar-grid.tsx`

- 注文内容（メニュー名、数量）を表示
- 注文がある場合は「注文可」ボタンを非表示
- 締切時刻前の注文はクリック可能にして編集画面にリンク
- デバッグログを追加

### 3. `app/api/orders/[id]/route.ts`

- 注文更新 API（PUT メソッド）を追加
- 締切時刻チェック
- メニューと数量の更新処理
- 監査ログ記録

### 4. `app/(user)/orders/[id]/edit/page.tsx`（新規作成）

- 注文編集画面
- 既存の注文情報を表示
- 締切時刻チェック

### 5. `components/order-edit-form.tsx`（新規作成）

- 注文編集フォームコンポーネント
- メニュー選択と数量入力
- 変更内容のバリデーション

### 6. `app/api/orders/route.ts`

- 同日の既存注文チェックを追加
- エラーメッセージの改善

---

## データベース構造の注意事項

### 実際の DB 構造と型定義の違い

| 項目       | 型定義    | 実際の DB       |
| ---------- | --------- | --------------- |
| テーブル名 | -         | `orders`        |
| カラム名   | `menu_id` | `menu_item_id`  |
| データ型   | `number`  | `bigint` (int8) |

### 対応方法

- 実際の DB カラム名`menu_item_id`でアクセス
- bigint 型は文字列として扱い、比較時に適切に変換
- 型アサーション（`as any`）を使用して型エラーを回避

---

## デバッグログ

以下のデバッグログを追加して、データ取得と結合の状況を確認できるようにしました：

1. **注文データの取得状況**

   - 生データの構造
   - カラム名の確認

2. **メニューデータの取得状況**

   - メニュー ID のリスト
   - 取得したメニューデータの数
   - サンプルデータ

3. **データ結合の確認**

   - 結合後の注文データ
   - メニュー情報の有無

4. **カレンダーコンポーネントでの確認**
   - 各日付の注文データ
   - メニュー情報の有無

---

## 動作確認

### 確認項目

- [x] 注文がある日にメニュー名と数量が表示される
- [x] 注文がある日は「注文可」ボタンが表示されない
- [x] 締切時刻前の注文はクリック可能で編集画面に遷移する
- [x] 締切時刻を過ぎた注文は表示のみ（変更不可）
- [x] 同日の重複注文はエラーになる
- [x] 異なるメニューでも同日に複数注文できない

### トラブルシューティング

**問題: メニュー名と数量が表示されない**

- ブラウザのコンソールでデバッグログを確認
- 注文データが正しく取得できているか確認
- メニューデータが正しく結合されているか確認
- `menu_item_id`が正しく取得できているか確認

---

## 今後の改善点

1. **型定義ファイルの更新**

   - `lib/database.types.ts`を実際の DB 構造に合わせて更新
   - `menu_id` → `menu_item_id`に修正
   - `bigint`型を適切に定義

2. **パフォーマンスの最適化**

   - メニューデータの取得を最適化
   - キャッシュの活用

3. **エラーハンドリングの改善**
   - ユーザーフレンドリーなエラーメッセージ
   - エラー時のリトライ機能

---

## 参考

- [実際のデータベーススキーマ.md](./実際のデータベーススキーマ.md)
- [データベース構造の注意事項.md](./データベース構造の注意事項.md)
- [注文機能の実装と問題解決.md](./注文機能の実装と問題解決.md)

---

最終更新日: 2025-12-30
