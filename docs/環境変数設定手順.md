# 環境変数設定手順

このドキュメントでは、システムで使用する環境変数の設定方法を説明します。

> 📖 **関連ドキュメント**: [README.md](./README.md) - すべてのドキュメントへの参照

---

## 必須の環境変数

### Supabase 関連

- `NEXT_PUBLIC_SUPABASE_URL`: Supabase プロジェクトの URL
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`: Supabase の匿名キー
- `SUPABASE_SERVICE_ROLE_KEY`: Supabase のサービスロールキー（管理者権限）

### 自動注文機能関連

- `AUTO_ORDER_SECRET`: 自動注文実行 API の認証用シークレット
  - **文字数**: 制限なし（推奨は64文字程度）
  - **開発環境**: 簡単な文字列でも可（例: `dev-secret-key-12345`）
  - **本番環境**: 推測されにくいランダムな文字列を推奨
  - **設定方法**: 好きな文字列を設定可能（オンラインツールで生成することも可能）

---

## オプションの環境変数

### PDF 生成関連（フォールバック）

**重要**: PDF生成関連の環境変数は**設定不要**です。システム設定画面（`/admin/settings`）から会社情報を設定することを推奨します。

会社情報が`system_settings`テーブルに設定されていない場合のフォールバックとして使用されます。

- `PDF_SENDER_COMPANY`: 送信者会社名（例: `●●●●株式会社`）
- `PDF_SENDER_POSTAL_CODE`: 送信者郵便番号（例: `〒100-0000`）
- `PDF_SENDER_ADDRESS`: 送信者住所（例: `住所:東京都千代田区0-1-2●●ビル 1F`）
- `PDF_SENDER_PHONE`: 送信者電話番号（例: `電話: 00-0000-0000`）
- `PDF_SENDER_FAX`: 送信者FAX番号（例: `FAX: 00-0000-0000`）

**推奨設定方法**: システム設定画面（`/admin/settings`）から会社情報を設定してください。環境変数は、システム設定に値がない場合のフォールバックとしてのみ使用されます。

---

## 1. AUTO_ORDER_SECRET の生成

`AUTO_ORDER_SECRET`は、自動注文実行APIの認証用シークレットです。

### 設定方法

**重要**: 文字数に制限はありません。好きな文字列を設定できます。

#### 開発環境の場合

開発環境のみなら、簡単な文字列でも問題ありません：

```env
AUTO_ORDER_SECRET=dev-secret-key-12345
```

#### 本番環境の場合（推奨）

本番環境では、推測されにくいランダムな文字列を推奨します（推奨は64文字程度）。

##### 方法1: オンラインツールを使用（最も簡単）

- https://www.random.org/strings/ にアクセス
- 「Generate random strings」で以下を設定：
  - Length: 64
  - Character set: Alphanumeric (A-Z, a-z, 0-9)
- 生成された文字列をコピー

##### 方法2: PowerShellで生成（Windows）

```powershell
# PowerShellで実行
-join ((48..57) + (65..90) + (97..122) | Get-Random -Count 64 | ForEach-Object {[char]$_})
```

##### 方法3: opensslで生成（Mac/Linux）

```bash
# opensslがインストールされている場合
openssl rand -hex 32

# または、/dev/urandomを使用
cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 64 | head -n 1
```

生成された文字列をコピーしておいてください（例: `a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6`）

### 注意事項

- 文字数に制限はありません（推奨は64文字程度）
- 好きな文字列を設定できます
- 開発環境なら短い文字列でも問題ありません
- 本番環境では推測されにくいランダムな文字列を推奨します

---

## 2. Vercel での環境変数設定

### 手順

1. **Vercel ダッシュボードにログイン**

   - https://vercel.com にアクセス
   - アカウントにログイン

2. **プロジェクトを選択**

   - ダッシュボードから該当プロジェクトをクリック

3. **Settings（設定）を開く**

   - プロジェクトページの上部タブから「Settings」をクリック

4. **Environment Variables（環境変数）を開く**

   - 左側のメニューから「Environment Variables」をクリック

5. **新しい環境変数を追加**

   - 「Add New」ボタンをクリック
   - 以下の情報を入力：
     - **Key（キー）**: 環境変数名（例: `AUTO_ORDER_SECRET`）
     - **Value（値）**: 環境変数の値
     - **Environment（環境）**:
       - ✅ Production（本番環境）
       - ✅ Preview（プレビュー環境）
       - ✅ Development（開発環境）
       - すべてにチェックを入れることを推奨

   **必須の環境変数:**

   - `NEXT_PUBLIC_SUPABASE_URL`
   - `NEXT_PUBLIC_SUPABASE_ANON_KEY`
   - `SUPABASE_SERVICE_ROLE_KEY`
   - `AUTO_ORDER_SECRET`（自動注文機能を使用する場合）

   **オプションの環境変数（PDF 生成用）:**

   - `PDF_SENDER_COMPANY`
   - `PDF_SENDER_POSTAL_CODE`
   - `PDF_SENDER_ADDRESS`
   - `PDF_SENDER_PHONE`

6. **保存**

   - 「Save」ボタンをクリック

7. **再デプロイ**
   - 環境変数を追加・変更した後は、再デプロイが必要です
   - 「Deployments」タブから最新のデプロイメントを選択
   - 「Redeploy」ボタンをクリック

### スクリーンショットの参考

Vercel の環境変数設定画面では、以下のような表示になります：

```
┌─────────────────────────────────────────┐
│ Environment Variables                    │
├─────────────────────────────────────────┤
│ Key                    Value             │
│ AUTO_ORDER_SECRET     [hidden]          │
│                                       │
│ [Add New]                              │
└─────────────────────────────────────────┘
```

---

## 3. ローカル開発環境での設定

開発環境でも動作確認できるように、ローカルで環境変数を設定します。

### 3-1. `.env.local`ファイルの作成（ステップバイステップ）

#### 方法1: PowerShellでコピー（推奨）

プロジェクトのルートディレクトリ（`C:\Users\kazu\my-app\`など）で、以下のコマンドを実行：

```powershell
Copy-Item env.example .env.local
```

#### 方法2: 手動で作成

1. プロジェクトのルートディレクトリを開く
2. `env.example`ファイルをコピーして`.env.local`という名前で保存
3. または、新しいファイルを作成して`.env.local`という名前で保存

### 3-2. Supabaseの値を取得

1. **Supabase Dashboardにアクセス**
   - ブラウザで https://supabase.com にアクセス
   - ログイン
   - プロジェクトを選択

2. **環境変数の値を取得**
   - 左メニューの「Project Settings」（歯車アイコン）をクリック
   - 「API」をクリック
   - 以下の値を確認：
     - **Project URL** → `NEXT_PUBLIC_SUPABASE_URL`に使用
     - **anon public** → `NEXT_PUBLIC_SUPABASE_ANON_KEY`に使用
     - **service_role（Secret）** → `SUPABASE_SERVICE_ROLE_KEY`に使用（「Reveal」ボタンで表示）

### 3-3. `.env.local`ファイルに値を設定

`.env.local`ファイルを開き、以下のように実際の値を設定します：

```env
# Supabase 設定
# Supabase Dashboard > Project Settings > API から取得

# Project URL（例: https://abcdefghijklmnop.supabase.co）
NEXT_PUBLIC_SUPABASE_URL=https://あなたのプロジェクトID.supabase.co

# anon public key（クライアントサイドで使用可能）
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFiY2RlZmdoaWprbG1ub3AiLCJyb2xlIjoiYW5vbiIsImlhdCI6MTYxNjIzOTAyMiwiZXhwIjoxOTMxODE1MDIyfQ.xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

# service_role key（サーバーサイドのみ、絶対にクライアントに公開しないこと）
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFiY2RlZmdoaWprbG1ub3AiLCJyb2xlIjoic2VydmljZV9yb2xlIiwiaWF0IjoxNjE2MjM5MDIyLCJleHAiOjE5MzE4MTUwMjJ9.xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

# 自動注文実行APIの認証用シークレット（ランダムな文字列を設定）
# 例: 1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef
AUTO_ORDER_SECRET=あなたのランダムな文字列

# PDF生成用の送信者情報（オプション）
# データベースのcompany_settingsテーブルに値がない場合のフォールバックとして使用
# PDF_SENDER_COMPANY=株式会社サンプル
# PDF_SENDER_POSTAL_CODE=〒100-0000
# PDF_SENDER_ADDRESS=住所:東京都千代田区0-1-2サンプルビル 1F
# PDF_SENDER_PHONE=電話: 00-0000-0000
# PDF_SENDER_FAX=FAX: 00-0000-0000
```

#### 重要ポイント

- `#`で始まる行はコメント（無視されます）
- `=`の前後にスペースを入れない
- 値にスペースが含まれる場合は、そのまま記述（通常は不要）
- `SUPABASE_SERVICE_ROLE_KEY`の行の先頭の`#`を削除して有効化
- `AUTO_ORDER_SECRET`の行の先頭の`#`を削除して有効化
- **プレースホルダー値（`your-project-id`、`your-anon-key`など）を実際の値に置き換えること**

### 3-4. AUTO_ORDER_SECRETの生成（オプション）

ランダムな文字列が必要な場合：

#### 方法A: PowerShellで生成

PowerShellで以下を実行：

```powershell
-join ((48..57) + (65..90) + (97..122) | Get-Random -Count 64 | ForEach-Object {[char]$_})
```

#### 方法B: オンラインツールを使用

- https://www.random.org/strings/ などで64文字のランダム文字列を生成

#### 方法C: 簡単な文字列を使用（開発環境のみ）

開発環境のみなら、簡単な文字列でも可（例: `dev-secret-key-12345`）

### 3-5. ファイルを保存

1. ファイルを保存（Ctrl + S）
2. エディタを閉じる

### 3-6. 開発サーバーを再起動

`.env.local` を変更した後は、開発サーバーを再起動してください：

```bash
# 開発サーバーを停止（Ctrl+C）
# その後、再起動
npm run dev
```

### 3-7. 設定の確認

開発サーバー起動時に、以下のように表示されれば環境変数が読み込まれています：

```
- Environments: .env.local
```

### 注意事項

- `.env.local` ファイルは `.gitignore` に含まれているため、Git にコミットされません
- このファイルには機密情報が含まれるため、**絶対に Git にコミットしないでください**
- プレースホルダー値（`your-project-id`など）のままでは動作しません。必ず実際のSupabaseプロジェクトの値に置き換えてください

---

## 4. 動作確認

### 手動で自動注文 API をテストする

ローカル環境で動作確認する場合：

```bash
# ターミナルで実行（PowerShellまたはコマンドプロンプト）
curl -X POST http://localhost:3000/api/auto-order/run \
  -H "Authorization: Bearer あなたが設定したAUTO_ORDER_SECRETの値"
```

または、ブラウザの開発者ツールのコンソールで：

```javascript
fetch("/api/auto-order/run", {
  method: "POST",
  headers: {
    Authorization: "Bearer あなたが設定したAUTO_ORDER_SECRETの値",
  },
})
  .then((res) => res.json())
  .then((data) => console.log(data));
```

### 本番環境での確認

Vercel にデプロイ後、以下のコマンドで確認できます：

```bash
curl -X POST https://あなたのドメイン.vercel.app/api/auto-order/run \
  -H "Authorization: Bearer あなたが設定したAUTO_ORDER_SECRETの値"
```

---

## 5. 使用されている環境変数の完全なリスト

コードベース全体で使用されている環境変数の一覧：

### 必須環境変数

1. **`NEXT_PUBLIC_SUPABASE_URL`**
   - 使用箇所: `lib/supabase/client.ts`, `lib/supabase/server.ts`, `lib/supabase/middleware.ts`, `lib/supabase/admin.ts`
   - 説明: SupabaseプロジェクトのURL

2. **`NEXT_PUBLIC_SUPABASE_ANON_KEY`**
   - 使用箇所: `lib/supabase/client.ts`, `lib/supabase/server.ts`, `lib/supabase/middleware.ts`
   - 説明: Supabaseの匿名キー（クライアントサイドで使用可能）

3. **`SUPABASE_SERVICE_ROLE_KEY`**
   - 使用箇所: `lib/supabase/admin.ts`
   - 説明: Supabaseのサービスロールキー（サーバーサイドのみ、管理者権限）

4. **`AUTO_ORDER_SECRET`**
   - 使用箇所: `app/api/auto-order/run/route.ts`, `app/api/admin/users/deactivate-expired/route.ts`
   - 説明: 自動注文実行APIの認証用シークレット

### オプション環境変数（PDF生成用フォールバック）

5. **`PDF_SENDER_COMPANY`**
   - 使用箇所: `app/api/admin/orders/today/pdf/route.ts`
   - 説明: PDF送信者の会社名（`system_settings`テーブルに値がない場合のフォールバック）

6. **`PDF_SENDER_POSTAL_CODE`**
   - 使用箇所: `app/api/admin/orders/today/pdf/route.ts`
   - 説明: PDF送信者の郵便番号（フォールバック）

7. **`PDF_SENDER_ADDRESS`**
   - 使用箇所: `app/api/admin/orders/today/pdf/route.ts`
   - 説明: PDF送信者の住所（フォールバック）

8. **`PDF_SENDER_PHONE`**
   - 使用箇所: `app/api/admin/orders/today/pdf/route.ts`
   - 説明: PDF送信者の電話番号（フォールバック）

9. **`PDF_SENDER_FAX`**
   - 使用箇所: `app/api/admin/orders/today/pdf/route.ts`
   - 説明: PDF送信者のFAX番号（フォールバック）

### 注意事項

- `PDFKIT_FONT_DATA_PATH`はコード内で動的に設定されるため、Vercelで設定不要です
- PDF関連の環境変数は、データベースの`system_settings`テーブルに値がない場合のフォールバックとして使用されます

---

## 6. トラブルシューティング

### 環境変数が読み込まれない場合

1. **再デプロイを確認**

   - Vercel で環境変数を追加・変更した後は、必ず再デプロイしてください

2. **環境変数の名前を確認**

   - 環境変数名が正しく設定されているか確認（大文字・小文字を区別します）
   - Vercelの環境変数設定画面で、キー名が完全一致しているか確認

3. **ログを確認**
   - Vercel の「Deployments」タブから、デプロイメントのログを確認
   - エラーメッセージがないか確認

4. **ローカル開発環境の場合**
   - `.env.local`ファイルがプロジェクトのルートディレクトリに存在するか確認
   - ファイル名が`.env.local`であることを確認（先頭の`.`を含む）
   - 開発サーバーを再起動（`.env.local`を変更した後は必須）

### ログインできない場合（「Failed to fetch」エラー）

1. **環境変数の値がプレースホルダーのままになっていないか確認**

   - `.env.local`ファイルを開いて、`NEXT_PUBLIC_SUPABASE_URL`の値を確認
   - `your-project-id.supabase.co`のままになっている場合は、実際のSupabaseプロジェクトのURLに置き換える

2. **Supabase Dashboardから値を取得**

   - Supabase Dashboard > Project Settings > API から正しい値を取得
   - Project URLとanon public keyをコピーして`.env.local`に設定

3. **開発サーバーを再起動**

   - `.env.local`を変更した後は、必ず開発サーバーを再起動してください

4. **ブラウザのコンソールでエラーを確認**

   - ブラウザの開発者ツール（F12）を開く
   - Consoleタブでエラーメッセージを確認
   - `net::ERR_NAME_NOT_RESOLVED`エラーが出ている場合は、URLが正しく設定されていない可能性があります

### 認証エラーが発生する場合

- `AUTO_ORDER_SECRET` の値が正しく設定されているか確認
- API 呼び出し時の `Authorization` ヘッダーが正しいか確認
- 環境変数が正しい環境（Production/Preview/Development）に設定されているか確認

### ファイルが見つからない場合

- ファイル名が`.env.local`であることを確認（先頭の`.`を含む）
- プロジェクトのルートディレクトリ（`package.json`がある場所）に作成されているか確認
- `.gitignore`で除外されているため、エクスプローラーで「隠しファイルを表示」する設定が必要な場合があります

---

## 7. セキュリティに関する注意事項

- `AUTO_ORDER_SECRET` は機密情報です。**絶対に公開しないでください**
- GitHub などの公開リポジトリにコミットしないでください
- チームメンバーと共有する場合は、安全な方法（例: 1Password、LastPass）を使用してください
- 定期的にシークレットを更新することを推奨します

---

## 8. 参考リンク

- [Vercel 環境変数のドキュメント](https://vercel.com/docs/concepts/projects/environment-variables)
- [Next.js 環境変数のドキュメント](https://nextjs.org/docs/app/building-your-application/configuring/environment-variables)
