# 環境変数設定手順

このドキュメントでは、システムで使用する環境変数の設定方法を説明します。

> 📖 **関連ドキュメント**: [README.md](./README.md) - すべてのドキュメントへの参照

---

## 必須の環境変数

### Supabase 関連

- `NEXT_PUBLIC_SUPABASE_URL`: Supabase プロジェクトの URL
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`: Supabase の匿名キー
- `SUPABASE_SERVICE_ROLE_KEY`: Supabase のサービスロールキー（管理者権限）

### 自動注文機能関連

- `AUTO_ORDER_SECRET`: 自動注文実行 API の認証用シークレット

---

## オプションの環境変数

### PDF 生成関連（フォールバック）

会社情報が`system_settings`テーブルに設定されていない場合のフォールバックとして使用されます。

- `PDF_SENDER_COMPANY`: 送信者会社名（例: `●●●●株式会社`）
- `PDF_SENDER_POSTAL_CODE`: 送信者郵便番号（例: `〒100-0000`）
- `PDF_SENDER_ADDRESS`: 送信者住所（例: `住所:東京都千代田区0-1-2●●ビル 1F`）
- `PDF_SENDER_PHONE`: 送信者電話番号（例: `電話: 00-0000-0000`）

**注意**: 会社情報はシステム設定画面（`/admin/settings`）から設定することを推奨します。環境変数はフォールバックとして使用されます。

---

## 1. AUTO_ORDER_SECRET の生成

まず、ランダムな文字列を生成します。

### Windows（PowerShell）の場合

```powershell
# PowerShellで実行
-join ((48..57) + (65..90) + (97..122) | Get-Random -Count 64 | ForEach-Object {[char]$_})
```

または、オンラインツールを使用：

- https://www.random.org/strings/ で「64 文字のランダム文字列」を生成

### Mac/Linux の場合

```bash
# opensslがインストールされている場合
openssl rand -hex 32

# または、/dev/urandomを使用
cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 64 | head -n 1
```

生成された文字列をコピーしておいてください（例: `a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6`）

---

## 2. Vercel での環境変数設定

### 手順

1. **Vercel ダッシュボードにログイン**

   - https://vercel.com にアクセス
   - アカウントにログイン

2. **プロジェクトを選択**

   - ダッシュボードから該当プロジェクトをクリック

3. **Settings（設定）を開く**

   - プロジェクトページの上部タブから「Settings」をクリック

4. **Environment Variables（環境変数）を開く**

   - 左側のメニューから「Environment Variables」をクリック

5. **新しい環境変数を追加**

   - 「Add New」ボタンをクリック
   - 以下の情報を入力：
     - **Key（キー）**: 環境変数名（例: `AUTO_ORDER_SECRET`）
     - **Value（値）**: 環境変数の値
     - **Environment（環境）**:
       - ✅ Production（本番環境）
       - ✅ Preview（プレビュー環境）
       - ✅ Development（開発環境）
       - すべてにチェックを入れることを推奨

   **必須の環境変数:**

   - `NEXT_PUBLIC_SUPABASE_URL`
   - `NEXT_PUBLIC_SUPABASE_ANON_KEY`
   - `SUPABASE_SERVICE_ROLE_KEY`
   - `AUTO_ORDER_SECRET`（自動注文機能を使用する場合）

   **オプションの環境変数（PDF 生成用）:**

   - `PDF_SENDER_COMPANY`
   - `PDF_SENDER_POSTAL_CODE`
   - `PDF_SENDER_ADDRESS`
   - `PDF_SENDER_PHONE`

6. **保存**

   - 「Save」ボタンをクリック

7. **再デプロイ**
   - 環境変数を追加・変更した後は、再デプロイが必要です
   - 「Deployments」タブから最新のデプロイメントを選択
   - 「Redeploy」ボタンをクリック

### スクリーンショットの参考

Vercel の環境変数設定画面では、以下のような表示になります：

```
┌─────────────────────────────────────────┐
│ Environment Variables                    │
├─────────────────────────────────────────┤
│ Key                    Value             │
│ AUTO_ORDER_SECRET     [hidden]          │
│                                       │
│ [Add New]                              │
└─────────────────────────────────────────┘
```

---

## 3. ローカル開発環境での設定

開発環境でも動作確認できるように、ローカルで環境変数を設定します。

### 手順

1. **プロジェクトのルートディレクトリに `.env.local` ファイルを作成**

   - 既に存在する場合は編集

2. **以下の内容を追加**

```env
# Supabase関連（必須）
NEXT_PUBLIC_SUPABASE_URL=your-supabase-url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key

# 自動注文実行APIの認証用シークレット（必須、自動注文機能を使用する場合）
AUTO_ORDER_SECRET=ここに生成したランダムな文字列を貼り付け

# PDF生成関連（オプション、会社情報のフォールバック）
PDF_SENDER_COMPANY=●●●●株式会社
PDF_SENDER_POSTAL_CODE=〒100-0000
PDF_SENDER_ADDRESS=住所:東京都千代田区0-1-2●●ビル 1F
PDF_SENDER_PHONE=電話: 00-0000-0000
```

例：

```env
AUTO_ORDER_SECRET=a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6
```

3. **開発サーバーを再起動**
   - `.env.local` を変更した後は、開発サーバーを再起動してください

```bash
# 開発サーバーを停止（Ctrl+C）
# その後、再起動
npm run dev
```

### 注意事項

- `.env.local` ファイルは `.gitignore` に含まれているため、Git にコミットされません
- このファイルには機密情報が含まれるため、**絶対に Git にコミットしないでください**

---

## 4. 動作確認

### 手動で自動注文 API をテストする

ローカル環境で動作確認する場合：

```bash
# ターミナルで実行（PowerShellまたはコマンドプロンプト）
curl -X POST http://localhost:3000/api/auto-order/run \
  -H "Authorization: Bearer あなたが設定したAUTO_ORDER_SECRETの値"
```

または、ブラウザの開発者ツールのコンソールで：

```javascript
fetch("/api/auto-order/run", {
  method: "POST",
  headers: {
    Authorization: "Bearer あなたが設定したAUTO_ORDER_SECRETの値",
  },
})
  .then((res) => res.json())
  .then((data) => console.log(data));
```

### 本番環境での確認

Vercel にデプロイ後、以下のコマンドで確認できます：

```bash
curl -X POST https://あなたのドメイン.vercel.app/api/auto-order/run \
  -H "Authorization: Bearer あなたが設定したAUTO_ORDER_SECRETの値"
```

---

## 5. トラブルシューティング

### 環境変数が読み込まれない場合

1. **再デプロイを確認**

   - Vercel で環境変数を追加・変更した後は、必ず再デプロイしてください

2. **環境変数の名前を確認**

   - `AUTO_ORDER_SECRET` が正しく設定されているか確認
   - 大文字・小文字を区別します

3. **ログを確認**
   - Vercel の「Deployments」タブから、デプロイメントのログを確認
   - エラーメッセージがないか確認

### 認証エラーが発生する場合

- `AUTO_ORDER_SECRET` の値が正しく設定されているか確認
- API 呼び出し時の `Authorization` ヘッダーが正しいか確認
- 環境変数が正しい環境（Production/Preview/Development）に設定されているか確認

---

## 6. セキュリティに関する注意事項

- `AUTO_ORDER_SECRET` は機密情報です。**絶対に公開しないでください**
- GitHub などの公開リポジトリにコミットしないでください
- チームメンバーと共有する場合は、安全な方法（例: 1Password、LastPass）を使用してください
- 定期的にシークレットを更新することを推奨します

---

## 7. 参考リンク

- [Vercel 環境変数のドキュメント](https://vercel.com/docs/concepts/projects/environment-variables)
- [Next.js 環境変数のドキュメント](https://nextjs.org/docs/app/building-your-application/configuring/environment-variables)
