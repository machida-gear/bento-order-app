# データベーススキーマに基づくコード修正

このドキュメントでは、実際のデータベーススキーマを確認し、コードベース全体を修正した内容を記録します。

## 実施日

2025-12-30

---

## 背景

実際の Supabase データベースのスキーマを確認したところ、初期スキーマ（`001_initial_schema.sql`）と実際のテーブル構造に違いがあることが判明しました。このため、コードベース全体を見直し、実際のスキーマに合わせて修正を行いました。

---

## 確認したテーブル定義

13 個のテーブルのスキーマを確認しました。詳細は`docs/実際のデータベーススキーマ.md`を参照してください。

### 主な違い

1. **テーブル名の違い**

   - `users_profile` → `profiles`
   - `menus` → `menu_items`
   - `order_days` → `order_calendar`
   - `operation_logs` → `audit_logs`
   - `auto_order_settings` → `auto_order_configs`

2. **カラム名の違い**

   - `profiles.name` → `profiles.full_name`
   - `order_calendar.date` → `order_calendar.target_date`
   - `order_calendar.special_note` → `order_calendar.note`
   - `menu_prices.menu_id` → `menu_prices.menu_item_id`
   - `orders.menu_id` → `orders.menu_item_id`
   - `audit_logs.actor_user_id` → `audit_logs.actor_id`
   - `audit_logs.detail` → `audit_logs.details`

3. **追加カラム**
   - `orders.unit_price_snapshot` - 注文時の単価スナップショット（NULL 不可）
   - `orders.source` - 注文ソース（NULL 不可、ENUM 型）
   - `audit_logs.target_table` - 対象テーブル名
   - `audit_logs.target_id` - 対象レコード ID
   - `audit_logs.ip_address` - IP アドレス

---

## 実施した修正

### 1. `orders`テーブルのカラム名修正

**問題**: `orders`テーブルへの INSERT 時に`menu_id`カラムを使用していたが、実際のテーブルでは`menu_item_id`を使用している

**修正内容**:

- `app/api/orders/route.ts`: `menu_id` → `menu_item_id`に変更

```typescript
// 修正前
.insert({
  menu_id: menu_id,
  // ...
})

// 修正後
.insert({
  menu_item_id: menu_id,  // 実際のDBではmenu_item_idカラム名を使用
  // ...
})
```

### 2. `orders`テーブルへの必須カラム追加

**問題**: `orders`テーブルには`unit_price_snapshot`と`source`カラムが必須（NULL 不可）だが、INSERT 時に設定していなかった

**修正内容**:

- `app/api/orders/route.ts`: 価格情報を取得して`unit_price_snapshot`を設定、`source`を'manual'に設定

```typescript
// 価格情報を取得（unit_price_snapshot用）
const { data: priceInfo, error: priceInfoError } = await supabaseAdmin
  .from("menu_prices")
  .select("price")
  .eq("id", menu_price_id)
  .single()

  // INSERT時にunit_price_snapshotとsourceを追加
  .insert({
    // ...
    unit_price_snapshot: priceInfo.price, // 注文時の単価スナップショット
    source: "manual", // 手動注文の場合は'manual'
  });
```

**注意事項**: `source`の ENUM 値（`order_source`型）については、実際の ENUM 定義を確認する必要があります。'manual'以外の値が必要な場合は、適宜修正してください。

### 3. `audit_logs`テーブルのカラム名修正

**問題**: `audit_logs`テーブルへの INSERT 時に`actor_user_id`と`detail`カラムを使用していたが、実際のテーブルでは`actor_id`と`details`を使用している

**修正内容**:

- `app/api/orders/route.ts`: `actor_user_id` → `actor_id`、`detail` → `details`に変更
- `app/api/orders/[id]/route.ts`: 同様の修正
- `target_table`と`target_id`カラムも追加

```typescript
// 修正前
await supabaseAdmin.from("audit_logs").insert({
  actor_user_id: user.id,
  action: "order.create",
  detail: {
    /* ... */
  },
});

// 修正後
await supabaseAdmin.from("audit_logs").insert({
  actor_id: user.id, // actor_user_idではなくactor_id
  action: "order.create",
  details: {
    /* ... */
  }, // detailではなくdetails
  target_table: "orders",
  target_id: orderData.id.toString(),
});
```

### 4. エラーハンドリングの修正

**問題**: Supabase クライアントの`.insert()`メソッドに対して`.catch()`を直接チェーンしていたが、これは機能しない

**修正内容**:

- `app/api/orders/route.ts`: `.catch()`を try-catch ブロックに変更
- `app/api/orders/[id]/route.ts`: 同様の修正

```typescript
// 修正前
await supabaseAdmin
  .from("audit_logs")
  .insert({
    /* ... */
  })
  .catch((err) => {
    console.error("Audit log insert error:", err);
  });

// 修正後
try {
  await supabaseAdmin.from("audit_logs").insert({
    /* ... */
  });
} catch (auditLogError) {
  // 監査ログの記録エラーは無視（注文は成功しているため）
  console.error("Audit log insert error:", auditLogError);
}
```

---

## 修正したファイル一覧

1. **`app/api/orders/route.ts`**

   - `menu_item_id`カラム名の使用
   - `unit_price_snapshot`と`source`カラムの追加
   - `actor_id`と`details`カラム名の使用
   - `target_table`と`target_id`カラムの追加
   - エラーハンドリングの修正（try-catch ブロック）

2. **`app/api/orders/[id]/route.ts`**

   - `actor_id`と`details`カラム名の使用
   - `target_table`と`target_id`カラムの追加
   - エラーハンドリングの修正（try-catch ブロック）

3. **`docs/実際のデータベーススキーマ.md`**（新規作成）

   - 13 個のテーブルの詳細なスキーマ定義を記録

4. **`docs/データベース構造の注意事項.md`**

   - 新しいスキーマドキュメントへの参照を追加

5. **`docs/CHANGELOG.md`**
   - 修正内容を記録

---

## 動作確認結果

- ✅ 注文が正常に登録されることを確認
- ✅ 監査ログが正しく記録されることを確認
- ✅ エラーが発生しなくなったことを確認

---

## 今後の注意事項

### 1. 型定義ファイルの更新

`lib/database.types.ts`は古い可能性があります。実際のデータベース構造に合わせて更新することを推奨します。

### 2. `source`カラムの ENUM 値

`orders.source`カラムは`order_source`型（ENUM）ですが、実際の ENUM 値を確認する必要があります。現在は'manual'を設定していますが、他の値が必要な場合は適宜修正してください。

### 3. 他のテーブルへの影響

他のテーブル（`auto_order_templates`など）でも`menu_id`カラムを使用している箇所がある場合、それらも確認する必要があります。

---

## 参考

- [実際のデータベーススキーマ.md](./実際のデータベーススキーマ.md)
- [データベース構造の注意事項.md](./データベース構造の注意事項.md)
- [注文機能の実装と問題解決.md](./注文機能の実装と問題解決.md)

---

最終更新日: 2025-12-30
