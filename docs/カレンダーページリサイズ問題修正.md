# カレンダーページリサイズ問題修正

## 問題

- 本番環境のみ、カレンダーを表示した瞬間（月を切り替えたタイミング）に、セルや注文可のボタンが大きく表示され、次の瞬間少し小さくリサイズされている感じの挙動が発生
- ローカル環境では問題なく動作していたが、本番環境でのみ発生

## 原因

### 1. 空のカレンダーと実際のカレンダーでスタイルが異なる

1. **空のカレンダーのスタイル**:
   - `isMounted`が`false`の間、空のカレンダーが表示される
   - 空のカレンダーのセルにはpaddingがなく、`min-h-[90px] sm:min-h-[100px] md:min-h-[90px]`のみが適用されていた

2. **実際のカレンダーのスタイル**:
   - `isMounted`が`true`になると、実際のカレンダーが表示される
   - 実際のカレンダーのセルには`p-1.5 sm:p-2 md:p-2`のpaddingが適用されていた

3. **レイアウトシフトの発生**:
   - 空のカレンダーから実際のカレンダーに切り替わる際に、paddingの有無によりレイアウトが再計算される
   - これにより、セルやボタンのサイズが変わって見えるリサイズが発生していた

### 2. `isMounted`更新タイミングの問題

1. **即座のレンダリング切り替え**:
   - `isMounted`が`false`から`true`に変わる際に、即座にレンダリングが切り替わる
   - ブラウザのレンダリングサイクルと同期していないため、ちらつきが発生していた

2. **レイアウトの再計算**:
   - レンダリングが切り替わる際に、ブラウザがレイアウトを再計算する
   - これにより、視覚的なリサイズが発生していた

## 解決策

### 1. 空のカレンダーにpaddingを追加

空のカレンダーと実際のカレンダーで同じスタイルを使用するように修正しました。

**修正前:**
```tsx
<div
  key={index}
  className="border border-transparent rounded-lg min-h-[90px] sm:min-h-[100px] md:min-h-[90px]"
/>
```

**修正後:**
```tsx
<div
  key={index}
  className="border border-transparent rounded-lg p-1.5 sm:p-2 md:p-2 min-h-[90px] sm:min-h-[100px] md:min-h-[90px]"
/>
```

これにより、空のカレンダーと実際のカレンダーで同じレイアウトが適用され、レイアウトシフトが発生しなくなります。

### 2. `requestAnimationFrame`で`isMounted`更新を遅延

`isMounted`が`false`から`true`に変わる際に、`requestAnimationFrame`を使用して次のフレームで`setIsMounted(true)`を呼び出すように変更しました。

**修正前:**
```tsx
setToday(savedTodayDate);
setNow(savedNowDate);
todayRef.current = savedTodayDate;
nowRef.current = savedNowDate;
setIsMounted(true);
```

**修正後:**
```tsx
setToday(savedTodayDate);
setNow(savedNowDate);
todayRef.current = savedTodayDate;
nowRef.current = savedNowDate;
// 次のフレームでisMountedをtrueにする（レイアウトの再計算を防ぐ）
requestAnimationFrame(() => {
  setIsMounted(true);
});
```

これにより、ブラウザのレンダリングサイクルと同期し、レイアウトの再計算を防ぐことができます。

## 修正ファイル

### `components/calendar-grid.tsx`

1. **空のカレンダーのセルにpaddingを追加**:
   - すべての空のカレンダー（サーバー側、クライアント側の初回マウント前）のセルに`p-1.5 sm:p-2 md:p-2`のpaddingを追加

2. **`requestAnimationFrame`で`isMounted`更新を遅延**:
   - 初回マウント時の`useEffect`内で、`setIsMounted(true)`を`requestAnimationFrame`でラップ
   - 年月変更時の`useEffect`内でも、同様に`requestAnimationFrame`でラップ

## 確認事項

- ✅ 本番環境で、月を切り替えた際にリサイズが発生しない
- ✅ 空のカレンダーと実際のカレンダーで同じスタイルが適用される
- ✅ レイアウトの再計算が発生しない
- ✅ ローカル環境でも問題なく動作する

## 注意事項

### `requestAnimationFrame`の使用

- **ブラウザのレンダリングサイクルと同期**: `requestAnimationFrame`を使用することで、ブラウザのレンダリングサイクルと同期し、レイアウトの再計算を防ぐことができます
- **パフォーマンス**: 次のフレームで更新することで、レンダリングの効率が向上します

### スタイルの統一

- **レイアウトシフトの防止**: 空のカレンダーと実際のカレンダーで同じスタイルを使用することで、レイアウトシフトを防ぐことができます
- **視覚的な一貫性**: ユーザーにとって、スムーズな表示切り替えが実現されます

### 本番環境とローカル環境の違い

- **CSSの読み込みタイミング**: 本番環境では、CSSの読み込みタイミングが異なる可能性があります
- **レンダリングの最適化**: 本番環境では、レンダリングの最適化が異なる可能性があります
- **ネットワーク遅延**: 本番環境では、ネットワーク遅延により、レンダリングタイミングが異なる可能性があります

---

**関連ドキュメント**:
- [CHANGELOG.md](./CHANGELOG.md) - 変更履歴
- [PROGRESS.md](./PROGRESS.md) - 進捗状況
- [カレンダーページ過去注文・ちらつき問題修正.md](./カレンダーページ過去注文・ちらつき問題修正.md) - 関連する修正
- [カレンダーページ13日セル表示問題修正.md](./カレンダーページ13日セル表示問題修正.md) - 関連する修正