# 注文機能 動作確認手順

## 前提条件

1. Next.js 開発サーバーが起動している（`npm run dev`）
2. Supabase のデータベースに必要なテーブルとデータが存在する
3. ユーザーがログインしている

---

## 確認手順

### 1. データベースの状態確認

Supabase SQL Editor で以下を実行：

```sql
-- 026_check_order_test_data.sql を実行
```

確認項目：

- [ ] 有効な業者が存在する（`is_active = true`）
- [ ] 有効なメニューが存在する（`is_active = true`）
- [ ] 現在の日付以降の有効な価格が存在する
- [ ] 現在の日付以降の注文可能日が存在する（`is_available = true`）

**データが不足している場合：**

```sql
-- 030_check_existing_menu_items.sql を実行（既存メニューを確認）
-- 027_insert_current_date_test_data.sql を実行（テストデータを投入）
```

**注意事項：**

- `027_insert_current_date_test_data.sql`は、既存のメニュー名に合わせて価格を設定します
- 既存のメニュー名が異なる場合は、SQL 内の`CASE`文のメニュー名を実際の名前に合わせて修正してください
- 実際のデータベースでは、`menu_prices`テーブルのカラム名は`menu_item_id`（`menu_id`ではない）です

---

### 2. カレンダー画面での確認

1. ブラウザで `http://localhost:3000/calendar` にアクセス
2. カレンダーが表示されることを確認
3. 注文可能日（緑色の「注文可」ボタン）が表示されることを確認
4. 注文済み日（メニュー名と数量が表示）が表示されることを確認

**確認項目：**

- [ ] カレンダーが正しく表示される
- [ ] 注文可能日が「注文可」ボタンで表示される
- [ ] 過去の日付がグレーアウトされている
- [ ] 今日の日付が点滅する枠線で表示される

---

### 3. 注文画面での確認

1. カレンダー画面で「注文可」ボタンをクリック
2. 注文画面（`/orders/new?date=YYYY-MM-DD`）に遷移することを確認

**確認項目：**

- [ ] 注文日が正しく表示される
- [ ] 締切時刻が表示される（今日の場合）
- [ ] 業者別にメニューがグループ化されて表示される
- [ ] メニューを選択できる（ラジオボタン）
- [ ] 数量を入力できる（1 以上の整数）

**エラーケースの確認：**

- [ ] 過去の日付の URL にアクセスした場合、カレンダーにリダイレクトされる
- [ ] 無効な日付形式の URL にアクセスした場合、カレンダーにリダイレクトされる
- [ ] 注文不可日の URL にアクセスした場合、カレンダーにリダイレクトされる
- [ ] 締切時刻を過ぎた今日の日付の URL にアクセスした場合、カレンダーにリダイレクトされる

---

### 4. 注文作成の確認

1. 注文画面でメニューを選択
2. 数量を入力（例: 1）
3. 「注文を確定」ボタンをクリック

**正常系の確認：**

- [ ] 注文が正常に作成される
- [ ] カレンダー画面にリダイレクトされる
- [ ] カレンダー画面で注文済み日として表示される（メニュー名、数量）

**エラーケースの確認：**

- [ ] メニューを選択せずに「注文を確定」をクリックした場合、エラーメッセージが表示される
- [ ] 数量が 0 以下の場合、エラーメッセージが表示される
- [ ] 締切時刻を過ぎた場合、エラーメッセージが表示される
- [ ] 既に注文がある日付に再度注文しようとした場合、エラーメッセージが表示される

**データベースでの確認：**

```sql
-- 注文が正しく作成されているか確認
SELECT
    o.id,
    o.order_date,
    o.quantity,
    o.status,
    m.name AS menu_name,
    mp.price,
    (mp.price * o.quantity) AS total
FROM orders o
JOIN menu_items m ON m.id = o.menu_id
JOIN menu_prices mp ON mp.id = o.menu_price_id
WHERE o.status = 'ordered'
ORDER BY o.order_date DESC, o.created_at DESC
LIMIT 10;

-- 監査ログが記録されているか確認
SELECT
    action,
    detail,
    created_at
FROM audit_logs
WHERE action = 'order.create'
ORDER BY created_at DESC
LIMIT 5;
```

---

### 5. 注文履歴画面での確認

1. ブラウザで `http://localhost:3000/orders` にアクセス
2. 注文履歴が表示されることを確認

**確認項目：**

- [ ] 今月の注文一覧が表示される
- [ ] 注文日、メニュー名、数量、価格が正しく表示される
- [ ] 今月の合計金額が正しく表示される
- [ ] キャンセルボタンが表示される（注文済みの場合）

---

### 6. 注文キャンセルの確認

1. 注文履歴画面で「キャンセル」ボタンをクリック
2. 確認ダイアログが表示されることを確認
3. 「確定」ボタンをクリック

**正常系の確認：**

- [ ] 注文がキャンセルされる（`status = 'cancelled'`）
- [ ] 注文履歴画面がリフレッシュされる
- [ ] キャンセル済みの注文が「キャンセル済み」バッジで表示される
- [ ] カレンダー画面で注文済み表示が消える

**エラーケースの確認：**

- [ ] 締切時刻を過ぎた注文はキャンセルできない（エラーメッセージが表示される）

**データベースでの確認：**

```sql
-- キャンセルされた注文を確認
SELECT
    o.id,
    o.order_date,
    o.status,
    m.name AS menu_name,
    o.updated_at
FROM orders o
JOIN menu_items m ON m.id = o.menu_id
WHERE o.status = 'cancelled'
ORDER BY o.updated_at DESC
LIMIT 10;

-- 監査ログが記録されているか確認
SELECT
    action,
    detail,
    created_at
FROM audit_logs
WHERE action = 'order.cancel'
ORDER BY created_at DESC
LIMIT 5;
```

---

## データベース構造の確認

実際のデータベース構造は、初期スキーマ（`001_initial_schema.sql`）と異なる場合があります。詳細は `docs/データベース構造の注意事項.md` を参照してください。

**主な違い：**

- `menu_prices`テーブルのカラム名は`menu_item_id`（`menu_id`ではない）
- テーブル名が異なる場合がある（例: `menus` → `menu_items`）

---

## トラブルシューティング

### 問題 1: メニューが表示されない

**原因：**

- 業者またはメニューの `is_active` が `false`
- 業者とメニューの関連が正しく設定されていない

**解決方法：**

```sql
-- 業者とメニューの状態を確認
SELECT
    v.code,
    v.name,
    v.is_active AS vendor_active,
    m.name AS menu_name,
    m.is_active AS menu_active
FROM vendors v
LEFT JOIN menu_items m ON m.vendor_id = v.id
WHERE v.is_active = true
ORDER BY v.code, m.name;
```

### 問題 2: 価格情報の取得に失敗する

**原因：**

- メニューに対応する価格データが存在しない
- 価格の有効期間が現在の日付をカバーしていない

**解決方法：**

```sql
-- 価格データを確認
SELECT
    m.id AS menu_id,
    m.name AS menu_name,
    mp.price,
    mp.start_date,
    mp.end_date,
    CASE
        WHEN mp.start_date <= CURRENT_DATE
         AND (mp.end_date IS NULL OR mp.end_date >= CURRENT_DATE)
        THEN '有効'
        ELSE '無効'
    END AS status
FROM menu_items m
LEFT JOIN menu_prices mp ON mp.menu_id = m.id
WHERE m.is_active = true
ORDER BY m.name, mp.start_date DESC;
```

### 問題 3: 注文が作成できない

**原因：**

- 締切時刻を過ぎている
- 既に注文が存在する（UNIQUE 制約違反）
- RLS ポリシーの問題

**解決方法：**

- サーバーコンソールのエラーログを確認
- データベースのエラーログを確認
- `get_menu_price_id` 関数が正しく動作するか確認

```sql
-- get_menu_price_id関数のテスト
SELECT get_menu_price_id(1, CURRENT_DATE);
```

---

## 確認チェックリスト

- [ ] データベースに必要なデータが存在する
- [ ] カレンダー画面が正しく表示される
- [ ] 注文画面が正しく表示される
- [ ] 注文が正常に作成される
- [ ] 注文履歴が正しく表示される
- [ ] 注文が正常にキャンセルされる
- [ ] エラーハンドリングが正しく動作する
- [ ] 監査ログが正しく記録される

---

## 次のステップ

動作確認が完了したら、管理者機能の実装に進みます。
