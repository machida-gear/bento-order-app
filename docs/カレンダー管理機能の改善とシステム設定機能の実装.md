# カレンダー管理機能の改善とシステム設定機能の実装

## 日付

2025-01-XX

## 概要

カレンダー管理画面の機能改善と、システム設定機能の実装を行いました。

---

## 1. カレンダー管理画面の改善

### 1.1 チェックボックスを False にした時のエラー修正

#### 問題

- 注文可能のチェックボックスを False にして保存したらエラーが発生
- エラーメッセージ: `締切時刻の形式が正しくありません (HH:MM形式で入力してください)`
- データベースから取得した`deadline_time`が`HH:MM:SS`形式で、API が`HH:MM`形式を期待していた

#### 解決策

1. **時刻フォーマット関数の追加**

   - `formatTime`関数を追加し、`HH:MM:SS`形式を`HH:MM`形式に変換
   - データベースから取得した時刻を表示前に変換

2. **注文不可時の処理**

   - チェックボックスが False の場合、`deadline_time`を`null`に設定
   - 注文不可の場合は締切時刻の入力欄を非表示

3. **データベーススキーマの変更**
   - `deadline_time`カラムを NULL 許可に変更（`050_allow_null_deadline_time.sql`）
   - 注文不可の日には締切時刻が不要であることを反映

#### 修正ファイル

- `app/admin/calendar/page.tsx`: 時刻フォーマット処理、注文不可時の処理を追加
- `app/api/admin/calendar/route.ts`: 注文不可時の`deadline_time`を`null`に設定
- `supabase/migrations/050_allow_null_deadline_time.sql`: `deadline_time`カラムを NULL 許可に変更

---

### 1.2 複数日選択機能の実装

#### 実装内容

- 「複数日を選択して一括編集」チェックボックスで一括編集モードに切り替え
- 一括編集モードでは、各日付にチェックボックスを表示
- 複数日を選択して「選択した X 日を注文可能にする」「選択した X 日を注文不可にする」ボタンで一括更新
- 一括更新時は、選択した日付を順次更新（`Promise.allSettled`を使用して一部失敗しても続行）

#### 機能詳細

- チェックボックスで複数日を選択可能
- 選択した日付は青色の枠で強調表示
- エラーハンドリングを改善し、失敗した日付とエラー内容を詳細に表示
- 成功した日付のみローカル状態を更新

#### 修正ファイル

- `app/admin/calendar/page.tsx`: 複数日選択機能を追加

---

### 1.3 備考入力欄の追加

#### 実装内容

- 複数日一括編集モードで日付を選択すると、備考入力欄が表示される
- 入力した備考は、選択したすべての日付に適用される
- 空欄の場合は`null`が設定される

#### 修正ファイル

- `app/admin/calendar/page.tsx`: 備考入力欄を追加

---

### 1.4 月一括編集機能の実装

#### 実装内容

- 月一括編集ボタンを追加
- ボタンをクリックすると、現在表示中の月のすべての日付を一括設定
- システム設定から曜日ごとの設定を読み込んで適用

#### 初期実装（システム設定実装前）

- 月曜〜金曜：注文可（締切時刻 10:00）
- 土曜・日曜：注文不可（備考「週末」）

#### システム設定実装後

- システム設定で設定した曜日ごとの設定を適用
- デフォルト締切時刻もシステム設定から読み込む

#### 修正ファイル

- `app/admin/calendar/page.tsx`: 月一括編集機能を追加

---

### 1.5 RLS ポリシーの修正

#### 問題

- カレンダー設定の更新時に RLS ポリシー違反エラー（`42501`）が発生
- `order_calendar_all_admin`ポリシーに`is_active = true`のチェックが含まれていなかった

#### 解決策

1. **RLS ポリシーの確認と修正**

   - `048_create_order_calendar_admin_policy.sql`を作成
   - 既存のポリシーを削除して再作成（`is_active = true`チェックを含む）
   - `profiles`テーブルを参照するように修正

2. **エラーハンドリングの改善**
   - API 側で詳細なエラーメッセージを返すように改善
   - フロントエンド側でエラーメッセージを詳細に表示

#### 修正ファイル

- `supabase/migrations/048_create_order_calendar_admin_policy.sql`: RLS ポリシー確認・修正用 SQL
- `app/api/admin/calendar/route.ts`: エラーハンドリングの改善、管理者権限チェックの改善
- `app/admin/calendar/page.tsx`: エラーメッセージ表示の改善

---

## 2. システム設定機能の実装

### 2.1 システム設定テーブルの作成

#### テーブル構造

- `system_settings`テーブルを作成
- シングルトンパターン（id=1 のみ）
- カラム:
  - `id`: BIGSERIAL PRIMARY KEY
  - `default_deadline_time`: TIME 型（デフォルト締切時刻）
  - `closing_day`: INTEGER 型（締め日、1〜31 日）
  - `day_of_week_settings`: JSONB 型（曜日ごとの設定）
    - 各曜日（0=日曜〜6=土曜）に対して`is_available`と`note`を設定可能

#### RLS ポリシー

- 全ユーザーが参照可能
- 管理者のみ更新可能

#### マイグレーションファイル

- `supabase/migrations/051_create_system_settings_table.sql`

---

### 2.2 システム設定画面の作成

#### 実装内容

- システム設定画面（`app/admin/settings/page.tsx`）を作成
- 以下の設定が可能:
  1. **デフォルト締切時刻**: カレンダー設定で締切時刻を指定しない場合のデフォルト値
  2. **締め日（毎月）**: 集計の際に使用される締め日（1〜31 日）
  3. **曜日ごとのデフォルト設定**: 月一括編集で使用される曜日ごとの設定
     - 各曜日（月曜〜日曜）に対して注文可否と備考を設定可能

#### UI

- デフォルト締切時刻: 時刻入力欄
- 締め日: 数値入力欄（1〜31）
- 曜日ごとの設定: 各曜日ごとにチェックボックス（注文可能）と備考入力欄

#### 修正ファイル

- `app/admin/settings/page.tsx`: システム設定画面を作成
- `app/api/admin/settings/route.ts`: 設定取得・更新 API を作成
- `components/admin-nav.tsx`: 「システム設定」メニューを追加

---

### 2.3 カレンダー画面での設定読み込み

#### 実装内容

- カレンダー画面でシステム設定を読み込むように変更
- 月一括編集で設定から曜日ごとの設定を読み込むように変更
- 複数日一括編集でデフォルト締切時刻を使用するように変更

#### 修正ファイル

- `app/admin/calendar/page.tsx`: システム設定の読み込みと適用を追加

---

## 3. エラー修正

### 3.1 NaN エラーの修正

#### 問題

- 設定画面の締め日入力欄で`NaN`エラーが発生
- `parseInt`の結果が`NaN`になる場合があった

#### 解決策

- 空文字の場合は更新しない
- `parseInt`の結果が`NaN`の場合は更新しない
- 1〜31 の範囲外の値は更新しない
- `value`属性に`settings.closing_day || ''`を設定して、`undefined`や`null`の場合に空文字を表示

#### 修正ファイル

- `app/admin/settings/page.tsx`: 締め日入力欄のバリデーションを改善

---

## 4. マイグレーションファイル一覧

### 作成したマイグレーションファイル

- `048_create_order_calendar_admin_policy.sql`: RLS ポリシー確認・修正用
- `049_debug_order_calendar_rls.sql`: RLS ポリシー問題のデバッグ用
- `050_allow_null_deadline_time.sql`: `deadline_time`カラムを NULL 許可に変更
- `051_create_system_settings_table.sql`: システム設定テーブルの作成

---

## 5. 修正ファイル一覧

### コードファイル

- `app/admin/calendar/page.tsx`: カレンダー管理画面の改善
- `app/admin/settings/page.tsx`: システム設定画面の作成
- `app/api/admin/calendar/route.ts`: カレンダー管理 API の改善
- `app/api/admin/settings/route.ts`: システム設定 API の作成
- `components/admin-nav.tsx`: ナビゲーションメニューの更新

### マイグレーションファイル

- `supabase/migrations/048_create_order_calendar_admin_policy.sql`
- `supabase/migrations/049_debug_order_calendar_rls.sql`
- `supabase/migrations/050_allow_null_deadline_time.sql`
- `supabase/migrations/051_create_system_settings_table.sql`

---

## 6. 確認事項

- ✅ チェックボックスを False にしてもエラーが発生しない
- ✅ 複数日を選択して一括編集できる
- ✅ 一括編集時に備考を入力できる
- ✅ 月一括編集が正常に動作する
- ✅ システム設定画面から各種設定ができる
- ✅ カレンダー画面でシステム設定が読み込まれる
- ✅ RLS ポリシーが正しく動作している

---

## 7. 学んだこと

1. **RLS ポリシーのデバッグ方法**

   - Service Role Key を使用して RLS をバイパスして確認
   - ポリシー内で`profiles`テーブルを参照する際は、`profiles`テーブルの RLS ポリシーも考慮する必要がある

2. **データベーススキーマの柔軟性**

   - 注文不可の日には締切時刻が不要であるため、`deadline_time`を NULL 許可にする必要があった
   - システム設定を別テーブルで管理することで、設定変更が容易になる

3. **エラーハンドリングの重要性**
   - 詳細なエラーメッセージを返すことで、問題の原因を特定しやすくなる
   - 一括更新時は`Promise.allSettled`を使用して、一部失敗しても他の更新は続行できるようにする

---

## 参考資料

- [カレンダー注文表示問題の解決とキャンセル機能追加.md](./カレンダー注文表示問題の解決とキャンセル機能追加.md)
- [実際のデータベーススキーマ.md](./実際のデータベーススキーマ.md)
- [管理者機能の実装.md](./管理者機能の実装.md)
