# パスワードリセット機能の実装

このドキュメントでは、メール内のリンクから新しいパスワードを設定するパスワードリセット機能の実装内容を記録します。

> 📖 **関連ドキュメント**: [README.md](./README.md) - すべてのドキュメントへの参照

---

## 実装日

2026-01-13

## 問題

- パスワードリセットメールが届き、リンクをクリックしても、ログイン画面にリダイレクトされるだけでパスワードのリセットができない
- メール内リンクが自動スキャン（URLスキャナ）され、ワンタイムトークンが消費されて `otp_expired` になる
- リンク方式に依存すると、環境によっては再現性のある失敗が起きる

## 解決策

**OTPコード入力方式（メールに記載されたコードを入力して検証）**に切り替え、URLスキャナの影響を受けないパスワードリセットを実装しました。

### 実装内容

1. **OTPコード入力フォームの追加**
   - メールに記載されたOTPコード（数字）を入力する画面を追加
   - Supabaseの設定（Email OTP Length）に合わせ、**8桁**を前提にバリデーション
   - `autoComplete="one-time-code"` / `inputMode="numeric"` を設定

2. **OTPコード検証（recovery）**
   - `supabase.auth.verifyOtp({ email, token, type: 'recovery' })` を使用してコード検証
   - 検証成功後、パスワード更新モードへ遷移

3. **パスワード更新フォームの追加**
   - 新しいパスワード入力欄
   - パスワード確認入力欄
   - バリデーション（6文字以上、一致確認）
   - エラーメッセージの日本語化

4. **パスワード更新処理**
   - `supabase.auth.updateUser({ password: newPassword })`でパスワードを更新
   - 更新成功後、成功メッセージを表示
   - 3秒後にログイン画面に自動リダイレクト

## 動作フロー

1. ユーザーがメールアドレスを入力して「リセットメールを送信」ボタンをクリック
2. `supabase.auth.resetPasswordForEmail()` が呼び出され、パスワードリセットメールが送信される
3. ユーザーはメールに記載された **OTPコード（8桁）** をログイン画面の「確認コード」入力欄に入力
4. `supabase.auth.verifyOtp(type: 'recovery')` でOTPコードを検証
5. 検証成功後、パスワード更新フォームが表示される
6. `supabase.auth.updateUser({ password: newPassword })` でパスワードを更新
7. 成功メッセージを表示し、ログイン画面へ戻る

## 修正ファイル

- `app/(auth)/login/page.tsx`: パスワードリセット機能の実装
  - OTPコード入力（8桁）と検証（`verifyOtp`）を追加
  - OTP検証成功後にパスワード更新フォームへ遷移
  - エラーハンドリング（expired/invalid等）を改善

## 技術的な詳細

### URLハッシュの処理

（補足）Supabaseのリンク方式では、URLハッシュにトークンを含むことがあります：

```
https://example.com/login#access_token=...&type=recovery&refresh_token=...
```

しかし、リンク方式はURLスキャナによりワンタイムトークンが消費されることがあるため、本プロジェクトでは **OTPコード入力方式を優先**します。

### セッションの復元

URLハッシュに含まれる`access_token`は、Supabaseクライアントによって自動的にセッションとして復元されます。そのため、ハッシュを削除しても、セッションは維持されます。

### エラーハンドリング

パスワード更新時のエラーは、既存の`translateAuthError`関数を使用して日本語に変換されます。主なエラー：

- `Password is too weak`: 「パスワードが弱すぎます」
- その他のSupabaseエラーも日本語化

## UI改善

### フッターの変更

- 「© 2026 お弁当注文システム」→「© 2026 MACHIDA GEAR」に変更
- タイトル（「お弁当注文システム」）は変更なし

## 確認事項

- ✅ パスワードリセットメールが正しく送信される
- ✅ メールに記載されたOTPコードを入力すると、パスワード更新フォームが表示される
- ✅ 新しいパスワードとパスワード確認を入力してパスワードを更新できる
- ✅ パスワードは6文字以上で入力される必要がある
- ✅ パスワードとパスワード確認が一致しない場合はエラーが表示される
- ✅ パスワード更新成功後、ログイン画面に自動リダイレクトされる
- ✅ エラーメッセージが日本語で表示される

## Supabaseメールテンプレートの設定

### `{{ .ConfirmationURL }}`について

Supabaseのメールテンプレートでは、`{{ .ConfirmationURL }}`という変数が使用されます。この変数は**自動的に生成される**ため、手動で設定する必要はありません。

#### メールテンプレートの例

Supabase Dashboard > Authentication > Email Templates > Reset Password で以下のように設定できます：

```html
<p><a href="{{ .ConfirmationURL }}">お弁当注文システムのパスワードをリセット</a></p>
```

この`{{ .ConfirmationURL }}`は、コード内の`redirectTo`パラメータとSupabase Dashboardの設定に基づいて自動的に生成されます。

### 必要な設定

`{{ .ConfirmationURL }}`が正しく生成されるには、以下の設定が必要です：

#### 1. Supabase Dashboardの設定

1. Supabase Dashboardにログイン
2. 左メニューから「Authentication」を選択
3. 「URL Configuration」セクションを開く
4. **Site URL**を本番環境のURLに設定：
   ```
   https://bento-order-app-blond.vercel.app
   ```
5. **Redirect URLs**に本番環境のURLを追加：
   ```
   https://bento-order-app-blond.vercel.app/**
   http://localhost:3000/**  （開発環境用）
   ```
6. 設定を保存

#### 2. 環境変数の設定

Vercelの環境変数に以下を設定：

```
NEXT_PUBLIC_SITE_URL=https://bento-order-app-blond.vercel.app
```

設定後、Vercelで再デプロイしてください。

### メールテンプレート（OTPコード表示）

URLスキャナ対策として、Reset password テンプレートに **OTPコード（`{{ .Token }}`）** を表示することを推奨します：

```html
<p>以下のコードを入力してパスワードをリセットしてください：</p>
<p style="font-size:24px;font-weight:bold;letter-spacing:6px;">
  {{ .Token }}
</p>
<p>（有効期限: Email OTP Expiration の設定値）</p>
```

### 動作の仕組み（参考）

1. **コード側（`app/(auth)/login/page.tsx`）**で `resetPasswordForEmail()` を呼び出してメール送信

2. **Supabaseが`{{ .ConfirmationURL }}`を生成**：
   - `redirectTo`パラメータの値を使用
   - 実際のURLは以下の形式：
     ```
     https://[PROJECT-ID].supabase.co/auth/v1/verify?token=...&type=recovery&redirect_to=[redirectUrl]
     ```

3. **ユーザーはメールのOTPコードを入力**し、`verifyOtp(type: 'recovery')` で検証してパスワード更新に進む

### トラブルシューティング

メール内のリンクがローカルURL（`http://localhost:3000`）になる場合：

1. **`NEXT_PUBLIC_SITE_URL`環境変数の確認**：
   - Vercelの環境変数設定で`NEXT_PUBLIC_SITE_URL`が本番環境のURLに設定されているか確認
   - 例: `NEXT_PUBLIC_SITE_URL=https://bento-order-app-blond.vercel.app`

2. **Supabase Dashboardの設定確認**：
   - 「Site URL」が本番環境のURLになっているか確認
   - 「Redirect URLs」に本番環境のURLが追加されているか確認

3. **再デプロイ**：
   - 環境変数を変更した後は、Vercelで再デプロイしてください

詳細は`docs/環境変数設定手順.md`を参照してください。

## 注意事項

- URLハッシュは、ブラウザの履歴やブックマークには保存されません
- パスワードリセットリンクは、通常24時間以内に有効期限が切れます（Supabaseの設定による）
- パスワード更新後、古いパスワードではログインできなくなります
- パスワードリセットメールのリンクは、1回のみ使用可能です
- `{{ .ConfirmationURL }}`は自動生成される変数で、手動で設定する必要はありません
- メールテンプレートは、Supabase Dashboard > Authentication > Email Templates で編集できます

---

最終更新日: 2026-01-13（OTPコード入力方式に変更、8桁対応）
