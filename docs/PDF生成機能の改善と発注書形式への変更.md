# PDF生成機能の改善と発注書形式への変更

このドキュメントでは、PDF生成機能の改善と発注書形式への変更について記録します。

> 📖 **関連ドキュメント**: [README.md](./README.md) - すべてのドキュメントへの参照

---

## 実装日

2025-01-02

---

## 背景

PDF生成機能において、以下の問題と改善要求がありました：

1. **PDF生成エラー**: `Helvetica.afm`ファイルが見つからないエラーが発生
2. **Next.jsロックエラー**: 開発サーバーのロックファイルが残り、再起動できない
3. **PDFデザイン**: 発注書形式への変更要求
4. **会社情報**: 自社の社名、住所、電話番号、FAX番号、メールアドレスを保存できるようにする要求

---

## 実装内容

### 1. PDF生成エラーの修正

#### 問題

- PDF生成時に`ENOENT: no such file or directory, open 'C:\\Users\\kazu\\my-app\\.next\\dev\\server\\vendor-chunks\\data\\Helvetica.afm'`エラーが発生
- `predev`スクリプトでフォントファイルはコピーされているが、実行時にpdfkitがフォントファイルを見つけられない
- Next.jsの開発環境でパスが動的に変わる可能性がある

#### 解決策

1. **実行時に確実にフォントファイルをコピー**
   - 複数の候補ディレクトリ（`.next/dev/server/vendor-chunks/data`、`.next/server/vendor-chunks/data`、`.next/static/chunks/data`）にフォントファイルをコピー
   - フォントファイルが見つからない場合のエラーハンドリングを強化

2. **フォントパスの検出と設定**
   - 最初に見つかったターゲットディレクトリを使用
   - フォントパスが見つからない場合は、`node_modules/pdfkit/js/data`を使用
   - フォントパスが設定されていない場合は明確なエラーメッセージを表示

#### 修正ファイル

- `app/api/admin/orders/today/pdf/route.ts`: フォントファイルのコピー処理とフォントパス設定を改善

#### 本番環境での注意事項

- **開発環境**: `predev`スクリプトでフォントファイルが自動的にコピーされる
- **本番環境**: ビルド時にフォントファイルが正しく配置されることを確認する必要がある
- **フォントファイルの配置**: `node_modules/pdfkit/js/data/`にフォントファイル（`.afm`）が存在することを確認
- **エラーハンドリング**: フォントファイルが見つからない場合、明確なエラーメッセージが表示される

---

### 2. Next.jsロックエラーの解決スクリプト

#### 問題

- 別のNext.jsプロセスが実行中で、ロックファイル（`.next/dev/lock`）が残っている
- 新しいインスタンスを起動できない

#### 解決策

1. **プロセス終了スクリプトの作成**
   - `scripts/kill-nextjs.js`: Node.js版
   - `scripts/kill-nextjs.ps1`: PowerShell版（日本語対応）
   - `scripts/kill-nextjs-safe.ps1`: PowerShell版（英語のみ、エンコーディング問題を回避）

2. **PowerShell変数の問題修正**
   - `$pid`はPowerShellの自動変数（読み取り専用）のため、`$processId`に変更

#### 使用方法

```powershell
# 英語版スクリプト（推奨）
npm run kill-nextjs:safe

# または日本語版
npm run kill-nextjs:ps1

# またはNode.js版
npm run kill-nextjs
```

#### 修正ファイル

- `scripts/kill-nextjs.js`: Node.js版プロセス終了スクリプト
- `scripts/kill-nextjs.ps1`: PowerShell版プロセス終了スクリプト（日本語対応）
- `scripts/kill-nextjs-safe.ps1`: PowerShell版プロセス終了スクリプト（英語のみ）
- `package.json`: スクリプトコマンドを追加

---

### 3. PDFデザインの発注書形式への変更

#### 変更内容

1. **ヘッダー部分**
   - 青いバナー（`#2563eb`）で「発注書」を中央に白文字で表示
   - 右上に「発注日 YYYY/M/D」を白文字で表示

2. **左上：業者名**
   - 業者名「○○○○御中」を表示

3. **右上：送信者情報**
   - 会社名、郵便番号、住所、電話番号を表示
   - 会社マスター（`system_settings`テーブル）から取得

4. **本文**
   - 「下記の通り、発注いたします。」を追加

5. **合計食数表示**
   - 青いボックスで「合計食数」を表示
   - 大きなフォントで食数を表示（例: `31食`）

6. **明細テーブル**
   - 列構成: 「内容」「数量」のみ
   - メニューごとに集計して表示（個別注文ではなく、メニューごとの合計）
   - フォントサイズ: 14pt（以前は10pt）
   - 数量の配置: 中央寄せ（以前は右寄せ）

7. **小計・消費税・合計の削除**
   - 小計、消費税、合計の金額表示を削除

#### 修正ファイル

- `app/api/admin/orders/today/pdf/route.ts`: PDF生成ロジックを発注書形式に変更

---

### 4. 会社マスター機能の実装

#### 実装内容

1. **データベースマイグレーション**
   - `supabase/migrations/057_add_company_info_to_system_settings.sql`を作成
   - `system_settings`テーブルに以下のカラムを追加:
     - `company_name`: 会社名
     - `company_postal_code`: 郵便番号
     - `company_address`: 住所
     - `company_phone`: 電話番号
     - `company_fax`: FAX番号
     - `company_email`: メールアドレス

2. **システム設定画面の更新**
   - 会社情報セクションを追加
   - 以下の入力欄を追加:
     - 会社名
     - 郵便番号
     - 住所
     - 電話番号
     - FAX番号
     - メールアドレス

3. **システム設定APIの更新**
   - 会社情報の保存・取得に対応
   - PUTリクエストで会社情報を更新可能

4. **PDF生成APIの更新**
   - 会社マスター（`system_settings`テーブル）から会社情報を取得
   - 取得優先順位:
     1. 会社マスター（`system_settings`テーブル）
     2. 環境変数（`PDF_SENDER_*`）
     3. 固定値（フォールバック）

#### 修正ファイル

- `supabase/migrations/057_add_company_info_to_system_settings.sql`: 会社情報カラムを追加
- `app/admin/settings/page.tsx`: 会社情報セクションを追加
- `app/api/admin/settings/route.ts`: 会社情報の保存・取得に対応
- `app/api/admin/orders/today/pdf/route.ts`: 会社マスターから情報を取得

#### 使用方法

1. **マイグレーションの実行**
   - Supabaseでマイグレーションファイルを実行

2. **会社情報の設定**
   - 管理者でログイン
   - `/admin/settings`にアクセス
   - 「会社情報」セクションで情報を入力
   - 「設定を保存」をクリック

3. **PDF生成での使用**
   - PDF生成時に、設定した会社情報が自動的に使用されます

---

## 本番環境での注意事項

### PDF生成エラーを防ぐためのチェックリスト

1. **フォントファイルの確認**
   - `node_modules/pdfkit/js/data/`にフォントファイル（`.afm`）が存在することを確認
   - 特に`Helvetica.afm`が存在することを確認

2. **ビルド時の確認**
   - 本番環境でビルドする際、フォントファイルが正しく配置されることを確認
   - `.next`フォルダ内にフォントファイルがコピーされることを確認

3. **エラーハンドリング**
   - フォントファイルが見つからない場合、明確なエラーメッセージが表示される
   - エラーログを確認して、フォントパスの問題を特定

4. **日本語フォントの設定**
   - 日本語フォント（IPAexフォントまたはIPAフォント）を`public/fonts/`フォルダに配置
   - フォントファイルのダウンロード手順は`docs/PDFフォント設定手順.md`を参照

5. **会社情報の設定**
   - 本番環境で会社情報を設定することを推奨
   - 環境変数（`PDF_SENDER_*`）はフォールバックとして使用可能

---

## 確認事項

- ✅ PDF生成時にHelvetica.afmエラーが解消される
- ✅ 実行時に確実にフォントファイルがコピーされる
- ✅ フォントパスが見つからない場合のエラーハンドリングが強化される
- ✅ Next.jsロックエラーを解決するスクリプトが作成される
- ✅ PDFデザインが発注書形式に変更される
- ✅ 明細のフォントサイズが拡大され、数量が中央寄せになる
- ✅ 会社マスター機能が実装され、PDF生成時に自動的に使用される

---

## 関連ドキュメント

- [PDF出力機能のフォント問題解決と日本語対応.md](./PDF出力機能のフォント問題解決と日本語対応.md)
- [PDFフォント設定手順.md](./PDFフォント設定手順.md)
- [本番環境デプロイ時のチェックリスト.md](./本番環境デプロイ時のチェックリスト.md)
