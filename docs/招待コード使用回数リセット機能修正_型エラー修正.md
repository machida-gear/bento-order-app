# 招待コード使用回数リセット機能修正と型エラー修正

## 概要

Vercelデプロイ時に発生したTypeScriptの型エラーを修正し、招待コード管理画面の使用回数リセット機能が正常に動作するようにしました。

## 問題の詳細

### 1. TypeScriptの型エラー

Vercelデプロイ時に以下のTypeScript型エラーが発生し、ビルドが失敗していました：

#### エラー1: `app/(user)/calendar/page.tsx:327:46`
```
Type error: Property 'message' does not exist on type 'never'.
```

**原因**: `calendarError` と `ordersError` が常に `null` として定義されており、TypeScriptが型推論で `never` 型として判定していました。

#### エラー2: `app/api/auth/signup/route.ts:150:60`
```
Type error: Property 'message' does not exist on type 'never'.
```

**原因**: `authError` の重複チェックがあり、型推論で問題が発生していました。

### 2. 招待コード使用回数リセット機能の不具合

**問題**: 招待コード管理画面でリセットボタンを押しても、メッセージは表示されるが実際には使用回数がリセットされない

**原因**: 
- API側で招待コードが**変更された場合のみ**使用回数をリセットする仕様になっていた
- リセットボタンは現在の招待コードをそのまま送信するため、変更がないと判定されてリセットされなかった

## 解決策

### 1. 型エラーの修正

#### `app/(user)/calendar/page.tsx` の修正

**修正前**:
```typescript
const { orderDays, orders, systemSettings, calendarError, ordersError } = await queryDatabase(async (client) => {
  // ...
  return {
    orderDays,
    orders,
    systemSettings,
    calendarError: null,
    ordersError: null,
  };
});

// エラー表示
{(calendarError || ordersError)?.message}
```

**修正後**:
```typescript
const { orderDays, orders, systemSettings, calendarError, ordersError } = await queryDatabase(async (client): Promise<{
  orderDays: any[];
  orders: any[];
  systemSettings: any;
  calendarError: Error | null;
  ordersError: Error | null;
}> => {
  // ...
  return {
    orderDays,
    orders,
    systemSettings,
    calendarError: null,
    ordersError: null,
  };
});

// エラー表示
{(calendarError as Error | null)?.message || (ordersError as Error | null)?.message || 'エラーが発生しました'}
```

**修正内容**:
- `queryDatabase` の戻り値の型を明示的に定義（`Error | null` 型を指定）
- エラーメッセージ表示時に型アサーションを使用

#### `app/api/auth/signup/route.ts` の修正

**修正前**:
```typescript
if (authError) {
  const translatedError = translateAuthError(authError.message)
  return NextResponse.json({ error: translatedError }, { status: 400 })
}

if (!authData.user) {
  return NextResponse.json({ error: 'ユーザー作成に失敗しました' }, { status: 500 })
}

if (authError) {  // ← 冗長なチェック（140行目で既にチェック済み）
  const translatedError = translateAuthError(authError.message)
  return NextResponse.json({ error: translatedError }, { status: 400 })
}

if (!authData.user) {  // ← 冗長なチェック（145行目で既にチェック済み）
  return NextResponse.json({ error: 'ユーザー作成に失敗しました' }, { status: 500 })
}
```

**修正後**:
```typescript
if (authError) {
  const translatedError = translateAuthError(authError.message)
  return NextResponse.json({ error: translatedError }, { status: 400 })
}

if (!authData.user) {
  return NextResponse.json({ error: 'ユーザー作成に失敗しました' }, { status: 500 })
}

// 冗長なチェックを削除
```

**修正内容**:
- 149-152行目の冗長な `authError` チェックを削除
- 154-156行目の冗長な `authData.user` チェックを削除

### 2. 招待コード使用回数リセット機能の修正

#### `app/api/admin/invitation-code/route.ts` の修正

**修正前**:
```typescript
const body = await request.json()
const { invitation_code, invitation_code_max_uses } = body

// 招待コードが変更された場合のみ使用回数をリセット
let shouldResetUsageCount = false
if (invitation_code !== undefined) {
  const currentCode = currentSettingsTyped?.invitation_code?.trim() || ''
  const newCode = invitation_code?.toString().trim() || ''
  if (currentCode !== newCode) {
    shouldResetUsageCount = true
  }
}
```

**修正後**:
```typescript
const body = await request.json()
const { invitation_code, invitation_code_max_uses, reset_usage_count } = body

// 招待コードが変更された場合、または明示的にリセットが要求された場合、使用回数をリセット
let shouldResetUsageCount = false
if (reset_usage_count === true) {
  shouldResetUsageCount = true
  console.log('=== Usage Count Reset Requested ===')
  console.log('Will reset usage count explicitly')
} else if (invitation_code !== undefined) {
  const currentCode = currentSettingsTyped?.invitation_code?.trim() || ''
  const newCode = invitation_code?.toString().trim() || ''
  if (currentCode !== newCode) {
    shouldResetUsageCount = true
    console.log('=== Invitation Code Changed ===')
    console.log('Current code:', currentCode)
    console.log('New code:', newCode)
    console.log('Will reset usage count')
  }
}
```

**修正内容**:
- `reset_usage_count` パラメータを追加
- `reset_usage_count === true` の場合、招待コードが変更されていなくても使用回数をリセット

#### `app/admin/invitation-code/page.tsx` の修正

**修正前**:
```typescript
const handleResetUsageCount = async () => {
  // ...
  const response = await fetch('/api/admin/invitation-code', {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      invitation_code: currentCode,  // ← 同じコードを送信
      invitation_code_max_uses: settings.invitation_code_max_uses,
    }),
  })
  // ...
}
```

**修正後**:
```typescript
const handleResetUsageCount = async () => {
  // ...
  const response = await fetch('/api/admin/invitation-code', {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      invitation_code: settings.invitation_code,
      invitation_code_max_uses: settings.invitation_code_max_uses,
      reset_usage_count: true,  // ← リセットフラグを追加
    }),
  })
  // ...
}
```

**修正内容**:
- リセットボタン押下時に `reset_usage_count: true` をリクエストに含める

## 実装ファイル

### 型エラー修正

- `app/(user)/calendar/page.tsx`: 型定義の明示化、エラーメッセージ表示の修正
- `app/api/auth/signup/route.ts`: 冗長なエラーチェックの削除

### 招待コードリセット機能修正

- `app/admin/invitation-code/page.tsx`: リセットリクエストに `reset_usage_count` フラグを追加
- `app/api/admin/invitation-code/route.ts`: `reset_usage_count` パラメータの処理を追加

## 動作確認

### 型エラー修正の確認

1. ローカルでビルドを実行:
   ```bash
   npm run build
   ```

2. 確認事項:
   - ✅ TypeScriptの型エラーが発生しない
   - ✅ ビルドが正常に完了する

### 招待コードリセット機能の確認

1. 招待コード管理画面にアクセス (`/admin/invitation-code`)
2. 現在の使用回数が1以上であることを確認
3. 「リセット」ボタンをクリック
4. 確認ダイアログで「OK」を選択
5. 確認事項:
   - ✅ 「使用回数をリセットしました」というメッセージが表示される
   - ✅ 使用回数が0にリセットされている

## 技術的な詳細

### TypeScriptの型推論の問題

TypeScriptの型推論では、変数が常に同じ値（例: `null`）を持つ場合、その型を `never` 型として推論することがあります。これは、その値が変更される可能性がないと判断されるためです。

この問題を解決するには：
1. 型定義を明示的に指定する
2. 型アサーションを使用する
3. 変数の初期値を `null` ではなく `null as Error | null` のように型アサーション付きで定義する

### 招待コードリセット機能の設計変更

元の設計では「招待コードが変更された場合のみ使用回数をリセット」という仕様でしたが、これでは明示的なリセット操作ができないため、以下のように変更しました：

1. **招待コード変更時**: 自動的に使用回数がリセットされる（既存の仕様を維持）
2. **リセットボタン押下時**: `reset_usage_count: true` を指定することで、招待コードが変更されていなくても使用回数をリセット可能

この設計により、以下の2つのユースケースに対応できます：
- 招待コードを変更して新しいコードを発行する場合（自動リセット）
- 招待コードは変えずに使用回数だけをリセットしたい場合（明示的リセット）

## 関連ドキュメント

- [CHANGELOG.md](./CHANGELOG.md) - 変更履歴
- [新規登録制限機能の実装.md](./新規登録制限機能の実装.md) - 招待コード機能の実装詳細
- [Next.js16型エラー修正とVercelデプロイ対応.md](./Next.js16型エラー修正とVercelデプロイ対応.md) - 過去の型エラー修正事例
