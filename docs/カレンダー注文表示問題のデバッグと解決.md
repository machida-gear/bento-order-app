# カレンダー注文表示問題のデバッグと解決

## 問題の概要

2025-12-30 に実装したカレンダー注文表示機能で、以下の問題が発生しました：

1. **注文がある日にメニュー名と数量が表示されない**
2. **2026/01/01 に注文を入れたが、カレンダー上では「注文可」と表示されてしまう**

## 問題の症状

### ブラウザコンソールのログ

- `ordersMap keys: []` - 注文データがマップに存在しない
- `order found: false` - 注文が見つからない
- `order: undefined` - 注文が未定義
- `Should show button: true` - 「注文可」ボタンが表示される

### サーバー側のログ

- `Orders fetched: 0` - 注文データが取得できていない
- `All orders (without date filter): 0` - 日付フィルターなしでも取得できていない
- `Direct orders count: 0` - RLS ポリシーで取得できていない
- `Orders error: null` - エラーは発生していない

## デバッグの過程

### 1. データ取得ロジックの確認

#### 追加したデバッグログ

- `=== Calendar Date Range ===` - 日付範囲の確認
- `=== Order Fetching Debug ===` - 注文データ取得の確認
- `=== Authentication Debug ===` - 認証状態の確認
- `=== Session Debug ===` - セッション状態の確認
- `=== Executing orders query ===` - クエリ実行の確認
- `=== Test: All orders (no date filter) ===` - 日付フィルターなしでの取得確認
- `=== Auth Check ===` - 認証ユーザー ID の確認
- `=== Direct query (with RLS) ===` - RLS ポリシーでの取得確認
- `=== Admin query (RLS bypassed) ===` - Service Role Key での取得確認

### 2. 認証状態の確認

#### 確認結果

- ✅ 認証は正しく動作している
- ✅ User ID: `31dc22bf-0b07-4933-a67d-843bc9a5b6aa`
- ✅ Session も正しく取得できている
- ✅ `User ID match: true`

#### コード

```typescript
const {
  data: { user },
  error: authError,
} = await supabase.auth.getUser();
const {
  data: { session },
  error: sessionError,
} = await supabase.auth.getSession();
```

### 3. RLS ポリシーの確認

#### RLS ポリシーの定義

```sql
CREATE POLICY "orders_select_own"
    ON orders FOR SELECT
    USING (auth.uid() = user_id);
```

#### 確認方法

1. 通常のクライアント（RLS ポリシー適用）での取得
2. Service Role Key（RLS バイパス）での取得

### 4. データベースの確認

#### データベースの画像から確認できた情報

- `user_id`: `31dc22bf-0b07-4933-a67d-843bc...`
- `order_date`: `2026-01-01`
- `status`: `ordered`
- `menu_item_id`: `23`
- `quantity`: `1`

注文データはデータベースに存在しているが、アプリケーションから取得できていない。

## 考えられる原因

### 1. RLS ポリシーの問題

- `auth.uid()`が正しく取得できていない可能性
- RLS ポリシーが正しく適用されていない可能性

### 2. データベースの`user_id`と認証ユーザー ID の不一致

- データベースの`user_id`が認証ユーザー ID と一致していない可能性
- UUID の形式が異なる可能性

### 3. 日付の比較の問題

- `order_date`の型が`date`型で、文字列比較が正しく動作していない可能性
- タイムゾーンの問題

## 追加したデバッグコード

### Service Role Key を使用した直接確認

```typescript
// Service Role Keyを使用してRLSをバイパスして確認
const { createAdminClient } = await import("@/lib/supabase/admin");
const supabaseAdmin = createAdminClient();
const { data: adminOrders, error: adminError } = await supabaseAdmin
  .from("orders")
  .select("id, user_id, order_date, status, menu_item_id")
  .eq("user_id", user.id)
  .eq("status", "ordered")
  .limit(10);

console.log("=== Admin query (RLS bypassed) ===");
console.log("Admin orders count:", adminOrders?.length || 0);
if (adminOrders && adminOrders.length > 0) {
  console.log(
    "Admin orders:",
    adminOrders.map((o: any) => ({
      id: o.id,
      user_id: o.user_id,
      order_date: o.order_date,
      status: o.status,
      menu_item_id: o.menu_item_id,
    }))
  );
  // 2026-01-01の注文を確認
  const order20260101 = adminOrders.find(
    (o: any) => o.order_date === "2026-01-01"
  );
  if (order20260101) {
    console.log("✅ Found order for 2026-01-01:", order20260101);
  } else {
    console.log("❌ No order found for 2026-01-01");
    console.log(
      "Available order dates:",
      adminOrders.map((o: any) => o.order_date)
    );
  }
}
```

## 修正したファイル

### `app/(user)/calendar/page.tsx`

- 認証状態の確認ログを追加
- セッション状態の確認ログを追加
- Service Role Key を使用した直接確認を追加
- 日付フィルターなしでの取得確認を追加
- 詳細なデバッグログを追加

### `components/calendar-grid.tsx`

- 注文データの確認ログを追加
- 日付マッチングの確認ログを追加
- 注文可ボタン表示判定の確認ログを追加

## 次のステップ

1. **Service Role Key での確認結果を確認**

   - ターミナルログで`=== Admin query (RLS bypassed) ===`を確認
   - 注文データが取得できるか確認
   - 2026-01-01 の注文が存在するか確認

2. **原因の特定**

   - Service Role Key で取得できた場合：RLS ポリシーの問題
   - Service Role Key で取得できなかった場合：データベースのデータの問題

3. **修正の実施**
   - RLS ポリシーの問題の場合：ポリシーの修正または認証情報の確認
   - データベースのデータの問題の場合：データの確認と修正

## 参考

- [カレンダー注文表示機能の実装.md](./カレンダー注文表示機能の実装.md)
- [実際のデータベーススキーマ.md](./実際のデータベーススキーマ.md)
- [データベース構造の注意事項.md](./データベース構造の注意事項.md)

---

最終更新日: 2025-12-30
