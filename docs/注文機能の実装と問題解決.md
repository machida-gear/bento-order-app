# 注文機能の実装と問題解決

## 実装内容

### 注文フォームの実装

- メニュー選択 UI（業者別にグループ化）
- 数量入力フィールド
- 注文確定ボタン
- エラーメッセージの表示

### 注文 API の実装

- `app/api/orders/route.ts`: 注文作成 API
- バリデーション（メニュー ID、注文日、数量）
- 締切時刻のチェック
- 価格 ID 取得（`get_menu_price_id`関数を使用）
- 注文作成（Service Role Key を使用して RLS をバイパス）
- 監査ログ記録

## 発生した問題

### 問題 1: 注文確定ボタンが表示されない

**症状**:

- 新規注文画面で注文確定ボタンが表示されない

**原因**:

- 下部固定のナビゲーションバーがボタンを隠していた

**解決策**:

- `app/(user)/orders/new/page.tsx`に`pb-20`（下部パディング）を追加
- `components/order-form.tsx`のボタン部分に`pt-4 pb-4`を追加

### 問題 2: 注文確定ボタンを押しても 500 エラーが発生

**症状**:

- 注文確定ボタンを押すと、ブラウザのコンソールに 500 エラーが表示される
- エラーメッセージ: `注文の作成に失敗しました`

**原因の調査**:

1. `get_menu_price_id`関数が`menu_id`を使用しているが、実際のテーブルは`menu_item_id`を使用
2. 関数が正しく更新されていない可能性

**確認事項**:

- 価格データは存在している（039 の SQL 実行結果で確認）
- すべてのメニューに有効な価格データが設定されている
- メニュー ID=23（オムライス）の価格データ: price_id=9, price=700

## 解決手順

### 1. 関数の定義を確認

```sql
-- 040_test_get_menu_price_id_directly.sql を実行
```

この SQL で以下を確認：

- `get_menu_price_id`関数の定義（`menu_item_id`を使用しているか）
- 関数のテスト結果
- 手動での価格 ID 取得

### 2. 関数の修正

`get_menu_price_id`関数が`menu_id`を使用している場合、以下を実行：

```sql
-- 038_fix_get_menu_price_id_function.sql を実行
```

この SQL は以下を行います：

- 既存の関数を削除
- `menu_item_id`を使用するように関数を再作成

### 3. エラーハンドリングの改善

`app/api/orders/route.ts`に以下を追加：

- 詳細なエラーメッセージ
- デバッグログ（価格取得、注文作成の各ステップ）

## 作成した SQL ファイル

### 診断用 SQL

- `039_check_get_menu_availability.sql`: 関数の定義と価格データの確認用
- `040_test_get_menu_price_id_directly.sql`: 関数の直接テスト用
- `041_verify_function_and_fix.sql`: 関数の状態確認と修正案内用
- `042_check_function_definition_full.sql`: 関数の定義を完全に確認する用

### 修正用 SQL

- `038_fix_get_menu_price_id_function.sql`: `get_menu_price_id`関数の修正

## 修正したファイル

### アプリケーションコード

- `app/api/orders/route.ts`
  - エラーハンドリングの改善
  - デバッグログの追加
- `components/order-form.tsx`
  - デバッグログの追加
  - エラーメッセージの改善
  - ボタン周りのパディング追加
- `app/(user)/orders/new/page.tsx`
  - 下部パディングの追加（ナビゲーションバー対策）

## 確認事項

### 価格データの確認結果（039 の SQL 実行結果より）

すべてのメニューに有効な価格データが設定されている：

- メニュー ID=23（オムライス）: price_id=9, price=700, status=✅ 有効
- メニュー ID=29（チキンカツ定食）: price_id=15, price=800, status=✅ 有効
- その他すべてのメニューも有効な価格データが設定されている

### 関数の確認結果（042 の SQL 実行結果より）

- **関数のテスト**: メニュー ID=23、日付=2025-12-30 で関数を実行 → price_id=9 が正常に返された
- **手動での価格 ID 取得**: price_id=9, menu_item_id=23, price=700 が確認できた
- **結論**: 関数は正常に動作している

### 次のステップ

1. **動作確認**: 注文確定ボタンを押して、正常に注文が作成されるか確認
2. **エラーの確認**: もしエラーが発生する場合は、開発サーバーのコンソールログを確認
3. **関数の定義確認**: 042 の 2 番目のクエリ（`function_status`）で、関数が`menu_item_id`を使用しているか確認

## 学んだこと

1. **データベース関数の確認**: 関数の定義を確認する際は、`pg_get_functiondef`を使用する
2. **エラーハンドリング**: 詳細なエラーメッセージとログを追加することで、問題の特定が容易になる
3. **UI/UX**: 下部固定のナビゲーションバーがある場合、コンテンツに適切なパディングを追加する必要がある
4. **実際のスキーマとの整合性**: 初期スキーマと実際のデータベース構造が異なる場合があるため、実際のスキーマを確認することが重要

## 今後の対策

1. **関数のテスト**: 新しい関数を作成する際は、必ずテスト SQL を作成する
2. **エラーハンドリング**: 本番環境でも有用なエラーメッセージを返すようにする
3. **UI/UX の改善**: モバイル向けのレイアウトを考慮した設計
4. **スキーマの確認**: コードを書く前に、実際のデータベーススキーマを確認する

---

## 追加の修正（2025-12-30）

### データベーススキーマの確認による修正

実際のデータベーススキーマを確認した結果、以下の修正を実施しました：

1. **`orders`テーブルのカラム名修正**

   - `menu_id` → `menu_item_id`

2. **`orders`テーブルへの必須カラム追加**

   - `unit_price_snapshot`: 価格情報を取得して設定
   - `source`: 'manual'を設定（ENUM 値は要確認）

3. **`audit_logs`テーブルのカラム名修正**

   - `actor_user_id` → `actor_id`
   - `detail` → `details`
   - `target_table`と`target_id`カラムを追加

4. **エラーハンドリングの修正**
   - `.catch()`の誤用を修正（try-catch ブロックに変更）

詳細は [データベーススキーマに基づくコード修正.md](./データベーススキーマに基づくコード修正.md) を参照してください。

---

## 参考

- [メニュー表示問題の解決手順](./メニュー表示問題の解決手順.md)
- [データベース構造の注意事項](./データベース構造の注意事項.md)
- [実際のデータベーススキーマ.md](./実際のデータベーススキーマ.md)
- [データベーススキーマに基づくコード修正.md](./データベーススキーマに基づくコード修正.md)
