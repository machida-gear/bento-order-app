# カレンダーページ過去注文・ちらつき問題修正

## 問題

### 1. 過去の注文がクリックできる問題

- 締切時間を過ぎた過去の注文（1月4日、1月5日、1月9日など）をクリックできてしまう
- クリックすると一瞬画面が切り替わり、元に戻る不具合
- ただし、1月6日の注文のみグレーアウトされており、クリックできない状態になっていた
- その他の過去の注文は「変更可」と表示され、グレーになっておらず、クリックできてしまう

### 2. 月変更時の画面ちらつき

- 月を変更すると一度カレンダーが非表示になり、再表示してリサイズしているような挙動
- カレンダーが一瞬消えてから表示されるため、ユーザー体験が悪い

## 原因

### 1. 過去の注文がクリックできる問題の原因

1. **`CalendarCell`内の削除済み関数呼び出し**: `CalendarCell`コンポーネント内（行726）で、既に削除された`canEditOrder()`関数を呼び出していた
2. **`shouldBeGray`と`canEdit`の不一致**: `shouldBeGray: true`（グレーアウトすべき）と計算されているが、`canEdit`が`true`のためリンクが表示されていた
3. **`canEditOrderValue`が`CalendarCell`に正しく渡されていない**: `CalendarGrid`で計算した`canEditOrderValue`が`CalendarCell`にpropsとして渡されていたが、`CalendarCell`内で別途`canEditOrder()`を呼び出していたため、正しい値が使われていなかった

### 2. 月変更時のちらつきの原因

1. **コンポーネントの再マウント**: 年月が変更されると、親コンポーネントがサーバー側で再レンダリングされ、`CalendarGrid`コンポーネントも新しいインスタンスが作成される
2. **`useState`のリセット**: コンポーネントが再マウントされると、`useState`の値（`today`、`now`、`isMounted`）がリセットされる
3. **初期値の遅延**: `useEffect`が実行されるまで`isMounted`が`false`のままのため、空のカレンダーが表示される

## 解決策

### 1. 過去の注文がクリックできる問題の解決策

#### 1.1 `CalendarCell`内の削除済み関数呼び出しを削除

- `CalendarCell`コンポーネント内（行726）の`canEditOrder()`呼び出しを削除
- 代わりに、`shouldBeGray`と`canEditOrderValue`を直接チェックするように変更

**修正前:**
```typescript
onClick={(e) => {
  e.stopPropagation();
  const canEditNow = canEditOrder(); // 削除済みの関数を呼び出していた
  if (!canEditNow) {
    e.preventDefault();
    alert('締切時刻を過ぎているため、注文を変更できません');
  }
}}
```

**修正後:**
```typescript
onClick={(e) => {
  e.stopPropagation();
  // shouldBeGrayがtrueの場合、またはcanEditOrderValueがfalseの場合はクリックを防ぐ
  if (shouldBeGray || !canEditOrderValue) {
    e.preventDefault();
    alert('締切時刻を過ぎているため、注文を変更できません');
  }
}}
```

#### 1.2 `canEdit`の計算を修正

- `CalendarCell`コンポーネント内で、`shouldBeGray`が`true`の場合は`canEdit`を`false`にする

**修正前:**
```typescript
const canEdit = canEditOrderValue;
```

**修正後:**
```typescript
// shouldBeGrayがtrueの場合は、canEditOrderValueをfalseに上書き（グレーアウトされている場合編集不可）
const canEdit = shouldBeGray ? false : canEditOrderValue;
```

### 2. 月変更時のちらつきの解決策

#### 2.1 `localStorage`から初期値を復元

- `useState`の初期値を`localStorage`から復元する処理を追加
- `getInitialToday()`と`getInitialNow()`関数を作成し、`localStorage`から値を取得
- 保存された値が今日の日付であれば使用（1日以上古い値は使用しない）

**実装:**
```typescript
// 初期値をlocalStorageから復元（月変更時のちらつき防止）
const getInitialToday = (): Date | null => {
  if (typeof window === 'undefined') return null;
  try {
    const savedToday = localStorage.getItem('calendar_today');
    if (savedToday) {
      const savedTodayDate = new Date(savedToday);
      // 保存された値が今日の日付であれば使用（1日以上古い値は使用しない）
      const todayStr = `${new Date().getFullYear()}-${String(new Date().getMonth() + 1).padStart(2, "0")}-${String(new Date().getDate()).padStart(2, "0")}`;
      const savedTodayStr = `${savedTodayDate.getFullYear()}-${String(savedTodayDate.getMonth() + 1).padStart(2, "0")}-${String(savedTodayDate.getDate()).padStart(2, "0")}`;
      if (savedTodayStr === todayStr) {
        return savedTodayDate;
      }
    }
  } catch (e) {
    // localStorageが使用できない場合は無視
  }
  return null;
};

const getInitialNow = (): Date | null => {
  if (typeof window === 'undefined') return null;
  try {
    const savedNow = localStorage.getItem('calendar_now');
    if (savedNow) {
      return new Date(savedNow);
    }
  } catch (e) {
    // localStorageが使用できない場合は無視
  }
  return null;
};

const initialToday = getInitialToday();
const initialNow = getInitialNow();

const [today, setToday] = useState<Date | null>(initialToday);
const [now, setNow] = useState<Date | null>(initialNow);
const [isMounted, setIsMounted] = useState(!!(initialToday && initialNow));
```

#### 2.2 `localStorage`への値の保存

- `useEffect`内で、`today`と`now`を`localStorage`に保存
- これにより、コンポーネントが再マウントされても、前回の値を復元できる

**実装:**
```typescript
useEffect(() => {
  // ... 既存の処理 ...
  
  // localStorageに値を保存（月変更時のちらつき防止）
  try {
    localStorage.setItem('calendar_today', currentDate.toISOString());
    localStorage.setItem('calendar_now', currentNow.toISOString());
  } catch (e) {
    // localStorageが使用できない場合は無視
  }
}, []);
```

#### 2.3 年月変更時の値復元処理

- 年月が変更されたときに、`localStorage`から値を復元する処理を追加

**実装:**
```typescript
// 年月が変更されたときに、localStorageから値を復元（ちらつき防止）
useEffect(() => {
  if (!isMounted && typeof window !== 'undefined') {
    // localStorageから値を復元
    try {
      const savedToday = localStorage.getItem('calendar_today');
      const savedNow = localStorage.getItem('calendar_now');
      if (savedToday && savedNow) {
        const savedTodayDate = new Date(savedToday);
        const savedNowDate = new Date(savedNow);
        // 保存された値が今日の日付であれば使用（1日以上古い値は使用しない）
        const todayStr = `${new Date().getFullYear()}-${String(new Date().getMonth() + 1).padStart(2, "0")}-${String(new Date().getDate()).padStart(2, "0")}`;
        const savedTodayStr = `${savedTodayDate.getFullYear()}-${String(savedTodayDate.getMonth() + 1).padStart(2, "0")}-${String(savedTodayDate.getDate()).padStart(2, "0")}`;
        if (savedTodayStr === todayStr) {
          setToday(savedTodayDate);
          setNow(savedNowDate);
          todayRef.current = savedTodayDate;
          nowRef.current = savedNowDate;
          setIsMounted(true);
          return;
        }
      }
    } catch (e) {
      // localStorageが使用できない場合は無視
    }
    
    // localStorageに値がない場合は新規作成
    const currentDate = new Date();
    const currentNow = new Date();
    todayRef.current = currentDate;
    nowRef.current = currentNow;
    setToday(currentDate);
    setNow(currentNow);
    setIsMounted(true);
    
    // localStorageに値を保存
    try {
      localStorage.setItem('calendar_today', currentDate.toISOString());
      localStorage.setItem('calendar_now', currentNow.toISOString());
    } catch (e) {
      // localStorageが使用できない場合は無視
    }
  }
}, [year, month]);
```

## 修正ファイル

### `components/calendar-grid.tsx`

1. **`CalendarCell`内の削除済み関数呼び出しを削除**:
   - 行726の`canEditOrder()`呼び出しを削除
   - `shouldBeGray`と`canEditOrderValue`を直接チェックするように変更

2. **`canEdit`の計算を修正**:
   - `shouldBeGray`が`true`の場合は`canEdit`を`false`にする

3. **`localStorage`から初期値を復元**:
   - `getInitialToday()`と`getInitialNow()`関数を追加
   - `useState`の初期値を`localStorage`から復元するように変更

4. **`localStorage`への値の保存**:
   - `useEffect`内で`today`と`now`を`localStorage`に保存

5. **年月変更時の値復元処理**:
   - 年月が変更されたときに、`localStorage`から値を復元する`useEffect`を追加

## 確認事項

### 過去の注文がクリックできる問題

- ✅ 過去の注文（1月4日、1月5日、1月9日など）がグレーアウトされている
- ✅ 過去の注文をクリックできない（アラートが表示される）
- ✅ `shouldBeGray: true`の場合、`canEdit`が`false`になる
- ✅ `canEditOrderValue: false`の場合、リンクが表示されない

### 月変更時のちらつき

- ✅ 月を変更したときに、カレンダーがちらつかない
- ✅ `localStorage`から値を復元できている
- ✅ `isMounted`が`true`になり、空のカレンダーが表示されない

## 注意事項

### `localStorage`の使用

- **ブラウザ対応**: `localStorage`はすべてのモダンブラウザでサポートされていますが、プライベートモードでは使用できない場合があります
- **エラーハンドリング**: `localStorage`が使用できない場合は、エラーを無視して新規作成する処理にフォールバックします
- **データの有効期限**: 保存された値が今日の日付でない場合（1日以上古い場合）は、新規作成するようにしています

### コンポーネントの再マウント

- **Next.js App Router**: URLパラメータ（`year`、`month`）が変更されると、サーバー側で再レンダリングされるため、クライアントコンポーネントも再マウントされます
- **状態の保持**: `localStorage`を使用することで、コンポーネントが再マウントされても前回の値を復元できます

### パフォーマンス

- **初期値の復元**: `localStorage`からの値の取得は同期的に行われるため、初期レンダリングに影響を与えません
- **値の保存**: `localStorage`への値の保存は非同期ではありませんが、実行時間は短いため、パフォーマンスへの影響は無視できます

---

**関連ドキュメント**:
- [CHANGELOG.md](./CHANGELOG.md) - 変更履歴
- [PROGRESS.md](./PROGRESS.md) - 進捗状況
- [カレンダーページHydration Mismatchエラー修正.md](./カレンダーページHydration Mismatchエラー修正.md) - 関連する修正
- [カレンダーページ全日付グレーアウト問題修正.md](./カレンダーページ全日付グレーアウト問題修正.md) - 関連する修正