# ダッシュボード集計修正とユーザー管理画面改善

## ダッシュボードの承認待ちユーザー数・アクティブユーザー数の修正

### 問題

- 承認待ちユーザーが1名いるのに、ダッシュボードの承認待ちが0人と表示される
- 承認後、アクティブユーザーが増加せず、承認前と同じ人数のまま

### 原因

1. **RLSポリシーの影響**
   - ダッシュボードで通常のSupabaseクライアント（`createClient()`）を使用していた
   - RLSポリシーの影響で、全ユーザーを取得できない場合があった

2. **承認待ちユーザーの定義が不適切**
   - `is_active = false`のみでフィルタリングしていた
   - 退職者（`left_date`が過去の日付）も承認待ちに含まれていた

### 解決策

#### 1. Service Role Keyの使用

- ダッシュボードで`supabaseAdmin`（Service Role Key）を使用してRLSをバイパス
- アクティブユーザー数、承認待ちユーザー数、アクティブ業者数、アクティブメニュー数を取得

#### 2. 承認待ちユーザー数の条件修正

- **以前**: `is_active = false`のみ（退職者も含まれていた）
- **修正後**: `is_active = false` かつ `left_date`が未設定または未来の日付

### 修正ファイル

- `app/admin/page.tsx`: Service Role Keyを使用、承認待ちユーザー数の条件を修正
- `app/api/admin/users/pending/route.ts`: 承認待ちユーザーの条件を修正

### 確認事項

- ✅ ダッシュボードで承認待ちユーザー数が正しく表示される
- ✅ 承認後にアクティブユーザー数が増加する

---

## ユーザー管理画面の有効/無効切り替え表示機能

### 問題

- 退職者がたくさんリストにいると見にくい
- 有効なユーザーをすぐに確認したい

### 実装内容

ユーザー管理画面を「有効なユーザー」「無効なユーザー」「承認待ち」の3つのタブに分割しました。

#### 1. 有効なユーザータブ

- **表示対象**: `is_active = true`のユーザーのみ
- **操作**: 通常の操作（編集、カレンダー、削除）が可能
- **UI**: 「状態」列を削除（すべて有効のため）

#### 2. 無効なユーザータブ

- **表示対象**: `is_active = false`かつ退職日が設定されているユーザー（退職者を含む）
- **操作**: 編集のみ可能（カレンダーや削除ボタンは非表示）
- **UI**: グレーアウト表示（`opacity-75`）

#### 3. 承認待ちタブ

- **表示対象**: `is_active = false`かつ退職日が未設定または未来のユーザー
- **操作**: 承認・編集・削除（拒否）が可能

### UI改善

- 各タブにユーザー数を表示（例: 「有効なユーザー (10)」）
- 無効なユーザーの行をグレーアウト表示して視認性を向上
- 退職者が多くても有効なユーザーをすぐに確認可能

### 修正ファイル

- `app/admin/users/page.tsx`: タブ切り替え機能を3つに分割、表示ロジックを改善

### 確認事項

- ✅ 有効なユーザーと無効なユーザーを切り替えて表示できる
- ✅ 退職者が多くても見やすくなった
