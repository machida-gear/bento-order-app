# 新規注文画面のメニュー表示問題の解決手順

## 問題の概要

新規注文画面（`/orders/new`）で「選択可能なメニューがありません」と表示され、メニューが選択できない状態でした。

## 症状

- 新規注文画面で「選択可能なメニューがありません」と表示される
- データベースには業者とメニューのデータが存在している
- Supabase SQL Editorからはデータが取得できる
- アプリケーションからはデータが取得できない（空配列が返される）

## 原因

1. **RLSポリシーの欠如**
   - `vendors`テーブルと`menu_items`テーブルにRLSポリシーが設定されていなかった
   - 初期スキーマ（`001_initial_schema.sql`）では`menus`テーブル向けのポリシーが定義されていたが、実際のテーブル名は`menu_items`だった

2. **クエリロジックの問題**
   - `vendors`とのJOINを使用していたため、RLSポリシーが干渉していた可能性

## 解決手順

### 1. 問題の診断

まず、データベースの状態を確認しました：

```sql
-- 031_check_menu_availability.sql を実行
```

このSQLで以下を確認：
- 有効な業者の存在
- 有効なメニューの存在
- 業者とメニューの関連
- 価格データの存在

**結果**: データは存在していた（業者3件、メニュー12件）

### 2. RLSポリシーの確認

次に、RLSポリシーの設定を確認しました：

```sql
-- 032_check_rls_policies.sql を実行
-- 034_verify_menu_items_policy.sql を実行
-- 035_check_vendors_policy.sql を実行
```

**結果**: `menu_items`テーブルと`vendors`テーブルにRLSポリシーが存在しないことが判明

### 3. RLSポリシーの作成

RLSポリシーを作成しました：

```sql
-- 033_create_menu_items_select_policy.sql を実行
-- 036_create_vendors_select_policy.sql を実行
```

これらのSQLは以下を行います：
- テーブルでRLSを有効化
- 管理者用の全権限ポリシーを作成
- 一般ユーザー用のSELECTポリシーを作成（`is_active = true`のレコードのみ参照可能）

### 4. クエリロジックの改善

アプリケーション側のクエリロジックを改善しました：

**変更前**:
```typescript
const { data: menuItems } = await supabase
  .from('menu_items')
  .select(`
    *,
    vendors (
      id,
      name
    )
  `)
  .eq('is_active', true)
  .in('vendor_id', vendorIds)
```

**変更後**:
```typescript
const result = await supabase
  .from('menu_items')
  .select('*')
  .eq('is_active', true)
  .in('vendor_id', vendorIds)
```

- JOINを削除し、メニューを直接取得
- `menu.vendor_id`を使用して業者別にグループ化

### 5. 型定義の修正

`OrderForm`コンポーネントの型定義を修正しました：

**変更前**:
```typescript
type MenuItem = Database['public']['Tables']['menu_items']['Row'] & {
  vendors?: {
    id: number
    name: string
  } | null
}
```

**変更後**:
```typescript
type MenuItem = Database['public']['Tables']['menu_items']['Row']
```

## 作成したSQLファイル

### 診断用SQL
- `031_check_menu_availability.sql`: メニュー表示問題の診断用
- `032_check_rls_policies.sql`: RLSポリシーの確認用
- `034_verify_menu_items_policy.sql`: `menu_items`テーブルのRLSポリシー検証用
- `035_check_vendors_policy.sql`: `vendors`テーブルのRLSポリシー確認用
- `037_check_auth_and_profile.sql`: 認証状態とプロフィールの確認用

### 修正用SQL
- `033_create_menu_items_select_policy.sql`: `menu_items`テーブルのRLSポリシー作成
- `036_create_vendors_select_policy.sql`: `vendors`テーブルのRLSポリシー作成

## 修正したファイル

### アプリケーションコード
- `app/(user)/orders/new/page.tsx`
  - クエリロジックの改善（JOINの削除）
  - デバッグコードの削除
- `components/order-form.tsx`
  - 型定義の修正
  - デバッグコードの削除

## 確認事項

問題解決後、以下を確認しました：

1. **データの取得**: 業者3件、メニュー12件が正しく取得できている
2. **画面表示**: 新規注文画面でメニューが正しく表示される
3. **RLSポリシー**: 一般ユーザーは`is_active = true`のレコードのみ参照可能

## 学んだこと

1. **RLSポリシーの重要性**: データベースにデータが存在していても、RLSポリシーが設定されていないとアプリケーションから取得できない
2. **テーブル名の確認**: 初期スキーマと実際のテーブル名が異なる場合があるため、実際のテーブル構造を確認することが重要
3. **JOINとRLS**: JOINを使用する場合、RLSポリシーが干渉する可能性があるため、シンプルなクエリを使用する方が安全

## 今後の対策

1. **マイグレーション時の確認**: 新しいテーブルを作成する際は、必ずRLSポリシーも作成する
2. **テストの追加**: アプリケーションからデータが取得できることを確認するテストを追加する
3. **ドキュメントの更新**: テーブル名やカラム名の違いをドキュメントに記録する

---

## 参考

- [Supabase Row Level Security (RLS)](https://supabase.com/docs/guides/auth/row-level-security)
- [データベース構造の注意事項](./データベース構造の注意事項.md)
