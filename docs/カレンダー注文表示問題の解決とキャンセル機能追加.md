# カレンダー注文表示問題の解決とキャンセル機能追加

## 日付

2025-12-31

## 概要

カレンダー画面で注文が表示されない問題を解決し、注文編集画面にキャンセル機能を追加しました。

---

## 1. カレンダー注文表示問題の解決

### 問題の症状

- 2026/01/01 に注文を入れたが、カレンダー上では「注文可」と表示されてしまう
- 注文がある日にメニュー名と数量が表示されない
- サーバー側ログ: `Orders fetched: 0`、`All orders (without date filter): 0`
- Service Role Key では注文データが取得できていた（`Admin orders count: 2`）

### 原因の特定

1. **createAdminClient エラー**

   - `lib/supabase/admin.ts` では `supabaseAdmin` が直接エクスポートされている
   - `createAdminClient()` 関数は存在しない

2. **RLS ポリシーの問題**
   - RLS ポリシーは正しく設定されていたが、実際のデータベースでは `profiles` テーブルを使用
   - 初期スキーマでは `users_profile` を参照していた可能性

### 解決策

#### 1. createAdminClient エラーの修正

**ファイル**: `app/(user)/calendar/page.tsx`

**修正前:**

```typescript
const { createAdminClient } = await import("@/lib/supabase/admin");
const supabaseAdmin = createAdminClient();
```

**修正後:**

```typescript
const { supabaseAdmin } = await import("@/lib/supabase/admin");
```

#### 2. RLS ポリシーの確認と修正

**ファイル**: `supabase/migrations/045_check_and_fix_orders_rls.sql`

- RLS ポリシーの状態を確認
- `profiles` テーブルを参照するように RLS ポリシーを再作成
- RLS が有効になっていることを確認

**実行内容:**

- `orders_select_own`: 自分の注文のみ参照可能
- `orders_insert_own`: 自分の注文のみ作成可能
- `orders_update_own`: 自分の注文のみ更新可能
- `orders_all_admin`: 管理者は全注文を参照・更新可能

### 確認結果

- ✅ 認証は正しく動作している
- ✅ Service Role Key で注文データが取得できることを確認
- ✅ RLS ポリシーが正しく設定されていることを確認
- ✅ カレンダー画面で注文が正しく表示される

---

## 2. 注文キャンセル機能の追加

### 実装内容

注文編集画面に「注文を取りやめる」ボタンを追加し、キャンセル機能を実装しました。

**ファイル**: `components/order-edit-form.tsx`

**機能:**

- 「注文を取りやめる」ボタン（赤色）
- 確認ダイアログ（「本当に注文を取りやめますか？」）
- キャンセル API（`PATCH /api/orders/[id]`）を呼び出し
- 成功後、カレンダーページにリダイレクト

### 問題と解決

#### enum 型の不一致エラー

**エラーメッセージ:**

```
invalid input value for enum order_status: "cancelled"
PostgreSQL error code: 22P02
```

**原因:**

- データベースの enum 型は `canceled`（1 つの 'l'）
- コードでは `cancelled`（2 つの 'l'）を使用していた

**確認方法:**

```sql
-- 046_check_order_status_enum.sql を実行
SELECT
    t.typname AS enum_name,
    array_agg(e.enumlabel ORDER BY e.enumsortorder) AS enum_values
FROM pg_type t
JOIN pg_enum e ON t.oid = e.enumtypid
WHERE t.typname = 'order_status'
GROUP BY t.typname;
```

**結果:**

- enum 値: `{ordered, canceled}`

**修正内容:**

1. **`app/api/orders/[id]/route.ts`** - 3 箇所

   - キャンセル済みチェック: `'cancelled'` → `'canceled'`
   - ステータス更新: `status: 'cancelled'` → `status: 'canceled'`

2. **`app/(user)/orders/page.tsx`** - 2 箇所

   - キャンセル済み表示判定: `'cancelled'` → `'canceled'`

3. **`lib/database.types.ts`** - 型定義
   - `OrderStatus` 型: `"cancelled"` → `"canceled"`

### 確認結果

- ✅ 注文編集画面から注文の変更ができる
- ✅ 注文編集画面から注文のキャンセルができる
- ✅ キャンセル後、カレンダー画面で注文が消える

---

## 3. コードのクリーンアップ

デバッグログを削除してコードをクリーンアップしました。

**修正ファイル:**

- `app/(user)/calendar/page.tsx`: デバッグログを削除
- `components/calendar-grid.tsx`: デバッグログを削除

---

## 4. 診断用 SQL の作成

### 046_check_order_status_enum.sql

enum 型の値を確認する SQL

### 047_add_cancelled_to_order_status_enum.sql

enum 型に値を追加する SQL（未使用、参考用）

---

## 修正ファイル一覧

### コードファイル

- `app/(user)/calendar/page.tsx`: Service Role Key のインポート方法を修正、デバッグログを削除
- `components/calendar-grid.tsx`: デバッグログを削除
- `components/order-edit-form.tsx`: キャンセル機能を追加
- `app/api/orders/[id]/route.ts`: enum 型の不一致を修正、エラーハンドリングを改善
- `app/(user)/orders/page.tsx`: enum 型の不一致を修正
- `lib/database.types.ts`: 型定義を修正

### マイグレーションファイル

- `supabase/migrations/045_check_and_fix_orders_rls.sql`: RLS ポリシー確認・修正用 SQL
- `supabase/migrations/046_check_order_status_enum.sql`: enum 型確認用 SQL
- `supabase/migrations/047_add_cancelled_to_order_status_enum.sql`: enum 型追加用 SQL（参考用）

### ドキュメント

- `docs/CHANGELOG.md`: 変更履歴を追加
- `docs/SPEC.md`: enum 型の値を更新
- `docs/DECISIONS.md`: enum 型の値を更新
- `docs/実際のデータベーススキーマ.md`: enum 型の値を更新

---

## 学んだこと

1. **実際のデータベース構造の確認の重要性**

   - 初期スキーマと実際のデータベース構造が異なる場合がある
   - enum 型の値も実際のデータベースで確認する必要がある

2. **RLS ポリシーのデバッグ方法**

   - Service Role Key を使用して RLS をバイパスして確認
   - 通常のクライアントと Service Role Key の結果を比較

3. **PostgreSQL の enum 型**
   - enum 型に値を追加する際は、既存の値の後に追加される
   - 値の順序は変更できない

---

## 参考資料

- [カレンダー注文表示問題のデバッグと解決.md](./カレンダー注文表示問題のデバッグと解決.md)
- [実際のデータベーススキーマ.md](./実際のデータベーススキーマ.md)
- [データベース構造の注意事項.md](./データベース構造の注意事項.md)
