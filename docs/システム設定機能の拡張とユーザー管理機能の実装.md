# システム設定機能の拡張とユーザー管理機能の実装

このドキュメントでは、システム設定機能の拡張（月末締め対応、最大注文可能日数設定）とユーザー管理機能の実装について記録します。

> 📖 **関連ドキュメント**: [README.md](./README.md) - すべてのドキュメントへの参照

---

## 実装日

2025-01-XX

---

## 実装内容

### 1. システム設定の締め日を月末締めに対応

#### 問題

- システム設定の締め日が 1 ～ 31 日の固定日付のみ設定可能
- 月末締め（月によって 28 ～ 31 日）を設定できない

#### 解決策

- `closing_day`カラムを NULL 許可に変更（NULL = 月末締め）
- システム設定画面に「指定日」と「月末締め」のラジオボタンを追加
- 「指定日」選択時のみ 1 ～ 31 日の入力欄を表示

#### 実装詳細

1. **データベーススキーマの更新**

   - `052_allow_null_closing_day_for_month_end.sql`を作成
   - `closing_day`カラムを NULL 許可に変更
   - CHECK 制約を更新（NULL または 1 ～ 31 の範囲）

2. **システム設定画面の更新**

   - ラジオボタンで「指定日」と「月末締め」を選択可能に
   - 「指定日」選択時のみ 1 ～ 31 日の入力欄を表示
   - 説明文を追加

3. **API のバリデーション更新**
   - `closing_day`が`null`の場合も許可するように更新

#### 修正ファイル

- `supabase/migrations/052_allow_null_closing_day_for_month_end.sql`（新規作成）
- `app/admin/settings/page.tsx`（UI 更新）
- `app/api/admin/settings/route.ts`（バリデーション更新）

---

### 2. システム設定画面の締め日入力欄の修正

#### 問題

- 指定日を選択した場合、十の位の数字が 2 で固定されていて変更できない

#### 解決策

- 入力タイプを`type="number"`から`type="text"`に変更
- `inputMode="numeric"`と`pattern="[0-9]*"`を追加
- 数値のみを許可する正規表現チェックを追加
- 空文字の場合も一時的に状態を更新できるように改善

#### 修正ファイル

- `app/admin/settings/page.tsx`（入力欄の修正）

---

### 3. カレンダー設定の一括設定時のエラー修正

#### 問題

- カレンダー設定で一括設定を実行すると、締切時刻の形式エラーが発生
- エラーメッセージ: 「締切時刻の形式が正しくありません (HH:MM 形式で入力してください)」

#### 原因

- データベースから取得した`default_deadline_time`が`HH:MM:SS`形式（例：`10:00:00`）
- API が`HH:MM`形式を期待していた

#### 解決策

- 月一括編集と複数日一括編集で、`formatTime()`関数を使用して`HH:MM`形式に変換してから送信

#### 修正ファイル

- `app/admin/calendar/page.tsx`（`formatTime()`関数の適用）

---

### 4. 最大注文可能日数の設定機能追加

#### 実装内容

- システム設定に「最大注文可能日数」設定項目を追加
- 1 ～ 365 日の範囲で設定可能（デフォルト: 30 日）
- 設定日数を超える未来の日付の「注文可」ボタンをグレーアウト表示

#### 実装詳細

1. **データベーススキーマの更新**

   - `053_add_max_order_days_ahead.sql`を作成
   - `system_settings`テーブルに`max_order_days_ahead`カラムを追加（INTEGER 型、1 ～ 365 日、デフォルト 30 日）

2. **システム設定画面の更新**

   - 「最大注文可能日数」設定項目を追加
   - 1 ～ 365 日の範囲で設定可能
   - 説明文を追加

3. **カレンダー画面の更新**

   - システム設定から`max_order_days_ahead`を取得
   - `CalendarGrid`コンポーネントに渡す
   - 設定日数を超える未来の日付の「注文可」ボタンをグレーアウト表示

4. **注文画面・API の更新**
   - 注文画面（`/orders/new`）で日数制限をチェック
   - 注文 API（`/api/orders`）で日数制限をチェック
   - 制限を超える場合はエラーメッセージを返す

#### 修正ファイル

- `supabase/migrations/053_add_max_order_days_ahead.sql`（新規作成）
- `app/admin/settings/page.tsx`（設定項目追加）
- `app/api/admin/settings/route.ts`（バリデーション追加）
- `app/(user)/calendar/page.tsx`（システム設定取得）
- `components/calendar-grid.tsx`（日数制限チェックとグレーアウト表示）
- `app/(user)/orders/new/page.tsx`（日数制限チェック）
- `app/api/orders/route.ts`（日数制限チェック）

---

### 5. 注文不可設定時のグレーアウトボタン非表示

#### 実装内容

- 最大注文可能日数を超えた日付について、注文不可設定（`is_available === false`）の場合は、グレーアウトした「注文可」ボタンも表示しない

#### 表示ロジック

1. **注文可能な場合**（`canOrder === true`）

   - 通常の緑色の「注文可」ボタンを表示

2. **最大日数を超えているが、注文可能設定の場合**（`exceedsMaxDays === true` かつ `is_available !== false`）

   - グレーアウトした「注文可」ボタンを表示（日数制限で注文できないことを示す）

3. **注文不可設定の場合**（`is_available === false`）
   - グレーアウトボタンも含めて何も表示しない

#### 修正ファイル

- `components/calendar-grid.tsx`（表示ロジックの更新）

---

### 6. 管理画面ナビゲーションから「締日設定」メニューを削除

#### 実装内容

- 管理画面の左側ナビゲーションから「締日設定」メニュー項目を削除
- 締日設定はシステム設定画面（`/admin/settings`）の「締め日（毎月）」セクションから行えるため

#### 修正ファイル

- `components/admin-nav.tsx`（メニュー項目の削除）

---

### 7. ユーザー管理画面の実装

#### 実装内容

- ユーザー管理画面（`/admin/users`）を作成
- ユーザー一覧表示（社員コード、氏名、メール、権限、入社日、退職日、状態）
- ユーザー編集機能
- ユーザー削除機能（`is_active = false`に設定）

#### 実装詳細

1. **ユーザー管理画面**

   - `app/admin/users/page.tsx`を作成
   - ユーザー一覧表示
   - ユーザー編集フォーム
   - 新規作成ボタン（UI のみ、実装は認証画面から行うことを推奨）

2. **ユーザー管理 API**

   - `GET /api/admin/users` - ユーザー一覧取得
   - `PUT /api/admin/users/[id]` - ユーザー更新
   - `DELETE /api/admin/users/[id]` - ユーザー削除（`is_active = false`に設定）

3. **機能詳細**
   - 社員コードの重複チェック
   - 社員コードは 4 桁の数字のみ許可
   - 退職日を設定すると自動的に`is_active = false`に設定
   - 自分自身を削除できないようにチェック
   - Service Role Key を使用して RLS をバイパス

#### 注意事項

- 新規ユーザー作成は、Supabase Auth との連携が必要なため、現在はエラーメッセージを返します
- 新規ユーザーは認証画面（`/login`）から新規登録を行い、その後この画面で情報を編集してください
- 将来的に、管理者がメールアドレスとパスワードを設定してユーザーを作成する機能を追加することも可能です

#### 実装ファイル

- `app/admin/users/page.tsx`（新規作成）
- `app/api/admin/users/route.ts`（新規作成）
- `app/api/admin/users/[id]/route.ts`（新規作成）

---

## 確認事項

- ✅ システム設定画面で月末締めを設定できる
- ✅ システム設定画面で締め日の十の位を自由に入力できる
- ✅ カレンダー設定の一括設定が正常に動作する
- ✅ システム設定画面で最大注文可能日数を設定できる
- ✅ カレンダー画面で設定日数を超える未来の日付の「注文可」ボタンがグレーアウト表示される
- ✅ 注文不可設定の日付には「注文可」ボタンが表示されない
- ✅ 管理画面ナビゲーションから「締日設定」メニューが削除されている
- ✅ ユーザー管理画面でユーザーの編集・削除ができる

---

## マイグレーションファイル

以下のマイグレーションファイルが作成されました：

1. `supabase/migrations/052_allow_null_closing_day_for_month_end.sql`

   - `closing_day`カラムを NULL 許可に変更

2. `supabase/migrations/053_add_max_order_days_ahead.sql`
   - `max_order_days_ahead`カラムを追加

---

## 関連ドキュメント

- [CHANGELOG.md](./CHANGELOG.md) - 変更履歴
- [PROGRESS.md](./PROGRESS.md) - 進捗状況
- [SPEC.md](./SPEC.md) - システム仕様書
- [カレンダー管理機能の改善とシステム設定機能の実装.md](./カレンダー管理機能の改善とシステム設定機能の実装.md) - システム設定機能の初期実装
