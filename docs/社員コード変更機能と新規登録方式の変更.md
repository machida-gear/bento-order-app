# 社員コード変更機能と新規登録方式の変更

このドキュメントでは、社員コード変更機能の実装と新規登録方式の変更（承認方式への移行）について詳細を記録します。

> 📖 **関連ドキュメント**: [README.md](./README.md) - すべてのドキュメントへの参照

---

## 実装の背景

### 社員コード変更機能の必要性

- 登録時に間違えて社員コードを入力してしまうことがある
- 間違った社員コードは将来使う予定の番号であるため、修正後に再利用したい
- 誤った社員コードで注文なども一度でもしてしまっていた場合、不整合が起きないか心配

### 新規登録方式の変更の必要性

- 社員コードマスターへの事前登録が手間がかかる
- 新規登録された社員の情報が正しいか管理者が確認してから承認する方式のほうが良い
- 新規ユーザー登録がされたら、管理者が気づくような通知機能が必要

---

## 実装内容

### 1. 社員コード変更機能

#### 実装内容

- 管理者がユーザーの社員コードを変更可能にする機能を実装
- 変更時に古い社員コードを`employee_codes`テーブルで解放（`is_registered = false`、`registered_user_id = NULL`）
- 新しい社員コードを`employee_codes`テーブルでチェック（未登録のみ許可）
- 監査ログに変更前後の社員コードを記録（`old_employee_code`、`new_employee_code`、`employee_code_changed`）

#### 技術的な詳細

- `app/api/admin/users/[id]/route.ts`のPUTメソッドを修正
- 社員コード変更時に`employee_codes`テーブルを更新
- 変更前の社員コードを取得して、変更時に解放処理を実行
- 新しい社員コードが`employee_codes`テーブルに存在する場合、未登録のみ許可

#### データ整合性の確認

- **注文データ**: `orders`テーブルは`user_id`（UUID）で参照しているため、社員コードを変更しても整合性は保たれる
- **CSV/PDF出力**: その時点の`profiles`テーブルの社員コードが表示される（過去の注文でも現在の社員コードが表示される）
- **監査ログ**: 変更前後の社員コードが記録されるため、履歴として問題ない

#### 実装ファイル

- `app/api/admin/users/[id]/route.ts`: 社員コード変更機能の実装

---

### 2. 新規登録方式の変更

#### 実装内容

- **社員コードマスター方式の廃止**: 事前に社員コードマスターに登録する方式を廃止
- **承認方式への変更**: 新規登録時は`is_active = false`（承認待ち）に設定し、管理者が承認すると`is_active = true`にする
- **新規登録時の通知**: 新規登録時に監査ログに記録（`user.signup.pending`アクション）
- **ログイン時の承認待ちチェック**: ログイン時に承認待ちユーザーを検出し、適切なメッセージを表示

#### 変更内容

- `app/api/auth/signup/route.ts`: 社員コードマスター方式のチェックを削除、新規登録時は`is_active = false`に設定
- `app/(auth)/login/page.tsx`: ログイン時の承認待ちチェックを追加
- 新規登録時のメッセージを「管理者の承認をお待ちください」に変更

#### 実装ファイル

- `app/api/auth/signup/route.ts`: 新規登録方式の変更
- `app/(auth)/login/page.tsx`: ログイン時の承認待ちチェック

---

### 3. 承認待ちユーザー管理機能

#### 実装内容

- **承認待ちユーザー一覧画面**: ユーザー管理画面に「承認待ち」タブを追加
- **承認機能**: 管理者が承認待ちユーザーを承認（`is_active = true`に設定）
- **削除（拒否）機能**: 管理者が承認待ちユーザーを削除（物理削除）
- **ダッシュボード表示**: ダッシュボードに承認待ちユーザー数を表示

#### 実装詳細

1. **承認待ちユーザー一覧取得API** (`GET /api/admin/users/pending`)
   - `is_active = false`のユーザー一覧を取得
   - 登録日時順（新しい順）で表示

2. **ユーザー承認API** (`POST /api/admin/users/[id]/approve`)
   - 承認待ちユーザーを承認（`is_active = true`に設定）
   - 社員コードの重複チェックを実行
   - 監査ログに記録（`user.approve`アクション）

3. **承認待ちユーザー削除API** (`POST /api/admin/users/[id]/reject`)
   - 承認待ちユーザーを物理削除
   - 削除前に、関連する注文、自動注文設定、自動注文テンプレートを削除
   - `employee_codes`テーブルで社員コードを解放
   - Supabase Authのユーザーを削除
   - `profiles`テーブルのレコードを削除
   - 監査ログに記録（`user.reject`アクション）

4. **UI実装**
   - ユーザー管理画面に「承認待ち」タブを追加
   - 承認待ちユーザー一覧を表示（社員コード、氏名、メール、登録日時）
   - 「承認」「編集」「削除」ボタンを表示
   - ダッシュボードに承認待ちユーザー数を表示

#### 外部キー制約の問題と解決

- **問題**: 承認待ちユーザーを削除しようとすると、`orders`テーブルに外部キー制約があるため削除できない
- **解決策**: 削除前に、関連する注文、自動注文設定、自動注文テンプレートを削除してから、`profiles`テーブルと認証ユーザーを削除

#### 実装ファイル

- `app/api/admin/users/pending/route.ts`: 承認待ちユーザー一覧取得API（新規作成）
- `app/api/admin/users/[id]/approve/route.ts`: ユーザー承認API（新規作成）
- `app/api/admin/users/[id]/reject/route.ts`: 承認待ちユーザー削除API（新規作成）
- `app/admin/users/page.tsx`: 承認待ちユーザー一覧画面の追加
- `app/admin/page.tsx`: ダッシュボードに承認待ちユーザー数を表示

---

## 確認事項

- ✅ 社員コード変更時に古い社員コードが解放される
- ✅ 新しい社員コードが未登録の場合のみ変更可能
- ✅ 新規登録時は承認待ち（`is_active = false`）になる
- ✅ 管理者が承認待ちユーザーを承認できる
- ✅ 管理者が承認待ちユーザーを削除（拒否）できる
- ✅ 承認待ちユーザーはログインできない
- ✅ ダッシュボードに承認待ちユーザー数が表示される
- ✅ 外部キー制約の問題が解決され、承認待ちユーザーを削除できる

---

## 注意事項

- 社員コード変更時、過去の注文データは`user_id`で参照しているため整合性は保たれる
- CSV/PDF出力では、その時点の`profiles`テーブルの社員コードが表示される（過去の注文でも現在の社員コードが表示される）
- 監査ログには変更前後の社員コードが記録される
- 承認待ちユーザーを削除する際は、関連する注文、自動注文設定、自動注文テンプレートも削除される

---

最終更新日: 2025-01-02
