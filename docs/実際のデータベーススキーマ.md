# 実際のデータベーススキーマ定義

このドキュメントでは、実際の Supabase データベースのテーブル構造を記録します。初期スキーマ（`001_initial_schema.sql`）との違いがある場合があります。

---

## 1. profiles（ユーザープロフィール）

| カラム名        | データ型      | フォーマット   | NULL 許容 | 説明                                |
| --------------- | ------------- | -------------- | --------- | ----------------------------------- |
| `id`            | `uuid`        | `uuid`         | ❌        | 主キー（auth.users.id を参照）      |
| `employee_code` | `text`        | `text`         | ❌        | 社員コード（4 桁）                  |
| `full_name`     | `text`        | `text`         | ❌        | 氏名                                |
| `email`         | `text`        | `text`         | ✅        | メールアドレス                      |
| `role`          | `user_role`   | `USER-DEFINED` | ❌        | ユーザーロール（'user' \| 'admin'） |
| `joined_date`   | `date`        | `date`         | ✅        | 入社日                              |
| `left_date`     | `date`        | `date`         | ✅        | 退職日                              |
| `is_active`     | `boolean`     | `bool`         | ❌        | アクティブ状態                      |
| `created_at`    | `timestamptz` | `timestamptz`  | ✅        | 作成日時                            |
| `updated_at`    | `timestamptz` | `timestamptz`  | ✅        | 更新日時                            |

**注意事項:**

- 初期スキーマでは`users_profile`というテーブル名でしたが、実際は`profiles`
- `name`カラムではなく`full_name`カラムを使用

---

## 2. vendors（業者マスタ）

| カラム名     | データ型      | フォーマット  | NULL 許容 | 説明           |
| ------------ | ------------- | ------------- | --------- | -------------- |
| `id`         | `bigint`      | `int8`        | ❌        | 主キー         |
| `code`       | `text`        | `text`        | ❌        | 業者コード     |
| `name`       | `text`        | `text`        | ❌        | 業者名         |
| `is_active`  | `boolean`     | `bool`        | ❌        | アクティブ状態 |
| `created_at` | `timestamptz` | `timestamptz` | ✅        | 作成日時       |

**注意事項:**

- ID は`bigint`型（`SERIAL`ではなく`BIGSERIAL`の可能性）

---

## 3. menu_items（メニューマスタ）

| カラム名     | データ型      | フォーマット  | NULL 許容 | 説明                         |
| ------------ | ------------- | ------------- | --------- | ---------------------------- |
| `id`         | `bigint`      | `int8`        | ❌        | 主キー                       |
| `vendor_id`  | `bigint`      | `int8`        | ❌        | 業者 ID（vendors.id を参照） |
| `name`       | `text`        | `text`        | ❌        | メニュー名                   |
| `is_active`  | `boolean`     | `bool`        | ❌        | アクティブ状態               |
| `created_at` | `timestamptz` | `timestamptz` | ✅        | 作成日時                     |

**注意事項:**

- 初期スキーマでは`menus`というテーブル名でしたが、実際は`menu_items`
- ID は`bigint`型（`SERIAL`ではなく`BIGSERIAL`の可能性）
- `updated_at`カラムは存在しない

---

## 4. menu_prices（メニュー価格履歴）

| カラム名       | データ型      | フォーマット  | NULL 許容 | 説明                                    |
| -------------- | ------------- | ------------- | --------- | --------------------------------------- |
| `id`           | `bigint`      | `int8`        | ❌        | 主キー                                  |
| `menu_item_id` | `bigint`      | `int8`        | ❌        | メニュー ID（menu_items.id を参照）     |
| `price`        | `integer`     | `int4`        | ❌        | 価格                                    |
| `start_date`   | `date`        | `date`        | ❌        | 価格適用開始日                          |
| `end_date`     | `date`        | `date`        | ✅        | 価格適用終了日（NULL の場合は現在有効） |
| `created_at`   | `timestamptz` | `timestamptz` | ✅        | 作成日時                                |

**注意事項:**

- 初期スキーマでは`menu_id`というカラム名でしたが、実際は`menu_item_id`
- ID は`bigint`型

---

## 5. order_calendar（注文可能日カレンダー）

| カラム名        | データ型  | フォーマット | NULL 許容 | 説明                              |
| --------------- | --------- | ------------ | --------- | --------------------------------- |
| `target_date`   | `date`    | `date`       | ❌        | 日付（主キー）                    |
| `is_available`  | `boolean` | `bool`       | ❌        | 注文可能かどうか                  |
| `deadline_time` | `time`    | `time`       | ✅        | 締切時刻（注文不可の場合は NULL） |
| `note`          | `text`    | `text`       | ✅        | 備考                              |

**注意事項:**

- 初期スキーマでは`order_days`というテーブル名でしたが、実際は`order_calendar`
- `date`カラムではなく`target_date`カラムを使用
- `special_note`カラムではなく`note`カラムを使用
- `created_at`、`updated_at`カラムは存在しない

---

## 6. order_deadlines（日別締切時刻）

| カラム名      | データ型      | フォーマット  | NULL 許容 | 説明           |
| ------------- | ------------- | ------------- | --------- | -------------- |
| `date`        | `date`        | `date`        | ❌        | 日付（主キー） |
| `cutoff_time` | `time`        | `time`        | ❌        | 締切時刻       |
| `created_at`  | `timestamptz` | `timestamptz` | ❌        | 作成日時       |
| `updated_at`  | `timestamptz` | `timestamptz` | ❌        | 更新日時       |

---

## 7. orders（注文）

| カラム名              | データ型       | フォーマット   | NULL 許容 | 説明                                      |
| --------------------- | -------------- | -------------- | --------- | ----------------------------------------- |
| `id`                  | `bigint`       | `int8`         | ❌        | 主キー                                    |
| `user_id`             | `uuid`         | `uuid`         | ❌        | ユーザー ID（profiles.id を参照）         |
| `menu_item_id`        | `bigint`       | `int8`         | ❌        | メニュー ID（menu_items.id を参照）       |
| `menu_price_id`       | `bigint`       | `int8`         | ❌        | 価格 ID（menu_prices.id を参照）          |
| `order_date`          | `date`         | `date`         | ❌        | 注文日                                    |
| `quantity`            | `integer`      | `int4`         | ❌        | 数量                                      |
| `unit_price_snapshot` | `integer`      | `int4`         | ❌        | 注文時の単価（スナップショット）          |
| `status`              | `order_status` | `USER-DEFINED` | ❌        | 注文ステータス（'ordered' \| 'canceled'） |
| `source`              | `order_source` | `USER-DEFINED` | ❌        | 注文ソース                                |
| `created_at`          | `timestamptz`  | `timestamptz`  | ✅        | 作成日時                                  |
| `updated_at`          | `timestamptz`  | `timestamptz`  | ✅        | 更新日時                                  |

**注意事項:**

- 初期スキーマでは`menu_id`というカラム名でしたが、実際は`menu_item_id`
- ID は`bigint`型
- `unit_price_snapshot`カラムが追加されている（初期スキーマにはない）
- `source`カラムが追加されている（初期スキーマにはない）

---

## 8. closing_periods（締日期間）

| カラム名     | データ型      | フォーマット  | NULL 許容 | 説明       |
| ------------ | ------------- | ------------- | --------- | ---------- |
| `id`         | `bigint`      | `int8`        | ❌        | 主キー     |
| `label`      | `text`        | `text`        | ❌        | ラベル     |
| `start_date` | `date`        | `date`        | ❌        | 開始日     |
| `end_date`   | `date`        | `date`        | ❌        | 終了日     |
| `status`     | `text`        | `text`        | ✅        | ステータス |
| `created_at` | `timestamptz` | `timestamptz` | ✅        | 作成日時   |

**注意事項:**

- 初期スキーマでは`closing_date`カラムがありましたが、実際のテーブルには存在しない
- `label`カラムが追加されている（初期スキーマにはない）
- `status`カラムが追加されている（初期スキーマにはない）
- `updated_at`カラムは存在しない

---

## 9. audit_logs（監査ログ）

| カラム名       | データ型      | フォーマット  | NULL 許容 | 説明                                  |
| -------------- | ------------- | ------------- | --------- | ------------------------------------- |
| `id`           | `bigint`      | `int8`        | ❌        | 主キー                                |
| `actor_id`     | `uuid`        | `uuid`        | ✅        | 実行ユーザー ID（profiles.id を参照） |
| `action`       | `text`        | `text`        | ❌        | アクション種別                        |
| `target_table` | `text`        | `text`        | ✅        | 対象テーブル名                        |
| `target_id`    | `text`        | `text`        | ✅        | 対象レコード ID                       |
| `details`      | `jsonb`       | `jsonb`       | ✅        | 詳細情報（JSON 形式）                 |
| `ip_address`   | `text`        | `text`        | ✅        | IP アドレス                           |
| `created_at`   | `timestamptz` | `timestamptz` | ✅        | 作成日時                              |

**注意事項:**

- 初期スキーマでは`operation_logs`というテーブル名でしたが、実際は`audit_logs`
- 初期スキーマでは`actor_user_id`というカラム名でしたが、実際は`actor_id`
- `target_table`、`target_id`、`ip_address`カラムが追加されている（初期スキーマにはない）

---

## 10. auto_order_configs（自動注文設定）

| カラム名       | データ型      | フォーマット  | NULL 許容 | 説明                                |
| -------------- | ------------- | ------------- | --------- | ----------------------------------- |
| `id`           | `bigint`      | `int8`        | ❌        | 主キー                              |
| `user_id`      | `uuid`        | `uuid`        | ❌        | ユーザー ID（profiles.id を参照）   |
| `menu_item_id` | `bigint`      | `int8`        | ❌        | メニュー ID（menu_items.id を参照） |
| `quantity`     | `integer`     | `int4`        | ❌        | 数量                                |
| `is_enabled`   | `boolean`     | `bool`        | ❌        | 有効/無効                           |
| `created_at`   | `timestamptz` | `timestamptz` | ✅        | 作成日時                            |
| `updated_at`   | `timestamptz` | `timestamptz` | ✅        | 更新日時                            |

**注意事項:**

- 初期スキーマでは`auto_order_settings`というテーブル名でしたが、実際は`auto_order_configs`
- 初期スキーマでは`enabled`というカラム名でしたが、実際は`is_enabled`
- `menu_item_id`カラムを使用（`menu_id`ではない）

---

## 11. auto_order_templates（自動注文テンプレート）

| カラム名      | データ型      | フォーマット  | NULL 許容 | 説明                                                   |
| ------------- | ------------- | ------------- | --------- | ------------------------------------------------------ |
| `id`          | `integer`     | `int4`        | ❌        | 主キー                                                 |
| `user_id`     | `uuid`        | `uuid`        | ❌        | ユーザー ID（profiles.id を参照）                      |
| `menu_id`     | `integer`     | `int4`        | ❌        | メニュー ID（menu_items.id を参照）                    |
| `quantity`    | `integer`     | `int4`        | ❌        | 数量                                                   |
| `day_of_week` | `integer`     | `int4`        | ✅        | 曜日（0=日曜、1=月曜、...、6=土曜。NULL の場合は毎日） |
| `created_at`  | `timestamptz` | `timestamptz` | ❌        | 作成日時                                               |
| `updated_at`  | `timestamptz` | `timestamptz` | ❌        | 更新日時                                               |

**注意事項:**

- このテーブルでは`menu_id`カラムを使用（`menu_item_id`ではない）

---

## 12. auto_order_runs（自動注文実行履歴）

| カラム名      | データ型      | フォーマット  | NULL 許容 | 説明                  |
| ------------- | ------------- | ------------- | --------- | --------------------- |
| `id`          | `bigint`      | `int8`        | ❌        | 主キー                |
| `run_date`    | `date`        | `date`        | ❌        | 実行日                |
| `executed_at` | `timestamptz` | `timestamptz` | ✅        | 実行日時              |
| `status`      | `text`        | `text`        | ✅        | ステータス            |
| `log_details` | `jsonb`       | `jsonb`       | ✅        | ログ詳細（JSON 形式） |

**注意事項:**

- 初期スキーマでは`cutoff_time`、`started_at`、`completed_at`、`error_message`カラムがありましたが、実際のテーブル構造が異なる
- `executed_at`、`status`、`log_details`カラムが使用されている

---

## 13. auto_order_run_items（自動注文実行アイテム）

| カラム名      | データ型      | フォーマット  | NULL 許容 | 説明                                          |
| ------------- | ------------- | ------------- | --------- | --------------------------------------------- |
| `id`          | `integer`     | `int4`        | ❌        | 主キー                                        |
| `run_id`      | `integer`     | `int4`        | ❌        | 実行 ID（auto_order_runs.id を参照）          |
| `user_id`     | `uuid`        | `uuid`        | ❌        | ユーザー ID（profiles.id を参照）             |
| `target_date` | `date`        | `date`        | ❌        | 対象日                                        |
| `result`      | `varchar`     | `varchar`     | ❌        | 実行結果（'created' \| 'skipped' \| 'error'） |
| `detail`      | `text`        | `text`        | ✅        | 詳細情報（エラーメッセージやスキップ理由）    |
| `created_at`  | `timestamptz` | `timestamptz` | ❌        | 作成日時                                      |

**注意事項:**

- 初期スキーマとほぼ同じ構造

---

## まとめ

### 主要な違い

1. **テーブル名の違い**

   - `users_profile` → `profiles`
   - `menus` → `menu_items`
   - `order_days` → `order_calendar`
   - `operation_logs` → `audit_logs`
   - `auto_order_settings` → `auto_order_configs`

2. **カラム名の違い**

   - `profiles.name` → `profiles.full_name`
   - `order_calendar.date` → `order_calendar.target_date`
   - `order_calendar.special_note` → `order_calendar.note`
   - `menu_prices.menu_id` → `menu_prices.menu_item_id`
   - `orders.menu_id` → `orders.menu_item_id`
   - `audit_logs.actor_user_id` → `audit_logs.actor_id`

3. **データ型の違い**

   - ID カラムが`SERIAL`（`INTEGER`）ではなく`BIGSERIAL`（`BIGINT`）を使用しているテーブルが多い

4. **追加カラム**

   - `orders.unit_price_snapshot` - 注文時の単価スナップショット
   - `orders.source` - 注文ソース
   - `closing_periods.label` - ラベル
   - `closing_periods.status` - ステータス
   - `audit_logs.target_table` - 対象テーブル名
   - `audit_logs.target_id` - 対象レコード ID
   - `audit_logs.ip_address` - IP アドレス

5. **削除されたカラム**

   - `closing_periods.closing_date` - 実際のテーブルには存在しない

6. **追加テーブル**
   - `system_settings` - システム設定テーブル（シングルトン、id=1 のみ）

### SQL クエリを書く際の注意事項

- テーブル名とカラム名は、実際のデータベース構造に合わせて使用すること
- ID カラムが`bigint`型であることを考慮すること
- `menu_prices`と`orders`テーブルでは`menu_item_id`カラムを使用すること（`menu_id`ではない）
- `auto_order_templates`テーブルでは`menu_id`カラムを使用すること

---

## 14. system_settings（システム設定）

| カラム名                | データ型      | フォーマット  | NULL 許容 | 説明                              |
| ----------------------- | ------------- | ------------- | --------- | --------------------------------- |
| `id`                    | `bigint`      | `int8`        | ❌        | 主キー（シングルトン、id=1 のみ） |
| `default_deadline_time` | `time`        | `time`        | ❌        | デフォルト締切時刻                |
| `closing_day`           | `integer`     | `int4`        | ✅        | 締め日（1〜31 日、NULL=月末締め） |
| `max_order_days_ahead`  | `integer`     | `int4`        | ❌        | 最大注文可能日数（1〜365 日）     |
| `day_of_week_settings`  | `jsonb`       | `jsonb`       | ❌        | 曜日ごとの設定（JSON 形式）       |
| `company_name`          | `text`        | `text`        | ✅        | 自社の会社名                      |
| `company_postal_code`   | `text`        | `text`        | ✅        | 自社の郵便番号                    |
| `company_address`       | `text`        | `text`        | ✅        | 自社の住所                        |
| `company_phone`         | `text`        | `text`        | ✅        | 自社の電話番号                    |
| `company_fax`           | `text`        | `text`        | ✅        | 自社の FAX 番号                   |
| `company_email`         | `text`        | `text`        | ✅        | 自社のメールアドレス              |
| `created_at`            | `timestamptz` | `timestamptz` | ❌        | 作成日時                          |
| `updated_at`            | `timestamptz` | `timestamptz` | ❌        | 更新日時                          |

**注意事項:**

- シングルトンパターン（id=1 のみ存在）
- `closing_day`は NULL 許可（NULL=月末締め）
- `max_order_days_ahead`は最大注文可能日数を設定（デフォルト: 30 日）
- `day_of_week_settings`は JSONB 型で、各曜日（0=日曜〜6=土曜）に対して`is_available`と`note`を設定可能
- 会社情報カラム（`company_*`）は PDF 生成時に使用される（NULL 許可、フォールバックとして環境変数や固定値を使用可能）
- RLS ポリシー: 全ユーザーが参照可能、管理者のみ更新可能

**day_of_week_settings の構造例:**

```json
{
  "0": { "is_available": false, "note": "週末" },
  "1": { "is_available": true, "note": null },
  "2": { "is_available": true, "note": null },
  "3": { "is_available": true, "note": null },
  "4": { "is_available": true, "note": null },
  "5": { "is_available": true, "note": null },
  "6": { "is_available": false, "note": "週末" }
}
```

---

最終更新日: 2025-01-XX（システム設定機能実装時点）
