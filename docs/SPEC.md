# お弁当注文 Web アプリケーション 仕様書

> 📖 **関連ドキュメント**: [README.md](./README.md) - すべてのドキュメントへの参照

## システム概要

### 技術スタック

- **フロントエンド**: Next.js 16.1.1 (App Router)
- **バックエンド**: Supabase (PostgreSQL + Auth + RLS)
- **言語**: TypeScript
- **スタイリング**: Tailwind CSS
- **開発環境**: Cursor IDE

### 目的

社員向けのお弁当注文を効率化する Web アプリケーション。注文の集計、CSV 出力、自動注文機能を提供する。

---

## ユーザー管理

### ユーザープロフィール（profiles テーブル）

- **社員コード**: 4 桁の数字（例: `0001`）。一意制約あり。
- **権限**: `user`（一般ユーザー）または `admin`（管理者）
- **アクティブ状態**: `is_active` が `true` のユーザーのみシステムを利用可能
- **退職者対応**: `left_date` を設定し、`is_active = false` にすることで退職者を無効化
- **入社日・退職日**: `joined_date`、`left_date` で管理

### 認証

- Supabase Auth を使用（Email/Password 認証）
- 新規登録時は `profiles` テーブルに自動的にレコードが作成される
- 未認証ユーザーは保護されたルートにアクセスできない（ミドルウェアでリダイレクト）
- **メール確認**: Supabase Authのデフォルト動作では、メール確認が必要です
  - 新規登録時に確認メールが送信されます
  - メール内のリンクをクリックしてメールアドレスを確認する必要があります
  - メール確認前はログインできません（仕様）
  - メール確認後、ログインできるようになります
  - メール確認URLは`NEXT_PUBLIC_SITE_URL`環境変数から生成されます（本番環境では必ず設定が必要）
  - Supabase Dashboardの「Site URL」と「Redirect URLs」も本番環境のURLに設定する必要があります
  - 開発環境でメール確認を無効化したい場合は、Supabase Dashboard > Authentication > Settings > 「Enable email confirmations」のチェックを外す（本番環境では推奨しません）
- **パスワードリセット**: メールアドレスを入力してパスワードリセットメールを送信可能
  - パスワードリセットメール内のリンクには、URLハッシュに`#access_token=...&type=recovery&refresh_token=...`が含まれる
  - リンクをクリックすると、ログインページでパスワード更新フォームが表示される
  - 新しいパスワード（6文字以上）とパスワード確認を入力してパスワードを更新可能
  - パスワード更新成功後、3秒後にログイン画面に自動リダイレクト
  - パスワードリセットリンクは、通常24時間以内に有効期限が切れる（Supabaseの設定による）
  - パスワードリセットメールのリンクは、1回のみ使用可能

### 新規登録制限機能

- **招待コード方式**: 4桁の数字の招待コードを必須にする
  - システム設定（`system_settings.invitation_code`）で管理
  - 使用回数制限機能（`invitation_code_max_uses`、`invitation_code_used_count`）
  - 招待コード変更時に使用回数を自動リセット
- **承認方式**: 新規登録時は`is_active = false`（承認待ち）に設定し、管理者が承認すると`is_active = true`にする
  - 新規登録時は社員コードの重複チェックのみ実行（社員コードマスター方式は廃止）
  - 管理者が承認待ちユーザー一覧から承認・削除（拒否）できる
  - 承認待ちユーザーはログインできない
  - 新規登録時に監査ログに記録（`user.signup.pending`アクション）

### 権限管理

- **一般ユーザー**: 自分の注文のみ参照・作成・更新可能
- **管理者**: 全テーブルに対して CRUD 可能、集計・CSV 出力、自動注文実行が可能、任意のユーザーの注文を代理で作成・編集・キャンセル可能、ユーザーの承認・削除が可能

### 社員コード管理

- **社員コード変更**: 管理者がユーザーの社員コードを変更可能
  - 変更時に古い社員コードを`employee_codes`テーブルで解放（再利用可能にする）
  - 新しい社員コードを`employee_codes`テーブルでチェック（未登録のみ許可）
  - 監査ログに変更前後の社員コードを記録
- **社員コードの再利用**: 誤って使用した社員コードを修正後、将来使えるようにする
  - 注文データは`user_id`で参照しているため、社員コードを変更しても整合性は保たれる
  - CSV/PDF出力では、その時点の`profiles`テーブルの社員コードが表示される（過去の注文でも現在の社員コードが表示される）

### ユーザー承認機能

- **承認待ちユーザー**: 新規登録時は`is_active = false`（承認待ち）に設定
- **承認機能**: 管理者が承認待ちユーザーを承認（`is_active = true`に設定）
- **削除（拒否）機能**: 管理者が承認待ちユーザーを削除（物理削除）
  - 削除前に、関連する注文、自動注文設定、自動注文テンプレートを削除
  - `employee_codes`テーブルで社員コードを解放
  - Supabase Authのユーザーを削除
  - `profiles`テーブルのレコードを削除
  - 監査ログに記録（`user.reject`アクション）

---

## 注文サイクル

### 注文可能日（order_calendar テーブル）

- **判定基準**: `is_available = true` の日のみ注文可能
- **締切時刻**: `deadline_time` で日別に設定可能（デフォルト: 10:00）
- **備考**: `note` フィールドに休業理由などを記録可能

### 注文制限

- **過去の日付**: 注文不可
- **締切時刻を過ぎた日**: その日の注文は不可（翌日以降は可能）
- **注文可能日でない日**: `is_available = false` の日は注文不可

### 締切判定

- **判定基準**: DB 時刻（JST）を基準に判定
- **関数**: `is_before_cutoff(order_date)` を使用
- **タイムゾーン**: JST 固定（UTC から Asia/Tokyo に変換）

### 注文可能日の設定

- 管理者がカレンダー管理画面（`/admin/calendar`）から設定可能
- 個別日付の設定、複数日一括編集、月一括編集が可能
- システム設定（`/admin/settings`）で曜日ごとのデフォルト設定を管理

---

## 注文仕様

### 注文テーブル（orders）

- **ユーザー ID**: `user_id`（profiles.id 参照）
- **メニュー ID**: `menu_id`（menu_items.id 参照）
- **価格 ID**: `menu_price_id`（menu_prices.id 参照）**注文時に固定**
- **注文日**: `order_date`（DATE 型）
- **数量**: `quantity`（デフォルト: 1、1 以上）
- **ステータス**: `ordered`（注文済み）、`canceled`（キャンセル済み）

### 重複防止

- **UNIQUE 制約**: `(user_id, menu_id, order_date, status)`
- 同一ユーザー・同一メニュー・同一日付・同一ステータスでの重複を防止
- `ordered` と `canceled` は別レコードとして存在可能

### 注文の作成

- 注文確定時に `get_menu_price_id(menu_id, order_date)` で価格 ID を取得
- 取得した `menu_price_id` を `orders` テーブルに保存
- 価格改定後も、過去の注文の価格は変更されない（価格確定方式）
- **一般ユーザー**: 過去の日付、最大注文可能日数を超えた日付、注文不可日、締切時刻を過ぎた日付には注文不可
- **管理者（ユーザーモード）**: 一般ユーザーと同様の制限（通常の範囲での変更のみ）
- **管理者（管理者モード）**: 過去の日付にも注文可能（後日注文データに間違いがわかったときの修正のため）
  - 管理者モード: `user_id`パラメータが指定されている場合
  - 管理画面からカレンダーを開く場合: 管理者モード
  - ユーザー画面からカレンダーを開く場合: ユーザーモード
- **Transaction connection対応**: 注文作成処理はTransaction connection (6543)を使用してトランザクション保証（データ整合性確保、パフォーマンス向上）
- **Transaction connection対応**: 注文作成処理はTransaction connection (6543)を使用してトランザクション保証（データ整合性確保、パフォーマンス向上）

### 注文のキャンセル

- ステータスを `canceled` に変更（削除はしない）
- **一般ユーザー**: 締切時刻を過ぎた注文はキャンセル不可（仕様として）
- **管理者**: 締切時刻を過ぎた注文もキャンセル可能（運用上の柔軟性のため）
- 注文編集画面からキャンセル可能
- 注文履歴画面では、一般ユーザーの場合、締切時刻を過ぎた注文のキャンセルボタンは非表示
- キャンセル処理中に締切時刻を過ぎた場合は、エラーメッセージを表示
- **Transaction connection対応**: 注文キャンセル処理はTransaction connection (6543)を使用してトランザクション保証（データ整合性確保、パフォーマンス向上）
- **Transaction connection対応**: 注文キャンセル処理はTransaction connection (6543)を使用してトランザクション保証（データ整合性確保、パフォーマンス向上）

### 注文の削除（管理者のみ）

- **物理削除**: 管理者のみ注文を物理削除可能（`DELETE /api/orders/[id]`）
- **用途**: 後日注文データに間違いがわかったときの修正
- **監査ログ**: 削除操作を監査ログに記録（`order.delete.admin`アクション）
- **UI**: 注文一覧画面から削除ボタンで削除可能

### キャンセル済み注文の再注文

- キャンセル済み（`status = 'canceled'`）の注文がある場合、同じ日に再度注文可能
- 同じ`menu_id`でキャンセル済みの注文がある場合、新規注文作成時に自動的に削除される（UNIQUE 制約違反を避けるため）

---

## 業者・メニュー・価格管理

### 業者マスタ（vendors）

- **コード**: 業者コード（一意制約あり）
- **名称**: 業者名
- **アクティブ状態**: `is_active = true` の業者のみ表示・注文可能

### メニューマスタ（menu_items）

- **業者 ID**: `vendor_id`（vendors.id 参照）
- **名称**: メニュー名
- **アクティブ状態**: `is_active = true` のメニューのみ表示・注文可能

### 価格履歴管理（menu_prices）

- **期間管理**: `start_date` と `end_date` で価格期間を管理
- **有効期間**: `start_date <= order_date <= end_date`（`end_date` が NULL の場合は現在有効）
- **重複検証**: `get_menu_price_id` 関数で重複期間を検証
- **価格確定**: 注文時に `menu_price_id` を固定保存（価格改定の影響を受けない）
- **未来の価格改定設定**: 新規価格登録時に、既存の有効な価格（`end_date`が NULL）がある場合、自動的に既存の価格の`end_date`を新しい価格の`start_date`の前日に設定する機能
  - 例：現在有効な価格（`start_date: 2024-01-01`, `end_date: NULL`）がある状態で、新しい価格（`start_date: 2026-04-01`）を登録すると、既存の価格の`end_date`が`2026-03-31`に自動設定される

### 価格取得ロジック

```sql
-- 指定日付に対応する有効な価格IDを取得
SELECT id FROM menu_prices
WHERE menu_id = ?
  AND start_date <= order_date
  AND (end_date IS NULL OR end_date >= order_date)
ORDER BY start_date DESC
LIMIT 1;
```

---

## 集計・CSV 出力

### 締日期間の計算

- **計算基準**: システム設定（`system_settings.closing_day`）を基準に締日期間を自動計算
- **期間計算ロジック**:
  - **指定日締めの場合**: 開始日=前月の締日+1 日、終了日=当月の締日
  - **月末締めの場合**: 開始日=当月 1 日、終了日=当月の最終日
- **表示期間**: 過去 12 ヶ月分の締日期間を自動計算して表示
- **例**: 今日が 2026 年 1 月 1 日、システム設定の締日が 10 日の場合
  - 最新期間：2025 年 12 月 11 日 ～ 2026 年 1 月 10 日
  - その前：2025 年 11 月 11 日 ～ 2025 年 12 月 10 日

### 締日期間（closing_periods）

- **期間管理**: `start_date` と `end_date` で集計期間を定義（過去のデータとして保持）
- **締日**: `closing_date` でその期間の締日を管理
- **集計基準**: システム設定の締日を基準に自動計算した期間を使用（`closing_periods`テーブルは過去データとして参照可能）

### CSV 出力仕様

#### 明細CSV出力

- **対象**: `status = 'ordered'` の注文のみ
- **集計期間**: システム設定の締日を基準に自動計算した期間、または`closing_periods`で定義された期間（後方互換性のため）
- **出力項目**:
  - 注文日
  - ユーザー情報（社員コード、氏名）
  - メニュー情報（業者名、メニュー名）
  - 数量
  - 単価（注文時の価格）
  - 小計
- **管理者のみ**: CSV 出力機能は管理者のみ利用可能

#### ユーザー別合計金額CSV出力

- **対象**: `status = 'ordered'` の注文のみ
- **集計期間**: システム設定の締日を基準に自動計算した期間、または`closing_periods`で定義された期間（後方互換性のため）
- **出力項目**:
  - 社員コード
  - 氏名
  - 合計金額（ユーザーごとの合計）
- **ソート**: 社員コード順
- **合計行**: 含めない（ユーザーごとの合計のみ）
- **管理者のみ**: CSV 出力機能は管理者のみ利用可能

---

## 自動注文機能

### 自動注文設定（auto_order_settings）

- **有効/無効**: `enabled` フラグで制御
- **ユーザー単位**: 各ユーザーが個別に設定可能

### 自動注文テンプレート（auto_order_templates）

- **曜日別パターン**: `day_of_week`（0=日曜、1=月曜、...、6=土曜）
- **毎日注文**: `day_of_week = NULL` の場合は毎日注文
- **メニュー・数量**: `menu_id` と `quantity` を設定

### 自動注文実行ロジック

1. **実行タイミング**: 締切時刻を過ぎた後、自動的に実行
2. **対象日**: 翌営業日（`is_available = true` の最初の日）
3. **既存注文チェック**: 既に注文がある場合はスキップ（何もしない）
4. **無効ユーザー除外**: `is_active = false` のユーザーは対象外
5. **テンプレート適用**: `day_of_week` が一致するテンプレートを適用

### 自動注文実行履歴

- **実行記録**: `auto_order_runs` テーブルに実行履歴を記録
- **ユーザー別結果**: `auto_order_run_items` テーブルにユーザーごとの実行結果を記録
- **結果**: `created`（作成）、`skipped`（スキップ）、`error`（エラー）

### 冪等性保証

- **実行履歴**: `(run_date, cutoff_time)` の UNIQUE 制約で二重実行を防止
- **ユーザー別結果**: `(run_id, user_id)` の UNIQUE 制約で重複を防止

---

## セキュリティ・RLS・監査ログ

### Row Level Security (RLS)

- **全テーブルで有効化**: すべてのテーブルで RLS を有効化
- **一般ユーザー権限**:
  - `profiles`: 自分のプロフィールのみ参照・更新
  - `orders`: 自分の注文のみ参照・作成・更新
  - `auto_order_settings`: 自分の設定のみ CRUD
  - `auto_order_templates`: 自分のテンプレートのみ CRUD
  - `vendors`/`menu_items`/`menu_prices`/`order_calendar`/`order_deadlines`/`closing_periods`: 参照のみ（`is_active = true` のみ表示）
- **管理者権限**: 全テーブルに対して CRUD 可能

### 監査ログ（audit_logs）

- **記録対象**: すべての重要な操作（注文作成・更新・キャンセル、価格・業者・メニュー・カレンダー・ユーザー・システム設定の管理操作、PDF生成、CSV出力など）
- **記録項目**:
  - `actor_id`: 実行ユーザー ID（`auth.users(id)` を参照、`ON DELETE SET NULL`）
  - `action`: アクション種別（例: `order.create`、`order.cancel`、`price.create`、`vendor.update`、`pdf.generate`、`csv.download`、`csv.download.by_user`など）
  - `target_table`: 対象テーブル名
  - `target_id`: 対象レコード ID
  - `details`: 詳細情報（JSONB 形式）
  - `ip_address`: 実行元 IP アドレス
  - `created_at`: 実行日時
- **参照権限**: 管理者のみ参照可能（全ユーザーが記録は可能）
- **ログ閲覧画面**: `/admin/logs`で管理者がすべての操作ログを閲覧可能
- **ユーザー削除時の動作**: Authユーザーを削除した場合、`actor_id` は自動的に NULL になるが、監査ログの行自体は保持される（`ON DELETE SET NULL`）

### セキュリティ方針

- **認証**: Supabase Auth を使用
- **認可**: RLS ポリシーでデータアクセスを制御
- **監査**: すべての重要な操作をログに記録
- **タイムゾーン**: JST 固定（DB 関数内で変換）

---

## データベーススキーマ

### 主要テーブル

1. **profiles**: ユーザープロフィール
2. **vendors**: 業者マスタ
3. **menu_items**: メニューマスタ
4. **menu_prices**: メニュー価格（履歴管理）
5. **order_calendar**: 注文可能日カレンダー
6. **order_deadlines**: 日別締切時刻
7. **orders**: 注文
8. **closing_periods**: 締日期間
9. **audit_logs**: 操作ログ（監査用）
10. **auto_order_configs**: 自動注文設定
11. **auto_order_templates**: 自動注文テンプレート
12. **auto_order_runs**: 自動注文実行履歴
13. **auto_order_run_items**: 自動注文実行アイテム
14. **employee_codes**: 社員コードマスター（新規登録制限用）

### ENUM 型

- **user_role**: `'user'` | `'admin'`
- **order_status**: `'ordered'` | `'canceled'`
- **auto_order_run_status**: `'running'` | `'completed'` | `'failed'`

### ヘルパー関数

- **get_menu_price_id(menu_id, order_date)**: 指定日付・メニュー ID に対応する有効な価格 ID を取得
- **get_cutoff_time(order_date)**: 指定日付の締切時刻を取得（デフォルト: システム設定から取得）
- **is_before_cutoff(order_date)**: 指定日付の注文が締切前かどうかを判定（DB 時刻基準、JST 固定）

### データベース接続

- **Transaction connection (6543)**: パフォーマンスが重要なクエリやトランザクションが必要な処理で使用
  - 接続プールを活用し、複数のクエリを同じ接続で実行することで、接続確立のオーバーヘッドを削減
  - 注文作成・更新・キャンセル処理はトランザクション内で実行し、データ整合性を確保
  - JOINクエリを使用して、Supabaseのネストしたクエリと同等のデータを効率的に取得
  - 既存のSupabaseクライアントと併用可能で、段階的に移行できる
  - **注意**: RLSは直接PostgreSQL接続では自動適用されないため、適切な権限チェックを実装
  - **フォールバック処理**: `DATABASE_URL`環境変数が設定されていない場合、通常のSupabaseクライアントを使用して動作する（カレンダーページなど）

### サーバーコンポーネントとクライアントコンポーネントのprops渡し

- **シリアライズ制限**: Next.jsでは、サーバーコンポーネントからクライアントコンポーネントに渡すpropsは、JSONシリアライズ可能である必要があります
  - **シリアライズ可能な型**: `string`、`number`、`boolean`、`null`、`undefined`、配列、通常のオブジェクト（プレーンオブジェクト）
  - **シリアライズ不可な型**: `Map`、`Set`、`Date`、`Function`、`RegExp`など
  - **Map型の扱い**: `Map`型は渡せないため、通常のオブジェクト（`Record<string, T>`）に変換して渡す必要がある
  - **Date型の扱い**: `Date`型も渡せないため、文字列（ISO形式など）に変換して渡す必要がある
  - **実装例**: カレンダーページでは、`orderDaysMap`と`ordersMap`を`Map`型から`Record<string, T>`型に変換してクライアントコンポーネントに渡している

### システム設定

- **system_settings テーブル**: システム全体の設定を管理（シングルトン、id=1 のみ）
  - **default_deadline_time**: デフォルト締切時刻（カレンダー設定で指定しない場合のデフォルト値）
  - **closing_day**: 締め日（毎月、1〜31 日、または NULL（月末締め）、集計の際に使用）
  - **max_order_days_ahead**: 最大注文可能日数（今日から何日先まで注文可能か、1〜365 日、デフォルト: 30 日）
  - **day_of_week_settings**: 曜日ごとのデフォルト設定（月一括編集で使用）
    - 各曜日（0=日曜〜6=土曜）に対して`is_available`と`note`を設定可能

### 環境変数

- **NEXT_PUBLIC_SITE_URL**: 本番環境のサイトURL（メール内のリンクに使用）
  - 本番環境: `https://bento-order-app-blond.vercel.app`
  - 開発環境: 設定不要（デフォルトで `http://localhost:3000` が使用される）
  - **重要**: Supabase Dashboardの`Site URL`設定も本番環境のURLに設定する必要があります
  - **用途**: 新規登録時の確認メールやパスワードリセットメール内のリンクURLに使用
- **DATABASE_URL**: Transaction connection (6543)の接続文字列（オプション、パフォーマンス向上のため推奨）
  - Supabase Dashboard > Project Settings > Database > Connection string > **Transaction** から取得
  - 形式: `postgresql://postgres:[YOUR-PASSWORD]@db.[YOUR-PROJECT-REF].supabase.co:6543/postgres?pgbouncer=true`
  - **用途**: パフォーマンスが重要なクエリやトランザクションが必要な処理で使用
  - **注意**: サーバーサイドでのみ使用可能、RLSは自動適用されないため適切な権限チェックが必要
  - **フォールバック**: 設定されていない場合、通常のSupabaseクライアントを使用して動作する（カレンダーページなど）

---

## UI/UX 仕様

### カレンダー画面

- **表示形式**: 月間カレンダーグリッド
- **注文可能日**: 緑色の「注文可」ボタンを表示
- **注文済み日**: 注文内容（メニュー名、数量）を表示
- **注文変更可能日**: 注文済みで変更可能な日は「変更可」と表示（クリックで編集画面へ）
- **注文不可日**: グレーアウト表示
- **今日の日付**: 点滅する枠線で強調表示
- **月ナビゲーション**: 前月・次月ボタンで移動可能
- **デスクトップ表示**: カレンダー全体が一画面で表示されるようにセルサイズを調整（横幅 1.2 倍、高さとパディングを縮小）
- **レイアウト**: ヘッダーとタイトルの間の空間を最小限に調整
- **セルサイズ**: 注文の有無に関わらずセルサイズが一定（スマホで画面に収まるように最適化）
- **Transaction connection対応**: データ取得処理はTransaction connection (6543)を使用してパフォーマンス向上

### 注文画面

- **メニュー選択**: 有効な業者・メニューのみ表示
- **数量入力**: 1 以上の整数
- **注文確定**: 締切時刻を過ぎている場合はエラー表示

### 注文履歴画面

- **注文一覧**: 今月の注文を日付順（降順）で表示
- **合計金額**: 今月の注文済み注文の合計金額を表示
- **キャンセルボタン**: 注文済み（`status = 'ordered'`）の注文に表示
- **キャンセルボタンの表示制御**: 締切時刻を過ぎた注文のキャンセルボタンは非表示
- **エラーメッセージ**: キャンセル処理中に締切時刻を過ぎた場合は、エラーメッセージを表示
- **Transaction connection対応**: データ取得処理はTransaction connection (6543)を使用してパフォーマンス向上（JOINクエリで効率化）

### 管理者画面

- **ダッシュボード**: システムの概要を確認（本日の注文、アクティブユーザー、承認待ちユーザー、アクティブ業者、アクティブメニュー）
  - 各カードをクリックして対応する管理画面に遷移可能
  - 承認待ちユーザー数を表示（クリックで承認待ちユーザー一覧に遷移）
  - Service Role Keyを使用してRLSをバイパスし、正確な集計データを表示
- **注文一覧**: 日付を指定して注文一覧を確認
  - 業者別・メニュー別にグループ化して表示
  - 注文時刻順（新しい順）で表示
  - カレンダーから日付を選択（注文がある日のみ選択可能）
  - 各業者・メニューの小計と全体の合計金額を表示
  - 各業者ごとの PDF 出力機能（注文書を PDF でダウンロード）
- **集計・CSV 出力**: 締日期間を選択して CSV 出力
  - 明細CSV出力（注文明細を1行1注文で出力）
  - ユーザー別合計金額CSV出力（ユーザーごとの合計金額を出力）
  - 業者とユーザーで絞り込み可能
  - 代理注文を視覚的に識別可能（背景色、ボーダー、バッジ）
- **PDF 出力**: 業者ごとの注文書 PDF を生成（A4 サイズ、発注書形式、合計食数表示、明細は内容と数量のみ、送信者情報に FAX 番号を含む、住所は 2 行で表示可能）
- **カレンダー管理**: 注文可能日の設定（個別設定、複数日一括編集、月一括編集）
- **システム設定**: デフォルト締切時刻、締め日（指定日または月末締め）、最大注文可能日数、曜日ごとのデフォルト設定、会社情報（会社名、郵便番号、住所 1 行目、住所 2 行目、電話番号、FAX 番号、メールアドレス）
- **ユーザー管理**: ユーザーの一覧表示、編集、削除（無効化）、カレンダー画面へのアクセス、承認待ちユーザーの承認・削除（拒否）
  - 「有効なユーザー」「無効なユーザー」「承認待ち」の3つのタブで切り替え
  - 有効なユーザータブ: `is_active = true`のユーザーのみ表示
  - 無効なユーザータブ: `is_active = false`かつ退職日が設定されているユーザー（退職者を含む、グレーアウト表示）
  - 承認待ちタブ: `is_active = false`かつ退職日が未設定または未来の日付（明日以降）のユーザー
  - 承認待ちユーザー一覧から承認・編集・削除（拒否）が可能
- **社員コードマスター管理**: 新規登録可能な社員コードの一覧表示、追加、編集、削除（未登録のみ）
  - 注意: 管理者メニューからは削除されているが、直接URL（`/admin/employee-codes`）でアクセス可能
  - 社員コード変更機能で内部的に使用されるため、テーブルとAPIは維持
- **招待コード管理**: 新規登録用招待コードの発行・管理（4桁の数字、使用回数制限付き）
- **業者・メニュー管理**: 業者・メニューの追加・編集・削除
- **価格管理**: 価格履歴の追加・編集（業者別グループ化表示、編集時の自動調整）
- **注文代理操作**: 任意のユーザーのカレンダー画面を開き、そのユーザーとして注文を作成・編集・キャンセル
- **過去の注文入力**: 管理者モードの場合のみ過去の日付に注文を作成可能（後日注文データに間違いがわかったときの修正のため）
  - 管理者モード: `user_id`パラメータが指定されている場合（管理者権限がある場合のみ許可）
  - 管理者が管理画面からカレンダーを開く場合: 管理者モード（過去の日付にも注文可能）
  - 管理者がユーザー画面からカレンダーを開く場合: ユーザーモード（通常の範囲での変更のみ）
- **注文削除**: 管理者のみ注文を物理削除可能（注文一覧画面から削除ボタンで削除）

---

## 制約・制限事項

### 注文制限

- **過去の日付**: 注文不可
- **締切時刻を過ぎた日**: その日の注文は不可
- **注文可能日でない日**: `is_available = false` の日は注文不可
- **最大注文可能日数を超えた日**: システム設定で設定した日数を超える未来の日付は注文不可（グレーアウト表示）

### 新規登録制限

- **招待コード**: システム設定で設定した4桁の数字の招待コードを入力必須
- **使用回数制限**: 最大使用回数が設定されている場合、上限に達していると登録不可
- **社員コードマスター**: 事前に登録された社員コードのみ登録可能
- **二重登録防止**: 既に登録済みの社員コードは登録不可

### データ整合性

- **社員コード**: 4 桁の数字で一意
- **価格期間**: 重複期間は許可しない（`get_menu_price_id` で検証）
- **注文重複**: 同一ユーザー・同一メニュー・同一日付・同一ステータスでの重複は不可

### 現在の制限事項

- **業者別の休業日管理**: 現在は未実装（将来的に `vendor_holidays` テーブルを追加予定）
- **複数業者対応**: 現在は 1 社のみ対応（将来的に複数業者対応予定）

---

## 将来の拡張予定

### 複数業者対応

- **業者別の休業日管理**: `vendor_holidays` テーブルを追加
- **判定ロジック**: 少なくとも 1 社が営業していれば注文可能とする
- **メニュー選択**: その日に休業している業者のメニューは非表示

### 管理者画面の機能拡張（一部完了）

- ✅ **カレンダー管理画面**: 注文可能日の設定を GUI で操作可能に - **完了**
- ✅ **システム設定画面**: デフォルト締切時刻、締め日、曜日ごとの設定を管理 - **完了**
- **自動注文実行**: 手動実行機能の追加
- **集計・レポート**: より詳細な集計・レポート機能

---

## 用語集

- **締日**: 注文を集計する日（`closing_periods.closing_date`）
- **締切時刻**: その日の注文を受け付ける最終時刻（`order_deadlines.cutoff_time`）
- **注文可能日**: `order_calendar.is_available = true` の日
- **価格確定**: 注文時に `menu_price_id` を固定保存すること
- **自動注文**: テンプレートに基づいて自動的に注文を作成する機能
