# è‡ªå‹•æ³¨æ–‡æ©Ÿèƒ½ã®å®Ÿè£…

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€è‡ªå‹•æ³¨æ–‡æ©Ÿèƒ½ã®å®Ÿè£…è©³ç´°ã‚’è¨˜éŒ²ã—ã¾ã™ã€‚

> ğŸ“– **é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: [README.md](./README.md) - ã™ã¹ã¦ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¸ã®å‚ç…§

---

## å®Ÿè£…æ¦‚è¦

è‡ªå‹•æ³¨æ–‡æ©Ÿèƒ½ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¨­å®šã—ãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«åŸºã¥ã„ã¦ã€æ¯æ—¥è‡ªå‹•çš„ã«ç¿Œå–¶æ¥­æ—¥ã®æ³¨æ–‡ã‚’ä½œæˆã™ã‚‹æ©Ÿèƒ½ã§ã™ã€‚

### ä¸»ãªæ©Ÿèƒ½

1. **è‡ªå‹•æ³¨æ–‡è¨­å®šç”»é¢**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è¨­å®š
2. **è‡ªå‹•æ³¨æ–‡å®Ÿè¡Œ API**: ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã¦æ³¨æ–‡ã‚’ä½œæˆ
3. **Vercel Cron Jobs**: æ¯æ—¥è‡ªå‹•çš„ã«å®Ÿè¡Œ

---

## 1. è‡ªå‹•æ³¨æ–‡è¨­å®šç”»é¢

### å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«

- `app/(user)/settings/auto-order/page.tsx`: ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
- `app/(user)/settings/auto-order/auto-order-settings-client.tsx`: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

### æ©Ÿèƒ½è©³ç´°

#### 1.1 ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§è¡¨ç¤º

- æ›œæ—¥åˆ¥ï¼ˆæ—¥æ›œæ—¥ã€œåœŸæ›œæ—¥ã€æ¯æ—¥ï¼‰ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦è¡¨ç¤º
- å„ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«ãƒ¡ãƒ‹ãƒ¥ãƒ¼åã€æ•°é‡ã€æ¥­è€…åã‚’è¡¨ç¤º
- ç·¨é›†ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³

#### 1.2 ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¿½åŠ ãƒ»ç·¨é›†

- **æ›œæ—¥é¸æŠ**: æ—¥æ›œæ—¥ã€œåœŸæ›œæ—¥ã€ã¾ãŸã¯æ¯æ—¥
- **ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠ**: æ¥­è€…åˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦è¡¨ç¤º
- **æ•°é‡å…¥åŠ›**: 1 ä»¥ä¸Šã®æ•´æ•°
- **ä¿å­˜ãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³**

#### 1.3 ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå‰Šé™¤

- ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ä»˜ãå‰Šé™¤æ©Ÿèƒ½

#### 1.4 é‡è¤‡ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½

**å®Ÿè£…ãƒ­ã‚¸ãƒƒã‚¯:**

```typescript
// é‡è¤‡ãƒã‚§ãƒƒã‚¯é–¢æ•°
const checkDuplicate = (dayOfWeek: number | null): string | null => {
  // ç·¨é›†æ™‚ã¯ç¾åœ¨ç·¨é›†ä¸­ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é™¤å¤–
  const otherTemplates = templates.filter((t) => t.id !== editingId);

  // æ¯æ—¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆday_of_week = nullï¼‰ã®å ´åˆ
  if (dayOfWeek === null) {
    // æ—¢ã«æ¯æ—¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    const hasEveryday = otherTemplates.some((t) => t.day_of_week === null);
    if (hasEveryday) {
      return "æ¯æ—¥ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯æ—¢ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚";
    }
    // ç‰¹å®šã®æ›œæ—¥ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    const hasSpecificDay = otherTemplates.some((t) => t.day_of_week !== null);
    if (hasSpecificDay) {
      return "ç‰¹å®šã®æ›œæ—¥ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒæ—¢ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚";
    }
  } else {
    // ç‰¹å®šã®æ›œæ—¥ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®å ´åˆ
    // åŒã˜æ›œæ—¥ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    const hasSameDay = otherTemplates.some((t) => t.day_of_week === dayOfWeek);
    if (hasSameDay) {
      return `${dayLabel}ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯æ—¢ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚`;
    }
    // æ¯æ—¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    const hasEveryday = otherTemplates.some((t) => t.day_of_week === null);
    if (hasEveryday) {
      return "æ¯æ—¥ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒæ—¢ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚";
    }
  }

  return null;
};
```

**ãƒã‚§ãƒƒã‚¯å†…å®¹:**

1. **æ¯æ—¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®é‡è¤‡**

   - æ—¢ã«æ¯æ—¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚‹å ´åˆã€æ–°ã—ã„æ¯æ—¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯è¿½åŠ ä¸å¯

2. **ç‰¹å®šã®æ›œæ—¥ã®é‡è¤‡**

   - æ—¢ã«ç‰¹å®šã®æ›œæ—¥ï¼ˆä¾‹ï¼šæœˆæ›œæ—¥ï¼‰ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚‹å ´åˆã€åŒã˜æ›œæ—¥ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯è¿½åŠ ä¸å¯

3. **æ¯æ—¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ç‰¹å®šã®æ›œæ—¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ç«¶åˆ**
   - æ¯æ—¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚‹å ´åˆã€ç‰¹å®šã®æ›œæ—¥ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯è¿½åŠ ä¸å¯
   - ç‰¹å®šã®æ›œæ—¥ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚‹å ´åˆã€æ¯æ—¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯è¿½åŠ ä¸å¯

**UI ã§ã®è¡¨ç¤º:**

- æ—¢ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹æ›œæ—¥ã¯é¸æŠä¸å¯ï¼ˆdisabledï¼‰
- é¸æŠä¸å¯ã®ç†ç”±ã‚’è¡¨ç¤º
- ä¿å­˜æ™‚ã«é‡è¤‡ãŒã‚ã‚‹å ´åˆã¯ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º

---

## 2. è‡ªå‹•æ³¨æ–‡å®Ÿè¡Œ API

### å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«

- `app/api/auto-order/run/route.ts`

### æ©Ÿèƒ½è©³ç´°

#### 2.0 HTTPãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆé‡è¦ï¼‰

- **Vercel Cron Jobs ã¯ `GET` ã§ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã™**ãŸã‚ã€`/api/auto-order/run` ã¯ **GET/POST ã®ä¸¡æ–¹**ã§å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«å®Ÿè£…ã—ã¾ã™ã€‚
- æ‰‹å‹•å®Ÿè¡Œï¼ˆcurl/é–‹ç™ºç’°å¢ƒï¼‰ã¯ `POST` ã‚’æ¨å¥¨ï¼ˆ`Authorization: Bearer <AUTO_ORDER_SECRET>` ã§ä¿è­·ï¼‰ã€‚

#### 2.1 èªè¨¼

```typescript
// Vercel Cron Jobsã‹ã‚‰ã®å‘¼ã³å‡ºã—ã‚’ç¢ºèª
const isVercelCron = request.headers.get("x-vercel-cron") === "1";

// é–‹ç™ºç’°å¢ƒã‚„æ‰‹å‹•å®Ÿè¡Œã®å ´åˆã¯ã€Authorizationãƒ˜ãƒƒãƒ€ãƒ¼ã§èªè¨¼
if (!isVercelCron) {
  const authHeader = request.headers.get("authorization");
  const expectedSecret = process.env.AUTO_ORDER_SECRET;

  if (expectedSecret && authHeader !== `Bearer ${expectedSecret}`) {
    return NextResponse.json({ error: "èªè¨¼ãŒå¿…è¦ã§ã™" }, { status: 401 });
  }
}
```

- **Vercel Cron Jobs**: `x-vercel-cron`ãƒ˜ãƒƒãƒ€ãƒ¼ã§è‡ªå‹•èªè¨¼
- **é–‹ç™ºç’°å¢ƒãƒ»æ‰‹å‹•å®Ÿè¡Œ**: `Authorization: Bearer <AUTO_ORDER_SECRET>`ãƒ˜ãƒƒãƒ€ãƒ¼ã§èªè¨¼

#### 2.2 ç¿Œå–¶æ¥­æ—¥ã®åˆ¤å®š

```typescript
// æœ€å¤§30æ—¥å…ˆã¾ã§æ¤œç´¢
for (let i = 1; i <= 30; i++) {
  const checkDate = new Date(today);
  checkDate.setDate(checkDate.getDate() + i);
  const checkDateStr = checkDate.toISOString().split("T")[0];

  const { data: orderDay } = await supabaseAdmin
    .from("order_calendar")
    .select("*")
    .eq("target_date", checkDateStr)
    .single();

  if (orderDay && orderDay.is_available) {
    targetDate = checkDateStr;
    break;
  }
}
```

- `order_calendar`ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰`is_available = true`ã®æœ€åˆã®æ—¥ã‚’å–å¾—
- æœ€å¤§ 30 æ—¥å…ˆã¾ã§æ¤œç´¢

#### 2.3 æ—¢å­˜æ³¨æ–‡ãƒã‚§ãƒƒã‚¯

```typescript
const { data: existingOrder } = await supabaseAdmin
  .from("orders")
  .select("id")
  .eq("user_id", user.id)
  .eq("order_date", targetDate)
  .eq("status", "ordered")
  .maybeSingle();

if (existingOrder) {
  // æ—¢å­˜æ³¨æ–‡ãŒã‚ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
  results.push({
    user_id: user.id,
    result: "skipped",
    detail: "æ—¢ã«æ³¨æ–‡ãŒã‚ã‚Šã¾ã™",
  });
  continue;
}
```

- å¯¾è±¡æ—¥ã«æ—¢ã«æ³¨æ–‡ï¼ˆ`status = 'ordered'`ï¼‰ãŒã‚ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
- æ‰‹å‹•æ³¨æ–‡ã‚’å°Šé‡ã™ã‚‹è¨­è¨ˆ

#### 2.4 ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé©ç”¨

```typescript
// å¯¾è±¡æ—¥ã®æ›œæ—¥ã‚’å–å¾—ï¼ˆ0=æ—¥æ›œã€1=æœˆæ›œã€...ã€6=åœŸæ›œï¼‰
const dayOfWeek = targetDateObj.getDay();

// ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å–å¾—ï¼ˆæ¯æ—¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¾ãŸã¯è©²å½“æ›œæ—¥ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼‰
const { data: templates } = await supabaseAdmin
  .from("auto_order_templates")
  .select("*")
  .eq("user_id", user.id)
  .or(`day_of_week.is.null,day_of_week.eq.${dayOfWeek}`)
  .order("day_of_week", { ascending: true, nullsFirst: false });

// å„ªå…ˆé †ä½: ç‰¹å®šã®æ›œæ—¥ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ > æ¯æ—¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
const specificDayTemplate = templates.find((t) => t.day_of_week === dayOfWeek);
const template =
  specificDayTemplate || templates.find((t) => t.day_of_week === null);
```

**å„ªå…ˆé †ä½:**

1. ç‰¹å®šã®æ›œæ—¥ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆä¾‹ï¼šæœˆæ›œæ—¥ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼‰
2. æ¯æ—¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆ`day_of_week = null`ï¼‰

#### 2.5 æ³¨æ–‡ä½œæˆ

```typescript
// ä¾¡æ ¼IDå–å¾—
const { data: priceId } = await supabaseAdmin.rpc("get_menu_price_id", {
  p_menu_id: template.menu_id,
  p_order_date: targetDate,
});

// ä¾¡æ ¼æƒ…å ±ã‚’å–å¾—ï¼ˆunit_price_snapshotç”¨ï¼‰
const { data: priceInfo } = await supabaseAdmin
  .from("menu_prices")
  .select("price")
  .eq("id", priceId)
  .single();

// æ³¨æ–‡ã‚’ä½œæˆ
const { data: orderData } = await supabaseAdmin
  .from("orders")
  .insert({
    user_id: user.id,
    menu_item_id: template.menu_id,
    menu_price_id: priceId,
    order_date: targetDate,
    quantity: template.quantity,
    unit_price_snapshot: priceInfo.price,
    status: "ordered",
    source: "auto",
  })
  .select()
  .single();
```

- `get_menu_price_id`é–¢æ•°ã§ä¾¡æ ¼ ID ã‚’å–å¾—
- æ³¨æ–‡æ™‚ã®å˜ä¾¡ã‚’`unit_price_snapshot`ã«ä¿å­˜
- `source = 'auto'`ã§è‡ªå‹•æ³¨æ–‡ã§ã‚ã‚‹ã“ã¨ã‚’è¨˜éŒ²

#### 2.6 å®Ÿè¡Œå±¥æ­´è¨˜éŒ²

```typescript
// å®Ÿè¡Œå±¥æ­´ã‚’ä½œæˆ
const { data: runRecord } = await supabaseAdmin
  .from("auto_order_runs")
  .insert({
    run_date: todayStr,
    executed_at: jstNow.toISOString(),
    status: "running",
    log_details: {
      target_date: targetDate,
      executed_at: jstNow.toISOString(),
    },
  })
  .select()
  .single();

// å®Ÿè¡Œå±¥æ­´ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¨˜éŒ²
for (const result of results) {
  await supabaseAdmin.from("auto_order_run_items").insert({
    run_id: runRecord.id,
    user_id: result.user_id,
    target_date: targetDate,
    result: result.result, // 'created' | 'skipped' | 'error'
    detail: result.detail,
  });
}

// å®Ÿè¡Œå±¥æ­´ã‚’æ›´æ–°
await supabaseAdmin
  .from("auto_order_runs")
  .update({
    status: "completed",
    log_details: {
      ...runRecord.log_details,
      created: createdCount,
      skipped: skippedCount,
      errors: errorCount,
      total: results.length,
    },
  })
  .eq("id", runRecord.id);
```

- `auto_order_runs`ãƒ†ãƒ¼ãƒ–ãƒ«ã«å®Ÿè¡Œå±¥æ­´ã‚’è¨˜éŒ²
- `auto_order_run_items`ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®å®Ÿè¡Œçµæœã‚’è¨˜éŒ²
- çµæœ: `created`ï¼ˆä½œæˆï¼‰ã€`skipped`ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰ã€`error`ï¼ˆã‚¨ãƒ©ãƒ¼ï¼‰

---

## 3. Vercel Cron Jobs è¨­å®š

### å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«

- `vercel.json`

### è¨­å®šå†…å®¹

```json
{
  "crons": [
    {
      "path": "/api/auto-order/run",
      "schedule": "0 10 * * *"
    }
  ]
}
```

- **ãƒ‘ã‚¹**: `/api/auto-order/run`
- **ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«**: `0 10 * * *`ï¼ˆæ¯æ—¥ 10:00 JSTï¼‰
- Vercel ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã¨è‡ªå‹•çš„ã« Cron Jobs ãŒè¨­å®šã•ã‚Œã‚‹

### ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³

- Cron Jobs ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ UTC æ™‚é–“ã§æŒ‡å®š
- `0 10 * * *`ã¯ UTC 10:00 = JST 19:00
- JST 10:00 ã«å®Ÿè¡Œã™ã‚‹ã«ã¯`0 1 * * *`ï¼ˆUTC 1:00ï¼‰ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹

**æ³¨æ„**: ç¾åœ¨ã®è¨­å®šï¼ˆ`0 10 * * *`ï¼‰ã¯ UTC 10:00 = JST 19:00 ã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚JST 10:00 ã«å®Ÿè¡Œã—ãŸã„å ´åˆã¯ã€`vercel.json`ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚

---

## 4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«

### auto_order_templates

| ã‚«ãƒ©ãƒ å      | ãƒ‡ãƒ¼ã‚¿å‹          | èª¬æ˜                                           |
| ------------- | ----------------- | ---------------------------------------------- |
| `id`          | `integer`         | ä¸»ã‚­ãƒ¼                                         |
| `user_id`     | `uuid`            | ãƒ¦ãƒ¼ã‚¶ãƒ¼ ID                                    |
| `menu_id`     | `integer`         | ãƒ¡ãƒ‹ãƒ¥ãƒ¼ IDï¼ˆ`menu_items.id`ã‚’å‚ç…§ï¼‰           |
| `quantity`    | `integer`         | æ•°é‡                                           |
| `day_of_week` | `integer \| null` | æ›œæ—¥ï¼ˆ0=æ—¥æ›œã€1=æœˆæ›œã€...ã€6=åœŸæ›œã€NULL=æ¯æ—¥ï¼‰ |
| `created_at`  | `timestamptz`     | ä½œæˆæ—¥æ™‚                                       |
| `updated_at`  | `timestamptz`     | æ›´æ–°æ—¥æ™‚                                       |

### auto_order_runs

| ã‚«ãƒ©ãƒ å      | ãƒ‡ãƒ¼ã‚¿å‹      | èª¬æ˜                                   |
| ------------- | ------------- | -------------------------------------- |
| `id`          | `bigint`      | ä¸»ã‚­ãƒ¼                                 |
| `run_date`    | `date`        | å®Ÿè¡Œæ—¥                                 |
| `executed_at` | `timestamptz` | å®Ÿè¡Œæ—¥æ™‚                               |
| `status`      | `text`        | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆ'running' \| 'completed'ï¼‰ |
| `log_details` | `jsonb`       | ãƒ­ã‚°è©³ç´°ï¼ˆJSON å½¢å¼ï¼‰                  |

### auto_order_run_items

| ã‚«ãƒ©ãƒ å      | ãƒ‡ãƒ¼ã‚¿å‹      | èª¬æ˜                                          |
| ------------- | ------------- | --------------------------------------------- |
| `id`          | `integer`     | ä¸»ã‚­ãƒ¼                                        |
| `run_id`      | `integer`     | å®Ÿè¡Œ IDï¼ˆ`auto_order_runs.id`ã‚’å‚ç…§ï¼‰         |
| `user_id`     | `uuid`        | ãƒ¦ãƒ¼ã‚¶ãƒ¼ ID                                   |
| `target_date` | `date`        | å¯¾è±¡æ—¥                                        |
| `result`      | `varchar`     | å®Ÿè¡Œçµæœï¼ˆ'created' \| 'skipped' \| 'error'ï¼‰ |
| `detail`      | `text`        | è©³ç´°æƒ…å ±                                      |
| `created_at`  | `timestamptz` | ä½œæˆæ—¥æ™‚                                      |

---

## 5. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®ã‚¨ãƒ©ãƒ¼å‡¦ç†

```typescript
for (const user of users) {
  try {
    // è‡ªå‹•æ³¨æ–‡å‡¦ç†
  } catch (error) {
    console.error(`Error processing user ${user.id}:`, error);
    results.push({
      user_id: user.id,
      result: "error",
      detail: error instanceof Error ? error.message : "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼",
    });
  }
}
```

- å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å‡¦ç†ã‚’ try-catch ã§å›²ã¿ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å½±éŸ¿ã—ãªã„
- ã‚¨ãƒ©ãƒ¼ã¯å®Ÿè¡Œå±¥æ­´ã«è¨˜éŒ²ã•ã‚Œã‚‹

### UNIQUE åˆ¶ç´„é•åã®å‡¦ç†

```typescript
if (orderError) {
  // UNIQUEåˆ¶ç´„é•åã®å ´åˆã¯æ—¢ã«æ³¨æ–‡ãŒã‚ã‚‹ï¼ˆãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ï¼‰
  if (orderError.code === "23505") {
    results.push({
      user_id: user.id,
      result: "skipped",
      detail: "æ—¢ã«æ³¨æ–‡ãŒã‚ã‚Šã¾ã™ï¼ˆãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ï¼‰",
    });
  }
}
```

- ãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ï¼ˆåŒæ™‚å®Ÿè¡Œï¼‰ã«ã‚ˆã‚‹é‡è¤‡ã‚’é˜²æ­¢
- UNIQUE åˆ¶ç´„é•åã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ã¨ã—ã¦è¨˜éŒ²

---

## 6. å‹•ä½œç¢ºèª

### æ‰‹å‹•å®Ÿè¡Œï¼ˆé–‹ç™ºç’°å¢ƒï¼‰

```bash
curl -X POST http://localhost:3000/api/auto-order/run \
  -H "Authorization: Bearer <AUTO_ORDER_SECRET>"
```

### å®Ÿè¡Œå±¥æ­´ã®ç¢ºèª

```sql
-- å®Ÿè¡Œå±¥æ­´ã‚’ç¢ºèª
SELECT * FROM auto_order_runs ORDER BY executed_at DESC LIMIT 10;

-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®å®Ÿè¡Œçµæœã‚’ç¢ºèª
SELECT
  aori.user_id,
  p.full_name,
  aori.target_date,
  aori.result,
  aori.detail
FROM auto_order_run_items aori
JOIN profiles p ON aori.user_id = p.id
WHERE aori.run_id = <run_id>
ORDER BY aori.user_id;
```

---

## 7. æ³¨æ„äº‹é …

### æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤æ™‚

1. **ç’°å¢ƒå¤‰æ•°ã®è¨­å®š**

   - `AUTO_ORDER_SECRET`ã‚’è¨­å®šï¼ˆ`docs/ç’°å¢ƒå¤‰æ•°è¨­å®šæ‰‹é †.md`ã‚’å‚ç…§ï¼‰
   - Vercel ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š

2. **Cron Jobs ã®ç¢ºèª**

   - Vercel ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ Cron Jobs ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
   - ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒæ­£ã—ã„ã‹ç¢ºèªï¼ˆJST 10:00 ã«å®Ÿè¡Œã™ã‚‹å ´åˆã¯`0 1 * * *`ï¼‰

3. **å‹•ä½œç¢ºèª**
   - è‡ªå‹•æ³¨æ–‡å®Ÿè¡Œå¾Œã€`auto_order_runs`ãƒ†ãƒ¼ãƒ–ãƒ«ã§å®Ÿè¡Œå±¥æ­´ã‚’ç¢ºèª
   - ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ãªã„ã‹ç¢ºèª

### ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã®æ³¨æ„

- Cron Jobs ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ UTC æ™‚é–“ã§æŒ‡å®š
- JST 10:00 ã«å®Ÿè¡Œã™ã‚‹ã«ã¯ã€UTC 1:00ï¼ˆ`0 1 * * *`ï¼‰ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹
- ç¾åœ¨ã®è¨­å®šï¼ˆ`0 10 * * *`ï¼‰ã¯ UTC 10:00 = JST 19:00 ã«å®Ÿè¡Œã•ã‚Œã‚‹

---

## 8. å‚è€ƒãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [CHANGELOG.md](./CHANGELOG.md) - å¤‰æ›´å±¥æ­´
- [PROGRESS.md](./PROGRESS.md) - é€²æ—çŠ¶æ³
- [SPEC.md](./SPEC.md) - ã‚·ã‚¹ãƒ†ãƒ ä»•æ§˜æ›¸
- [æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ.md](./æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ.md) - ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †
- [ç’°å¢ƒå¤‰æ•°è¨­å®šæ‰‹é †.md](./ç’°å¢ƒå¤‰æ•°è¨­å®šæ‰‹é †.md) - ç’°å¢ƒå¤‰æ•°ã®è¨­å®šæ–¹æ³•

---

æœ€çµ‚æ›´æ–°æ—¥: 2025-01-XX
