# カレンダーページ全日付グレーアウト問題修正

## 問題の概要

カレンダーページのHydration Mismatchエラー修正後、本番環境でカレンダーが正常に表示されるようになりましたが、すべての日付がグレーアウトしており、注文ボタンが表示されない問題が発生しました。注文可能日（16日まで）でも注文ボタンが表示されませんでした。

## 問題の詳細

### 症状

- 本番環境でカレンダーページが正常に表示される
- しかし、すべての日付がグレーアウトしている
- 注文可能日（16日まで）でも注文ボタンが表示されない
- コンソールログで以下の情報が確認される：
  - `hasOrderDay: false`
  - `isAvailable: false`
  - `canOrderToday: false`
  - `shouldBeGray: true`

### 原因

1. **`orderDaysMap`にデータが入っていない**
   - サーバー側で取得した`orderDays`データが`orderDaysMapObj`に正しくマッピングされていない
   - `orderDaysMapObj`のキー（`target_date`）が正しく設定されていない

2. **`target_date`のフォーマット不一致**
   - データベースから取得した`target_date`の形式が様々（Dateオブジェクト、タイムスタンプ付き文字列など）
   - カレンダーグリッドで使用する`YYYY-MM-DD`形式と一致していない
   - `orderDaysMapObj`の作成時に、`target_date`をそのままキーとして使用していたため、フォーマットが異なる場合にマッピングが失敗していた

3. **キーマッピングの失敗**
   - `orderDaysMapObj[day.target_date] = day`の形式で直接マッピングしていたが、`target_date`の形式が異なるため、カレンダーグリッドで`orderDaysMap[dateStr]`で検索しても見つからない

## 解決策

### 1. `target_date`のフォーマット正規化

`orderDaysMapObj`作成時に、`target_date`を`YYYY-MM-DD`形式に正規化する処理を追加しました。

```typescript
// 修正前
const orderDaysMapObj: Record<string, any> = {};
(orderDays || []).forEach((day: any) => {
  orderDaysMapObj[day.target_date] = day;
});

// 修正後
const orderDaysMapObj: Record<string, any> = {};
(orderDays || []).forEach((day: any) => {
  // target_dateがDateオブジェクトの場合は文字列に変換
  const dateKey = day.target_date instanceof Date 
    ? formatDateLocal(day.target_date)
    : typeof day.target_date === 'string'
    ? day.target_date.split('T')[0] // タイムスタンプ部分を削除
    : String(day.target_date).split('T')[0];
  orderDaysMapObj[dateKey] = day;
});
```

### 2. デバッグログの追加

サーバー側のデータ取得状況を確認するログを追加しました。

- 日付範囲の計算結果をログ出力
- `orderDays`の取得数とサンプルデータをログ出力
- `orderDaysMapObj`の作成結果とキー形式をログ出力

## 修正ファイル

- `app/(user)/calendar/page.tsx`:
  - `orderDaysMapObj`作成時の`target_date`フォーマット正規化処理を追加
  - サーバー側データ取得のデバッグログを追加
  - 日付範囲計算のログを追加

## 確認事項

- ✅ 本番環境でカレンダーページが正常に表示される
- ✅ 注文可能日に注文ボタンが表示される
- ✅ `orderDaysMap`にデータが正しく入る
- ✅ `target_date`のフォーマットが`YYYY-MM-DD`形式で統一される

## 注意事項

### 日付フォーマットの統一

データベースから取得した日付データは、形式が異なる可能性があるため、使用前に`YYYY-MM-DD`形式に正規化する必要があります。

- Dateオブジェクトの場合: `formatDateLocal()`関数を使用
- 文字列の場合: `split('T')[0]`でタイムスタンプ部分を削除
- その他の場合: 文字列に変換してから処理

### キーマッピングの重要性

マップ型のデータ構造を使用する場合、キーの形式が一致していることが重要です。フォーマット不一致は、データが正しく取得できない原因になります。

- マップのキーと値の検索キーは同じ形式である必要がある
- 日付データは使用前に必ず正規化する

## 関連ドキュメント

- [CHANGELOG.md](./CHANGELOG.md) - 変更履歴
- [カレンダーページHydration Mismatchエラー修正.md](./カレンダーページHydration Mismatchエラー修正.md) - 前回のHydration Mismatchエラー修正
- [カレンダーページMap型シリアライズ問題の解決.md](./カレンダーページMap型シリアライズ問題の解決.md) - Map型シリアライズ問題の解決
