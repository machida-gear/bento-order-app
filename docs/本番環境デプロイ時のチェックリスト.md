# 本番環境デプロイ時のチェックリスト

本番環境にデプロイする際に確認・設定すべき項目をまとめています。

---

## ✅ デプロイ前の確認事項

### 1. データベースの準備

- [ ] Supabase の本番環境が正しく設定されているか
- [ ] すべてのマイグレーションファイルが適用されているか
- [ ] RLS ポリシーが正しく設定されているか
- [ ] テストデータが削除されているか（本番環境の場合）

### 2. 環境変数の設定

- [ ] `NEXT_PUBLIC_SUPABASE_URL` が設定されているか
- [ ] `NEXT_PUBLIC_SUPABASE_ANON_KEY` が設定されているか
- [ ] `SUPABASE_SERVICE_ROLE_KEY` が設定されているか
- [ ] `AUTO_ORDER_SECRET` が設定されているか（自動注文機能を使用する場合）

### 3. 自動注文機能の設定

- [ ] `vercel.json` がプロジェクトに含まれているか
- [ ] Cron Jobs のスケジュールが正しいか（現在: 毎日 10:00 JST）
- [ ] 自動注文実行 API が正しく実装されているか

### 4. PDF 生成機能の設定

- [ ] `node_modules/pdfkit/js/data/`にフォントファイル（`.afm`）が存在することを確認
- [ ] 特に`Helvetica.afm`が存在することを確認
- [ ] 日本語フォント（IPAex フォントまたは IPA フォント）を`public/fonts/`フォルダに配置
- [ ] フォントファイルのダウンロード手順は`docs/PDFフォント設定手順.md`を参照
- [ ] 会社情報をシステム設定画面から設定（推奨）
- [ ] 環境変数（`PDF_SENDER_*`）を設定（フォールバック、オプション）

**詳細は `docs/本番環境PDF生成エラー対策チェックリスト.md` を参照してください。**

---

## 🚀 デプロイ手順

### 1. Vercel へのデプロイ

1. GitHub リポジトリにコードをプッシュ
2. Vercel ダッシュボードでプロジェクトを選択
3. 「Deployments」タブから最新のコミットをデプロイ

### 2. 環境変数の設定

詳細は `docs/環境変数設定手順.md` を参照してください。

**必須の環境変数:**

- `NEXT_PUBLIC_SUPABASE_URL`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- `SUPABASE_SERVICE_ROLE_KEY`
- `AUTO_ORDER_SECRET`（自動注文機能を使用する場合）

**設定場所:**

- Vercel ダッシュボード → プロジェクト → Settings → Environment Variables

### 3. Cron Jobs の確認

`vercel.json` が正しく設定されていれば、Vercel が自動的に Cron Jobs を設定します。

**確認方法:**

- Vercel ダッシュボード → プロジェクト → Settings → Cron Jobs
- 以下の Cron Job が表示されていることを確認:
  - Path: `/api/auto-order/run`
  - Schedule: `0 10 * * *` (毎日 10:00 JST)

---

## 🔍 デプロイ後の確認事項

### 1. 動作確認

- [ ] アプリが正常に起動するか
- [ ] ログイン・新規登録が動作するか
- [ ] カレンダー画面が表示されるか
- [ ] 注文機能が動作するか
- [ ] 自動注文設定画面が表示されるか

### 2. 自動注文機能の確認

- [ ] 自動注文実行 API が手動で呼び出せるか（テスト用）
- [ ] Cron Jobs が正しくスケジュールされているか
- [ ] 実行履歴が `auto_order_runs` テーブルに記録されるか

### 3. PDF 生成機能の確認

- [ ] PDF 生成 API（`/api/admin/orders/today/pdf?date=YYYY-MM-DD&vendor_id=XXX`）が正常に動作するか
- [ ] PDF ファイルが正しく生成されるか
- [ ] PDF の内容が正しく表示されるか（日本語が文字化けしていないか）
- [ ] 会社情報が正しく表示されるか
- [ ] エラーログにフォントファイル関連のエラーがないか

**詳細は `docs/本番環境PDF生成エラー対策チェックリスト.md` を参照してください。**

### 4. セキュリティ確認

- [ ] 環境変数が正しく設定されているか
- [ ] `SUPABASE_SERVICE_ROLE_KEY` がクライアントに公開されていないか
- [ ] `AUTO_ORDER_SECRET` が正しく設定されているか

---

## 📝 本番環境デプロイ時の追加手順

本番環境にデプロイする際は、以下の手順を実行してください：

1. **環境変数の設定**

   - `docs/環境変数設定手順.md` を参照して環境変数を設定

2. **Cron Jobs の確認**

   - Vercel ダッシュボードで Cron Jobs が正しく設定されているか確認

3. **動作テスト**

   - 自動注文実行 API を手動で呼び出してテスト
   - 実行履歴を確認

4. **監視設定**
   - Vercel のログを確認して、エラーが発生していないか確認
   - 自動注文の実行履歴を定期的に確認

---

## 🆘 トラブルシューティング

### Cron Jobs が動作しない場合

- Vercel ダッシュボードで Cron Jobs が正しく設定されているか確認
- `vercel.json` が正しく配置されているか確認
- デプロイログにエラーがないか確認

### 自動注文が実行されない場合

- `auto_order_runs` テーブルに実行履歴が記録されているか確認
- エラーログを確認
- 環境変数が正しく設定されているか確認

### 認証エラーが発生する場合

- `AUTO_ORDER_SECRET` が正しく設定されているか確認
- 環境変数が正しい環境（Production）に設定されているか確認

---

## 📚 参考ドキュメント

- `docs/環境変数設定手順.md` - 環境変数の詳細な設定手順
- `docs/SPEC.md` - システム仕様書
- `docs/DECISIONS.md` - 設計上の重要な判断

---

**注意:** 本番環境にデプロイする前に、必ずステージング環境で十分にテストしてください。
