# データベース構造の注意事項

このドキュメントでは、実際のデータベース構造と初期スキーマ（`001_initial_schema.sql`）の違いを記録します。

**詳細なスキーマ定義については、[実際のデータベーススキーマ.md](./実際のデータベーススキーマ.md) を参照してください。**

---

## テーブル名の違い

| 初期スキーマ          | 実際のテーブル名     | 備考                 |
| --------------------- | -------------------- | -------------------- |
| `users_profile`       | `profiles`           | ユーザープロフィール |
| `menus`               | `menu_items`         | メニューマスタ       |
| `order_days`          | `order_calendar`     | 注文可能日カレンダー |
| `operation_logs`      | `audit_logs`         | 操作ログ             |
| `auto_order_settings` | `auto_order_configs` | 自動注文設定         |

---

## カラム名の違い

### `profiles`テーブル

| 初期スキーマ | 実際のカラム名 | 備考 |
| ------------ | -------------- | ---- |
| `name`       | `full_name`    | 氏名 |

### `order_calendar`テーブル

| 初期スキーマ   | 実際のカラム名  | 備考             |
| -------------- | --------------- | ---------------- |
| `date`         | `target_date`   | 日付             |
| `special_note` | `note`          | 備考             |
| -              | `deadline_time` | 締切時刻（追加） |

### `menu_prices`テーブル

| 初期スキーマ | 実際のカラム名 | 備考                    |
| ------------ | -------------- | ----------------------- |
| `menu_id`    | `menu_item_id` | メニュー ID（外部キー） |

**重要**: `menu_prices`テーブルでは、`menu_id`ではなく`menu_item_id`を使用します。

---

## データ型の違い

### ID カラム

初期スキーマでは`SERIAL`（整数）を想定していましたが、実際のデータベースでは`UUID`型が使用されています。

| テーブル      | ID カラムの型 |
| ------------- | ------------- |
| `vendors`     | `UUID`        |
| `menu_items`  | `UUID`        |
| `menu_prices` | `UUID`        |
| `orders`      | `UUID`        |
| `profiles`    | `UUID`        |

---

## SQL クエリを書く際の注意事項

### 1. テーブル名の使用

```sql
-- ❌ 間違い
SELECT * FROM menus;

-- ✅ 正しい
SELECT * FROM menu_items;
```

### 2. カラム名の使用

```sql
-- ❌ 間違い
SELECT mp.menu_id FROM menu_prices mp;

-- ✅ 正しい
SELECT mp.menu_item_id FROM menu_prices mp;
```

### 3. JOIN 句での使用

```sql
-- ❌ 間違い
JOIN menu_prices mp ON mp.menu_id = m.id

-- ✅ 正しい
JOIN menu_prices mp ON mp.menu_item_id = m.id
```

### 4. INSERT 文での使用

```sql
-- ❌ 間違い
INSERT INTO menu_prices (menu_id, price, start_date) VALUES (...);

-- ✅ 正しい
INSERT INTO menu_prices (menu_item_id, price, start_date) VALUES (...);
```

---

## テストデータ投入時の注意事項

### `027_insert_current_date_test_data.sql`の使用

この SQL ファイルは、既存のメニュー名に基づいて価格を設定します。

**既存のメニュー名が異なる場合：**

1. `030_check_existing_menu_items.sql`を実行して既存のメニュー名を確認
2. `027_insert_current_date_test_data.sql`の`CASE`文を実際のメニュー名に合わせて修正

**例：**

```sql
-- 既存のメニュー名が「のり弁当」「日替わりハンバー」「特製唐揚げ弁当」の場合
CASE m.name
    WHEN 'のり弁当' THEN 650
    WHEN '日替わりハンバー' THEN 750
    WHEN '特製唐揚げ弁当' THEN 600
    -- ... 他のメニュー名
    ELSE 500  -- デフォルト価格
END
```

---

## マイグレーションファイルの命名規則

実際のデータベース構造に合わせた修正を含むマイグレーションファイル：

- `026_check_order_test_data.sql`: データベース状態確認用（`menu_item_id`を使用）
- `027_insert_current_date_test_data.sql`: テストデータ投入用（`menu_item_id`を使用、`NOT EXISTS`で重複チェック）
- `028_check_table_structure.sql`: テーブル構造確認用
- `029_check_unique_constraints.sql`: UNIQUE 制約確認用
- `030_check_existing_menu_items.sql`: 既存メニュー確認用

---

## まとめ

- テーブル名とカラム名は、初期スキーマと実際のデータベースで異なる場合がある
- SQL クエリを書く際は、実際のテーブル構造を確認してから記述する
- テストデータ投入時は、既存のデータ構造を確認してから実行する
- `menu_prices`テーブルでは`menu_item_id`を使用する（`menu_id`ではない）
